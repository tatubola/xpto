<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ixbr_api.core.views.form_views &#8212; IX.br API 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">IX.br API 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ixbr_api.core.views.form_views</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">ixbr_api.core.use_cases.create_dio_ports_use_case</span> <span class="k">as</span> <span class="nn">create_dio_ports_use_case</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="k">import</span> <span class="n">messages</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.mixins</span> <span class="k">import</span> <span class="n">LoginRequiredMixin</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="k">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">transaction</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="k">import</span> <span class="n">Q</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="k">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">JsonResponse</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="k">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.template.loader</span> <span class="k">import</span> <span class="n">render_to_string</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="k">import</span> <span class="n">View</span>
<span class="kn">from</span> <span class="nn">django.views.generic.edit</span> <span class="k">import</span> <span class="n">FormView</span>
<span class="kn">from</span> <span class="nn">ipaddress</span> <span class="k">import</span> <span class="n">ip_address</span><span class="p">,</span> <span class="n">ip_network</span>

<span class="kn">from</span> <span class="nn">..forms</span> <span class="k">import</span> <span class="p">(</span><span class="n">AddASContactForm</span><span class="p">,</span> <span class="n">AddBilateralForm</span><span class="p">,</span>
                     <span class="n">AddBilateralNewChannelForm</span><span class="p">,</span> <span class="n">AddContactForm</span><span class="p">,</span>
                     <span class="n">AddCustomerChannelForm</span><span class="p">,</span> <span class="n">AddDIOToPIXForm</span><span class="p">,</span> <span class="n">AddIXtoASNForm</span><span class="p">,</span>
                     <span class="n">AddMACServiceForm</span><span class="p">,</span> <span class="n">AddPortChannel</span><span class="p">,</span> <span class="n">AddSwitchModuleForm</span><span class="p">,</span>
                     <span class="n">CreatePortPhysicalInterfaceForm</span><span class="p">,</span> <span class="n">CreateSwitchForm</span><span class="p">,</span>
                     <span class="n">EditCixTypeForm</span><span class="p">,</span> <span class="n">EditConfiguredCapacityPort</span><span class="p">,</span>
                     <span class="n">EditContactForm</span><span class="p">,</span> <span class="n">EditContactsMapForm</span><span class="p">,</span> <span class="n">EditDescriptionForm</span><span class="p">,</span>
                     <span class="n">EditDioPortForm</span><span class="p">,</span> <span class="n">EditMLPAv4Form</span><span class="p">,</span> <span class="n">EditMLPAv6Form</span><span class="p">,</span>
                     <span class="n">EditOrganizationForm</span><span class="p">,</span> <span class="n">EditPortPhysicalInterfaceForm</span><span class="p">,</span>
                     <span class="n">EditServicePrefixLimitForm</span><span class="p">,</span> <span class="n">EditServiceStatusForm</span><span class="p">,</span>
                     <span class="n">EditServiceTagForm</span><span class="p">,</span> <span class="n">GenericMLPANewChannelForm</span><span class="p">,</span>
                     <span class="n">GenericMLPAUsedChannelForm</span><span class="p">,</span> <span class="n">MigrateSwitchForm</span><span class="p">,</span> <span class="n">PhoneForm</span><span class="p">,</span>
                     <span class="n">ReleaseIPResourceForm</span><span class="p">,</span> <span class="n">ReleasePortResourceForm</span><span class="p">,</span>
                     <span class="n">ReleaseTagResourceForm</span><span class="p">,</span> <span class="n">ReserveIPResourceForm</span><span class="p">,</span>
                     <span class="n">ReservePortResourceForm</span><span class="p">,</span> <span class="n">ReserveTagResourceForm</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">..models</span> <span class="k">import</span> <span class="p">(</span><span class="n">ASN</span><span class="p">,</span> <span class="n">DIO</span><span class="p">,</span> <span class="n">IX</span><span class="p">,</span> <span class="n">PIX</span><span class="p">,</span> <span class="n">Bilateral</span><span class="p">,</span> <span class="n">BilateralPeer</span><span class="p">,</span> <span class="n">ChannelPort</span><span class="p">,</span>
                      <span class="n">Contact</span><span class="p">,</span> <span class="n">ContactsMap</span><span class="p">,</span> <span class="n">CustomerChannel</span><span class="p">,</span> <span class="n">DIOPort</span><span class="p">,</span>
                      <span class="n">IPv4Address</span><span class="p">,</span> <span class="n">IPv6Address</span><span class="p">,</span> <span class="n">MACAddress</span><span class="p">,</span> <span class="n">MLPAv4</span><span class="p">,</span> <span class="n">MLPAv6</span><span class="p">,</span>
                      <span class="n">Monitorv4</span><span class="p">,</span> <span class="n">Organization</span><span class="p">,</span> <span class="n">Phone</span><span class="p">,</span> <span class="n">PhysicalInterface</span><span class="p">,</span> <span class="n">Port</span><span class="p">,</span>
                      <span class="n">Switch</span><span class="p">,</span> <span class="n">SwitchModel</span><span class="p">,</span> <span class="n">SwitchPortRange</span><span class="p">,</span> <span class="n">Tag</span><span class="p">,</span>
                      <span class="n">create_tag_by_channel_port</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">..use_cases.bilateral_use_case</span> <span class="k">import</span> <span class="p">(</span><span class="n">create_bilateral</span><span class="p">,</span>
                                            <span class="n">define_bilateral_case</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">..use_cases.migrate_switch</span> <span class="k">import</span> <span class="n">migrate_switch</span>
<span class="kn">from</span> <span class="nn">..use_cases.switch_module_use_cases</span> <span class="k">import</span> \
    <span class="n">create_port_range_switch_module_use_case</span>
<span class="kn">from</span> <span class="nn">..use_cases.tags_use_cases</span> <span class="k">import</span> <span class="p">(</span><span class="n">get_free_tags</span><span class="p">,</span>
                                        <span class="n">get_tag_without_all_service</span><span class="p">,</span>
                                        <span class="n">get_tag_without_bilateral</span><span class="p">,</span>
                                        <span class="n">instantiate_tag</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="k">import</span> <span class="n">port_utils</span>
<span class="kn">from</span> <span class="nn">..utils.consulta</span> <span class="k">import</span> <span class="n">MAC</span>
<span class="kn">from</span> <span class="nn">..utils.last_ticket_update</span> <span class="k">import</span> <span class="n">updatelastticket</span>
<span class="kn">from</span> <span class="nn">..utils.logger</span> <span class="k">import</span> <span class="n">ixapilog</span>
<span class="kn">from</span> <span class="nn">..utils.mixins</span> <span class="k">import</span> <span class="n">AjaxableResponseMixin</span><span class="p">,</span> <span class="n">LogsMixin</span>
<span class="kn">from</span> <span class="nn">..validators</span> <span class="k">import</span> <span class="n">validate_cnpj</span>


<div class="viewcode-block" id="AddASContactFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.AddASContactFormView">[docs]</a><span class="k">class</span> <span class="nc">AddASContactFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a new AS instance in the system.</span>

<span class="sd">     In order to add a new AS, several data is required (i.e. contacts,</span>
<span class="sd">     IX and organization). These data are collected from the ticket system</span>
<span class="sd">     and used create the new AS instance.</span>
<span class="sd">     This class is used by:</span>
<span class="sd">      - ixbr_api/core/urls.py (directly)</span>
<span class="sd">      - ixbr_api/templates/as/as_add.html (as url)</span>
<span class="sd">      - ix-api/ixbr_api/templates/forms/add_as_contact_form.html (as url)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/add_as_contact_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">AddASContactForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">asn</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;asn&#39;</span><span class="p">:</span> <span class="n">asn</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;asn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asn</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__add_contact</span><span class="p">(</span><span class="n">contact_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a contact instance to be used in Contactsmap.</span>

<span class="sd">        Args:</span>
<span class="sd">            contact_dict: the contact dict with contact data</span>

<span class="sd">        Returns: a contact object to be used in a Contactsmap instance.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cur_contact</span> <span class="o">=</span> <span class="n">Contact</span><span class="p">()</span>
        <span class="n">cur_contact</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">contact_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">cur_contact</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">contact_dict</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
        <span class="n">cur_contact</span><span class="o">.</span><span class="n">last_ticket</span> <span class="o">=</span> <span class="n">contact_dict</span><span class="p">[</span><span class="s1">&#39;ticket&#39;</span><span class="p">]</span>
        <span class="n">cur_contact</span><span class="o">.</span><span class="n">modified_by_id</span> <span class="o">=</span> <span class="n">contact_dict</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>
        <span class="n">cur_contact</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">contact_dict</span><span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cur_phone</span> <span class="o">=</span> <span class="n">Phone</span><span class="p">()</span>
            <span class="n">cur_phone</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">contact_dict</span><span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span>
            <span class="n">cur_phone</span><span class="o">.</span><span class="n">last_ticket</span> <span class="o">=</span> <span class="n">contact_dict</span><span class="p">[</span><span class="s1">&#39;ticket&#39;</span><span class="p">]</span>
            <span class="n">cur_phone</span><span class="o">.</span><span class="n">contact</span> <span class="o">=</span> <span class="n">cur_contact</span>
            <span class="n">cur_phone</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">cur_contact</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">form_data</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span>
        <span class="n">cur_ticket</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form_data</span><span class="p">[</span><span class="s1">&#39;ticket&#39;</span><span class="p">])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>

                <span class="c1"># Get the IX</span>
                <span class="n">cur_ix</span> <span class="o">=</span> <span class="n">form_data</span><span class="p">[</span><span class="s1">&#39;ix&#39;</span><span class="p">]</span>

                <span class="c1"># Organization Info</span>
                <span class="n">cur_organization</span> <span class="o">=</span> <span class="n">Organization</span><span class="p">()</span>
                <span class="n">cur_organization</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">form_data</span><span class="p">[</span><span class="s1">&#39;org_name&#39;</span><span class="p">]</span>
                <span class="n">cur_organization</span><span class="o">.</span><span class="n">shortname</span> <span class="o">=</span> <span class="n">form_data</span><span class="p">[</span><span class="s1">&#39;org_shortname&#39;</span><span class="p">]</span>
                <span class="n">cur_organization</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">form_data</span><span class="p">[</span><span class="s1">&#39;org_url&#39;</span><span class="p">]</span>
                <span class="n">cur_organization</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">form_data</span><span class="p">[</span><span class="s1">&#39;org_addr&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">form_data</span><span class="p">[</span><span class="s1">&#39;org_cnpj&#39;</span><span class="p">]:</span>
                    <span class="n">validate_cnpj</span><span class="p">(</span><span class="n">form_data</span><span class="p">[</span><span class="s1">&#39;org_cnpj&#39;</span><span class="p">])</span>
                    <span class="n">cur_organization</span><span class="o">.</span><span class="n">cnpj</span> <span class="o">=</span> <span class="n">form_data</span><span class="p">[</span><span class="s1">&#39;org_cnpj&#39;</span><span class="p">]</span>
                <span class="n">cur_organization</span><span class="o">.</span><span class="n">last_ticket</span> <span class="o">=</span> <span class="n">cur_ticket</span>
                <span class="n">cur_organization</span><span class="o">.</span><span class="n">modified_by_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
                <span class="n">cur_organization</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="c1"># Administrative Contact</span>
                <span class="n">contact_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">form_data</span><span class="p">[</span><span class="s1">&#39;contact_name_adm&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">form_data</span><span class="p">[</span><span class="s1">&#39;contact_email_adm&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;phone&#39;</span><span class="p">:</span> <span class="n">form_data</span><span class="p">[</span><span class="s1">&#39;contact_phone_adm&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;ticket&#39;</span><span class="p">:</span> <span class="n">cur_ticket</span><span class="p">,</span>
                    <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
                <span class="p">}</span>
                <span class="n">cur_adm_contact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__add_contact</span><span class="p">(</span><span class="n">contact_dict</span><span class="p">)</span>

                <span class="c1"># NOC Contact</span>
                <span class="n">contact_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form_data</span><span class="p">[</span><span class="s1">&#39;contact_name_noc&#39;</span><span class="p">]</span>
                <span class="n">contact_dict</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form_data</span><span class="p">[</span><span class="s1">&#39;contact_email_noc&#39;</span><span class="p">]</span>
                <span class="n">cur_noc_contact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__add_contact</span><span class="p">(</span><span class="n">contact_dict</span><span class="p">)</span>

                <span class="c1"># Commercial Contact</span>
                <span class="n">contact_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form_data</span><span class="p">[</span><span class="s1">&#39;contact_name_com&#39;</span><span class="p">]</span>
                <span class="n">contact_dict</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form_data</span><span class="p">[</span><span class="s1">&#39;contact_email_com&#39;</span><span class="p">]</span>
                <span class="n">cur_com_contact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__add_contact</span><span class="p">(</span><span class="n">contact_dict</span><span class="p">)</span>

                <span class="c1"># Peer Contact</span>
                <span class="n">contact_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form_data</span><span class="p">[</span><span class="s1">&#39;contact_name_peer&#39;</span><span class="p">]</span>
                <span class="n">contact_dict</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form_data</span><span class="p">[</span><span class="s1">&#39;contact_email_peer&#39;</span><span class="p">]</span>
                <span class="n">cur_peer_contact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__add_contact</span><span class="p">(</span><span class="n">contact_dict</span><span class="p">)</span>

                <span class="c1"># Organization Contact</span>
                <span class="n">contact_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form_data</span><span class="p">[</span><span class="s1">&#39;contact_name_org&#39;</span><span class="p">]</span>
                <span class="n">contact_dict</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form_data</span><span class="p">[</span><span class="s1">&#39;contact_email_org&#39;</span><span class="p">]</span>
                <span class="n">cur_org_contact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__add_contact</span><span class="p">(</span><span class="n">contact_dict</span><span class="p">)</span>

                <span class="c1"># ASN</span>
                <span class="n">cur_asn</span> <span class="o">=</span> <span class="n">ASN</span><span class="p">()</span>
                <span class="n">cur_asn</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">form_data</span><span class="p">[</span><span class="s1">&#39;asn&#39;</span><span class="p">]</span>
                <span class="n">cur_asn</span><span class="o">.</span><span class="n">modified_by_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
                <span class="n">cur_asn</span><span class="o">.</span><span class="n">last_ticket</span> <span class="o">=</span> <span class="n">cur_ticket</span>
                <span class="n">cur_asn</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="c1"># Contact Map</span>
                <span class="n">cur_contactsmap</span> <span class="o">=</span> <span class="n">ContactsMap</span><span class="p">()</span>
                <span class="n">cur_contactsmap</span><span class="o">.</span><span class="n">organization</span> <span class="o">=</span> <span class="n">cur_organization</span>
                <span class="n">cur_contactsmap</span><span class="o">.</span><span class="n">ix</span> <span class="o">=</span> <span class="n">cur_ix</span>
                <span class="n">cur_contactsmap</span><span class="o">.</span><span class="n">asn</span> <span class="o">=</span> <span class="n">cur_asn</span>
                <span class="n">cur_contactsmap</span><span class="o">.</span><span class="n">noc_contact</span> <span class="o">=</span> <span class="n">cur_noc_contact</span>
                <span class="n">cur_contactsmap</span><span class="o">.</span><span class="n">adm_contact</span> <span class="o">=</span> <span class="n">cur_adm_contact</span>
                <span class="n">cur_contactsmap</span><span class="o">.</span><span class="n">org_contact</span> <span class="o">=</span> <span class="n">cur_org_contact</span>
                <span class="n">cur_contactsmap</span><span class="o">.</span><span class="n">peer_contact</span> <span class="o">=</span> <span class="n">cur_peer_contact</span>
                <span class="n">cur_contactsmap</span><span class="o">.</span><span class="n">com_contact</span> <span class="o">=</span> <span class="n">cur_com_contact</span>
                <span class="n">cur_contactsmap</span><span class="o">.</span><span class="n">modified_by_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
                <span class="n">cur_contactsmap</span><span class="o">.</span><span class="n">last_ticket</span> <span class="o">=</span> <span class="n">cur_ticket</span>
                <span class="c1"># FIXME</span>
                <span class="n">cur_contactsmap</span><span class="o">.</span><span class="n">peering_url</span> <span class="o">=</span> <span class="s2">&quot;http://abc.com&quot;</span>
                <span class="n">cur_contactsmap</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;AS Registered&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">form_invalid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="MACDeleteView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.MACDeleteView">[docs]</a><span class="k">class</span> <span class="nc">MACDeleteView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Delete a MAC</span>
<span class="sd">    Attributes:</span>
<span class="sd">        mac (str): MAC Address.</span>
<span class="sd">        service (str): UUID of service.</span>
<span class="sd">        ma (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get a MAC speciefied.</span>
<span class="sd">        data (dic): Dictionary that return the result</span>
<span class="sd">            to be printed.</span>
<span class="sd">    returns:</span>
<span class="sd">        If the mac was deleted successfully, will return a dictionary how:</span>

<span class="sd">        {</span>
<span class="sd">        &#39;result&#39; : &#39;Your Mac was deleted successfully&#39;</span>
<span class="sd">        }</span>

<span class="sd">        Else, will return a dictionary how:</span>

<span class="sd">        {</span>
<span class="sd">        &#39;result&#39; : &#39;error&#39;</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">mac</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mac&quot;</span><span class="p">)</span>
        <span class="n">service</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;service&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">ma</span> <span class="o">=</span> <span class="n">MACAddress</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_none</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">mac</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ma</span><span class="p">:</span>
                    <span class="n">ma</span><span class="o">.</span><span class="n">mlpav4_set</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">pk</span><span class="o">=</span><span class="n">service</span><span class="p">))</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;Your Mac was deleted successfully&#39;</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">MLPAv4</span><span class="o">.</span><span class="n">DoesNotExist</span>
        <span class="k">except</span> <span class="n">MLPAv4</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                    <span class="n">ma</span> <span class="o">=</span> <span class="n">MACAddress</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_none</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">mac</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ma</span><span class="p">:</span>
                        <span class="n">ma</span><span class="o">.</span><span class="n">mlpav6_set</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="n">pk</span><span class="o">=</span><span class="n">service</span><span class="p">))</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;Your Mac was deleted successfully&#39;</span><span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">MLPAv6</span><span class="o">.</span><span class="n">DoesNotExist</span>
            <span class="k">except</span> <span class="n">MLPAv6</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="EditMLPAv4FormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.EditMLPAv4FormView">[docs]</a><span class="k">class</span> <span class="nc">EditMLPAv4FormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This class has, as main objective, to change the IPv4 address of an</span>
<span class="sd">       MLPAv4 service</span>

<span class="sd">    Attributes:</span>
<span class="sd">        context (dic): It is a dictionary of information to be printed on the</span>
<span class="sd">            screen</span>
<span class="sd">        form_class (Instance of forms.EditMLPAv4Form): Instance of the</span>
<span class="sd">            EditMLPAv4Form class, this class contains all form information</span>
<span class="sd">        http_method_names (list): List containing the request types</span>
<span class="sd">        initial (dict): Boot Dictionary, if you need to start a field with a</span>
<span class="sd">            value</span>
<span class="sd">        template_name (str): Name of the template used for this form</span>
<span class="sd">        mlpav4 (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get a MLPAv4 by</span>
<span class="sd">            the primary key passed by parameter</span>
<span class="sd">    Returns:</span>
<span class="sd">        If the IPv4 address was changed successfully, it will return a</span>
<span class="sd">            successful message, else it will return a</span>
<span class="sd">        message with the error that occurred</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/edit_mlpav4_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">EditMLPAv4Form</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">used_v4_addresses</span> <span class="o">=</span> <span class="n">IPv4Address</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Q</span><span class="p">(</span><span class="n">address__in</span><span class="o">=</span><span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span>
                <span class="s1">&#39;mlpav4_address&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="o">|</span>
            <span class="n">Q</span><span class="p">(</span><span class="n">address__in</span><span class="o">=</span><span class="n">Monitorv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span>
                <span class="s1">&#39;monitor_address&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span> <span class="n">ix</span><span class="o">=</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
        <span class="n">V4_QUERY</span> <span class="o">=</span> <span class="n">IPv4Address</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
            <span class="n">pk__in</span><span class="o">=</span><span class="n">used_v4_addresses</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;mlpav4_address&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">V4_QUERY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;service&#39;</span><span class="p">:</span> <span class="n">service</span><span class="p">,</span>
            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">code</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>

                <span class="n">mlpav4</span> <span class="o">=</span> <span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;service&#39;</span><span class="p">])</span>
                <span class="n">mlpav4_address</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;mlpav4_address&#39;</span><span class="p">]</span>
                <span class="n">mlpav4</span><span class="o">.</span><span class="n">mlpav4_address</span> <span class="o">=</span> <span class="n">mlpav4_address</span>
                <span class="n">mlpav4</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;MLPAv4 saved&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="EditMLPAv6FormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.EditMLPAv6FormView">[docs]</a><span class="k">class</span> <span class="nc">EditMLPAv6FormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class has, as main objective, to change the IPv6 address of an</span>
<span class="sd">        MLPAv6 service</span>

<span class="sd">    Attributes:</span>
<span class="sd">        context (dic): It is a dictionary of information to be printed on the</span>
<span class="sd">            screen</span>
<span class="sd">        form_class (Instance of forms.EditMLPAv6Form): Instance of the</span>
<span class="sd">            EditMLPAv6Form class, this class contains all form information</span>
<span class="sd">        http_method_names (list): List containing the request types</span>
<span class="sd">        initial (dict): Boot Dictionary, if you need to start a field with a</span>
<span class="sd">            value</span>
<span class="sd">        template_name (str): Name of the template used for this form</span>
<span class="sd">        mlpav6 (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get a MLPAv6 by</span>
<span class="sd">            the primary key passed by parameter</span>
<span class="sd">    Returns:</span>
<span class="sd">        If the IPv6 address was changed successfully, it will return a</span>
<span class="sd">            successful message, else it will return a message with the error</span>
<span class="sd">            that occurred</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/edit_mlpav6_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">EditMLPAv6Form</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">used_v6_addresses</span> <span class="o">=</span> <span class="n">IPv6Address</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Q</span><span class="p">(</span><span class="n">address__in</span><span class="o">=</span><span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span>
                <span class="s1">&#39;mlpav6_address&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
        <span class="n">V6_QUERY</span> <span class="o">=</span> <span class="n">IPv6Address</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
            <span class="n">pk__in</span><span class="o">=</span><span class="n">used_v6_addresses</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;mlpav6_address&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">V6_QUERY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;service&#39;</span><span class="p">:</span> <span class="n">service</span><span class="p">,</span>
            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">code</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">mlpav6_address</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;mlpav6_address&#39;</span><span class="p">]</span>

                <span class="n">mlpav6</span> <span class="o">=</span> <span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;service&#39;</span><span class="p">])</span>
                <span class="n">mlpav6</span><span class="o">.</span><span class="n">mlpav6_address</span> <span class="o">=</span> <span class="n">mlpav6_address</span>
                <span class="n">mlpav6</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;MLPAv6 saved&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="AddMACServiceFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.AddMACServiceFormView">[docs]</a><span class="k">class</span> <span class="nc">AddMACServiceFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;To add a mac to a service</span>

<span class="sd">    Attributes:</span>
<span class="sd">        form_class (&lt;class &#39;ixbr_api.core.forms.AddMACServiceForm&#39;&gt;):</span>
<span class="sd">        Class that contains the form to add a mac to a service.</span>
<span class="sd">        http_method_names (list): Requisition methods</span>
<span class="sd">        context (dic): Dictionary that return a set of informations</span>
<span class="sd">            to be printed.</span>
<span class="sd">        address (str): Get the Mac Address.</span>
<span class="sd">        last_ticket (int): Get the last_ticket.</span>
<span class="sd">        description (str): Get the description of a MAC Address.</span>
<span class="sd">        template_name (str): forms/add_mac_service_form.html</span>
<span class="sd">    returns:</span>
<span class="sd">        If the request method is a get, will return a dict context with</span>
<span class="sd">        the fields of form. If method requisition is different of get,</span>
<span class="sd">        return success message case the mac was successfully added or</span>
<span class="sd">        error message case mac was not added</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/add_mac_service_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">AddMACServiceForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">service</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">(),</span>
            <span class="s1">&#39;service&#39;</span><span class="p">:</span> <span class="n">service</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@updatelastticket</span>
    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">]</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
        <span class="n">last_ticket</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;last_ticket&#39;</span><span class="p">]</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">service_mac</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="sd">&#39;&#39;&#39; Validation if accept uppercase letters</span>
<span class="sd">        PS: Change core.validator.py regex</span>
<span class="sd">        ADDRESS_REGEX = re.compile(Regex().mac.upper())</span>
<span class="sd">        if ADDRESS_REGEX.match(address):</span>
<span class="sd">            address = address.lower()&#39;&#39;&#39;</span>

        <span class="c1"># Creates Mac in DB</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">vendor</span> <span class="o">=</span> <span class="n">MAC</span><span class="p">(</span><span class="s1">&#39;macvendors1.db&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_vendor</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">vendor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Vendor not Found&quot;</span><span class="p">)</span>

            <span class="n">macs</span> <span class="o">=</span> <span class="n">MACAddress</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">macs</span><span class="p">:</span>
                <span class="n">mac</span> <span class="o">=</span> <span class="n">MACAddress</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span>
                                                <span class="n">modified_by</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                                                <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                                                <span class="n">last_ticket</span><span class="o">=</span><span class="n">last_ticket</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">makeLog</span><span class="p">([</span><span class="n">mac</span><span class="o">.</span><span class="vm">__class__</span><span class="p">],</span> <span class="n">mac</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mac</span> <span class="o">=</span> <span class="n">macs</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="n">service_mac</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">mac</span><span class="o">.</span><span class="n">mlpav4_set</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
                <span class="n">service_mac</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">mac</span><span class="o">.</span><span class="n">mlpav6_set</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
                <span class="n">service_mac</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">mac</span><span class="o">.</span><span class="n">bilateralpeer_set</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
                <span class="n">service_mac</span> <span class="o">=</span> <span class="n">service_mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>

        <span class="c1"># Adds Mac to a service</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">service</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">service</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;service&#39;</span><span class="p">]))</span>
                <span class="n">service</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;service&#39;</span><span class="p">]))</span>
                <span class="n">service</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="n">Monitorv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;service&#39;</span><span class="p">]))</span>
                <span class="n">service</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="n">BilateralPeer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;service&#39;</span><span class="p">]))</span>
                <span class="n">service</span> <span class="o">=</span> <span class="n">service</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">service_mac</span> <span class="ow">and</span> <span class="n">service_mac</span><span class="o">.</span><span class="n">asn</span><span class="o">.</span><span class="n">number</span> <span class="o">!=</span> <span class="n">service</span><span class="o">.</span><span class="n">asn</span><span class="o">.</span><span class="n">number</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                        <span class="s2">&quot;MAC is allocated in another asn&quot;</span><span class="p">)</span>

                <span class="n">service</span><span class="o">.</span><span class="n">mac_addresses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mac</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
                <span class="n">service</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
                <span class="n">service</span><span class="o">.</span><span class="n">last_ticket</span> <span class="o">=</span> <span class="n">last_ticket</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">mac_addresses</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
                        <span class="s2">&quot;Warn: Two Mac Address are Allowed only during &quot;</span>
                        <span class="s2">&quot;migrations&quot;</span><span class="p">)</span>

                <span class="n">service</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;MAC registered&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">form_invalid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="AddDIOToPIXFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.AddDIOToPIXFormView">[docs]</a><span class="k">class</span> <span class="nc">AddDIOToPIXFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add a DIO to a PIX</span>

<span class="sd">    Attributes:</span>
<span class="sd">        form_class (&lt;class &#39;ixbr_api.core.forms.AddDIOToPIXForm&#39;&gt;):</span>
<span class="sd">        Class that contains the form that adds a new DIO.</span>
<span class="sd">        http_method_names (list): Requisition methods</span>
<span class="sd">        context (dict): Dictionary that return a set of informations</span>
<span class="sd">            to be printed.</span>
<span class="sd">        template_name (str): forms/add_dio_form.html</span>
<span class="sd">    returns:</span>
<span class="sd">        If the request method is a get, will return a dict context with</span>
<span class="sd">        the fields of form. If method requisition is different of get,</span>
<span class="sd">        return success message case the DIO was successfully added or</span>
<span class="sd">        error message case DIO was not added</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/add_dio_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">AddDIOToPIXForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pix</span><span class="p">):</span>
        <span class="n">pix</span> <span class="o">=</span> <span class="n">PIX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">pix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">(),</span>
            <span class="s1">&#39;pix&#39;</span><span class="p">:</span> <span class="n">pix</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@updatelastticket</span>
    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">pix</span> <span class="o">=</span> <span class="n">PIX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pix&#39;</span><span class="p">])</span>
                <span class="n">last_ticket</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;last_ticket&#39;</span><span class="p">]</span>
                <span class="n">dio_name</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;dio_name&#39;</span><span class="p">]</span>
                <span class="n">number_of_ports</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;number_of_ports&#39;</span><span class="p">]</span>
                <span class="n">ix_position_pattern</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;ix_position&#39;</span><span class="p">]</span>
                <span class="n">datacenter_position_pattern</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span>
                    <span class="s1">&#39;datacenter_position&#39;</span><span class="p">]</span>

                <span class="n">new_dio</span> <span class="o">=</span> <span class="n">DIO</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">pix</span><span class="o">=</span><span class="n">pix</span><span class="p">,</span>
                                             <span class="n">name</span><span class="o">=</span><span class="n">dio_name</span><span class="p">,</span>
                                             <span class="n">last_ticket</span><span class="o">=</span><span class="n">last_ticket</span><span class="p">,</span>
                                             <span class="n">modified_by</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>

                <span class="n">create_dio_ports_use_case</span><span class="o">.</span><span class="n">create_dio_ports</span><span class="p">(</span>
                    <span class="n">ix_position_pattern</span><span class="p">,</span>
                    <span class="n">datacenter_position_pattern</span><span class="p">,</span>
                    <span class="n">number_of_ports</span><span class="p">,</span>
                    <span class="n">new_dio</span><span class="p">,</span>
                    <span class="n">last_ticket</span><span class="p">,</span>
                    <span class="n">user</span><span class="p">)</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;DIO saved&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<span class="k">class</span> <span class="nc">GenericMLPAUsedChannelFormView</span><span class="p">(</span><span class="n">AjaxableResponseMixin</span><span class="p">,</span>
                                     <span class="n">LoginRequiredMixin</span><span class="p">,</span>
                                     <span class="n">LogsMixin</span><span class="p">,</span>
                                     <span class="n">FormView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/generic_mlpa_used_channel.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">GenericMLPAUsedChannelForm</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">asn</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="n">customer_channel</span> <span class="o">=</span> <span class="n">CustomerChannel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">channel</span><span class="p">)</span>

        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;asn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asn</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
            <span class="s1">&#39;asn&#39;</span><span class="p">:</span> <span class="n">asn</span><span class="p">,</span>
            <span class="s1">&#39;customer_channel&#39;</span><span class="p">:</span> <span class="n">customer_channel</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@updatelastticket</span>
    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">GenericMLPANewChannelFormView</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">)</span>


<div class="viewcode-block" id="EditPhoneFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.EditPhoneFormView">[docs]</a><span class="k">class</span> <span class="nc">EditPhoneFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class has, as main objective, to edit a phone</span>

<span class="sd">    Attributes:</span>
<span class="sd">        context (dic): Dictionary with information to be printed on the screen</span>
<span class="sd">            form_class (Instance of forms.PhoneForm): Instance of the PhoneForm</span>
<span class="sd">            class, this class contains all form information</span>
<span class="sd">        http_method_names (list): List containing the request types</span>
<span class="sd">        initial (dict): Boot Dictionary, if you need to start a field with a</span>
<span class="sd">        value template_name (str): Name of the template used for this form</span>
<span class="sd">        old_phone (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get a Phone</span>
<span class="sd">            by the primary key passed by parameter</span>
<span class="sd">        new_phone (object): New object of the models.Phone class, with all</span>
<span class="sd">            modifications</span>
<span class="sd">    Returns:</span>
<span class="sd">        If the old phone was successfully removed and the new one successfully</span>
<span class="sd">            added, it will return a successful message,</span>
<span class="sd">            else a message with the error occurred</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/edit_phone_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">PhoneForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">phone</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">old_phone</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Phone</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">phone</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_phone</span><span class="o">.</span><span class="n">number</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">old_phone</span><span class="o">.</span><span class="n">category</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;last_ticket&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_phone</span><span class="o">.</span> \
            <span class="n">last_ticket</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;last_ticket&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;readonly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;phone&#39;</span><span class="p">:</span> <span class="n">phone</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">old_phone</span> <span class="o">=</span> <span class="n">Phone</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">number</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span>
                <span class="n">category</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span>
                <span class="n">last_ticket</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;last_ticket&#39;</span><span class="p">]</span>
                <span class="n">new_phone</span> <span class="o">=</span> <span class="n">Phone</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">last_ticket</span><span class="o">=</span><span class="n">last_ticket</span><span class="p">,</span>
                    <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">,</span>
                    <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">,</span>
                    <span class="n">modified_by</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                    <span class="n">contact</span><span class="o">=</span><span class="n">old_phone</span><span class="o">.</span><span class="n">contact</span><span class="p">)</span>
                <span class="n">new_phone</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">old_phone</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;phone&#39;</span><span class="p">:</span> <span class="n">new_phone</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
                    <span class="s1">&#39;messenger&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span>
                <span class="p">}</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Phone saved&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">render_to_string</span><span class="p">(</span>
                    <span class="s1">&#39;forms/modal_feedback.html&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;phone&#39;</span><span class="p">:</span> <span class="n">old_phone</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
                <span class="s1">&#39;messenger&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">}</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">render_to_string</span><span class="p">(</span>
                <span class="s1">&#39;forms/modal_feedback.html&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">))</span></div>


<div class="viewcode-block" id="AddPhoneFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.AddPhoneFormView">[docs]</a><span class="k">class</span> <span class="nc">AddPhoneFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class has, as main objective, to add a new phone</span>

<span class="sd">    Attributes:</span>
<span class="sd">        context (dict): Dictionary with information to be printed on the screen</span>
<span class="sd">        form_class (Instance of forms.PhoneForm): Instance of the PhoneForm</span>
<span class="sd">            class, this class contains all form information</span>
<span class="sd">        http_method_names (list): List containing the request types</span>
<span class="sd">        template_name (str): Name of the template used for this form</span>
<span class="sd">        phone (object): New object of the models. Phone class, with all</span>
<span class="sd">            the data of a phone</span>
<span class="sd">        number (int): Phone number entered by user in form</span>
<span class="sd">        category (str): Category selected by the user in the form</span>
<span class="sd">        last_ticket (int): Last ticket entered by the user in the form</span>
<span class="sd">        contact (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get a Contact by</span>
<span class="sd">            the primary key passed by parameter</span>

<span class="sd">    Returns:</span>
<span class="sd">        A successful message if the phone has been added or an error message</span>
<span class="sd">        otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/add_phone_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">PhoneForm</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">contact</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">(),</span>
            <span class="s1">&#39;contact&#39;</span><span class="p">:</span> <span class="n">contact</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">number</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span>
                <span class="n">category</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span>
                <span class="n">last_ticket</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;last_ticket&#39;</span><span class="p">]</span>
                <span class="n">contact</span> <span class="o">=</span> <span class="n">Contact</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;contact&#39;</span><span class="p">])</span>

                <span class="n">phone</span> <span class="o">=</span> <span class="n">Phone</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">,</span>
                    <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">,</span>
                    <span class="n">contact</span><span class="o">=</span><span class="n">contact</span><span class="p">,</span>
                    <span class="n">last_ticket</span><span class="o">=</span><span class="n">last_ticket</span><span class="p">)</span>
                <span class="n">phone</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Phone saved&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="DeletePhoneView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.DeletePhoneView">[docs]</a><span class="k">class</span> <span class="nc">DeletePhoneView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This class has, as main objective, to delete a phone</span>

<span class="sd">    Attributes:</span>
<span class="sd">        phone (str): Primary key of the phone you want to delete, passed by</span>
<span class="sd">            kwargs</span>
<span class="sd">        phone_object (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get a</span>
<span class="sd">            Contact by the primary key passed by the GET method</span>
<span class="sd">        data (dic): Dictionary with information to be printed on the screen</span>
<span class="sd">    Returns:</span>
<span class="sd">        If the phone has been deleted successfully, it will return a</span>
<span class="sd">            successful message,</span>
<span class="sd">        else it will return a message with the error occurred</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">phone</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;phone&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">phone_object</span> <span class="o">=</span> <span class="n">Phone</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">phone</span><span class="p">)</span>
                <span class="n">phone_object</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;Phone was deleted successfully&#39;</span><span class="p">}</span>
        <span class="k">except</span> <span class="n">ValidationError</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="AddCustomerChannelFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.AddCustomerChannelFormView">[docs]</a><span class="k">class</span> <span class="nc">AddCustomerChannelFormView</span><span class="p">(</span><span class="n">AjaxableResponseMixin</span><span class="p">,</span>
                                 <span class="n">LoginRequiredMixin</span><span class="p">,</span>
                                 <span class="n">LogsMixin</span><span class="p">,</span>
                                 <span class="n">FormView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class has, as main objective, to add a new channel</span>

<span class="sd">    Attributes:</span>
<span class="sd">        context (dict): Dictionary with information to be printed on the screen</span>
<span class="sd">        form_class (Instance of forms.AddCustomerChannelForm): Instance of the</span>
<span class="sd">            AddCustomerChannelForm class, this class contains all form information</span>
<span class="sd">        http_method_names (list): List containing the request types</span>
<span class="sd">        initial (dict): Boot Dictionary, if you need to start a field with a</span>
<span class="sd">            value</span>
<span class="sd">        template_name (str): Name of the template used for this form</span>
<span class="sd">        phone_object (object): New object of the models.Phone class, with all</span>
<span class="sd">            the data of a phone</span>
<span class="sd">        number (int): Phone number entered by user in form</span>
<span class="sd">        category (str): Category selected by the user in the form</span>
<span class="sd">        last_ticket (int): Last ticket entered by the user in the form</span>
<span class="sd">        contact (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get a Contact by</span>
<span class="sd">            the primary key passed by parameter</span>
<span class="sd">    Returns:</span>
<span class="sd">        If the new channel has been added successfully, it will return a</span>
<span class="sd">            successful message,</span>
<span class="sd">        else it will return a message with the error occurred</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/add_customer_channel_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">AddCustomerChannelForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">asn</span><span class="p">,</span> <span class="n">pix</span><span class="p">):</span>
        <span class="n">pix_object</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">PIX</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pix</span><span class="p">)</span>

        <span class="n">switch_set</span> <span class="o">=</span> <span class="n">pix_object</span><span class="o">.</span><span class="n">switch_set</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pix</span><span class="o">=</span><span class="n">pix_object</span><span class="p">)</span>

        <span class="n">switch_list</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">for</span> <span class="n">switch</span> <span class="ow">in</span> <span class="n">switch_set</span><span class="p">:</span>
            <span class="n">switch_list</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">switch</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">switch</span><span class="o">.</span><span class="n">management_ip</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">(</span><span class="n">switchs</span><span class="o">=</span><span class="n">switch_list</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;pix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">choices</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">PIX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pix</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;pix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;readonly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;pix_uuid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pix</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;asn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asn</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;asn&#39;</span><span class="p">:</span> <span class="n">asn</span><span class="p">,</span>
            <span class="s1">&#39;pix&#39;</span><span class="p">:</span> <span class="n">pix</span><span class="p">,</span>
            <span class="s1">&#39;switch&#39;</span><span class="p">:</span> <span class="n">switch_list</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">pix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pix&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pix_uuid&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">switch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;switch&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">channel_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;channel_name&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">as_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;asn&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">cix_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cix_type&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">ports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;ports&#39;</span><span class="p">)</span>
                <span class="n">ticket</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ticket&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
                <span class="c1"># TODO: need more informations on model of Translation Channel</span>
                <span class="c1"># to continue</span>
                <span class="c1"># translation_channel = \</span>
                <span class="c1">#   self.request.POST[&#39;translation_channel&#39;]</span>

                <span class="n">ix_object</span> <span class="o">=</span> <span class="n">IX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pix__pk</span><span class="o">=</span><span class="n">pix</span><span class="p">)</span>
                <span class="n">asn</span> <span class="o">=</span> <span class="n">ASN</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">as_number</span><span class="p">)</span>
                <span class="n">switch_object</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Switch</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">switch</span><span class="p">)</span>

                <span class="n">is_lag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ports</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">is_lag</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span><span class="p">(</span><span class="n">ix_object</span><span class="o">.</span><span class="n">tags_policy</span> <span class="o">==</span> <span class="s1">&#39;ix_managed&#39;</span> <span class="ow">or</span>
                        <span class="ow">not</span> <span class="n">switch_object</span><span class="o">.</span><span class="n">is_pe</span><span class="p">):</span>
                    <span class="n">tags_type</span> <span class="o">=</span> <span class="s1">&#39;Indirect-Bundle-Ether&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tags_type</span> <span class="o">=</span> <span class="s1">&#39;Direct-Bundle-Ether&#39;</span>

                <span class="n">channel_port</span> <span class="o">=</span> <span class="n">ChannelPort</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">tags_type</span><span class="o">=</span><span class="n">tags_type</span><span class="p">,</span>
                    <span class="n">last_ticket</span><span class="o">=</span><span class="n">ticket</span><span class="p">,</span>
                    <span class="n">create_tags</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
                    <span class="n">p_object</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Port</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
                    <span class="n">channel_port</span><span class="o">.</span><span class="n">port_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p_object</span><span class="p">)</span>
                    <span class="n">p_object</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;UNAVAILABLE&#39;</span>
                    <span class="n">p_object</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">tags_type</span> <span class="o">==</span> <span class="s1">&#39;Direct-Bundle-Ether&#39;</span> <span class="ow">and</span> <span class="n">switch_object</span><span class="o">.</span><span class="n">is_pe</span><span class="p">:</span>
                    <span class="n">create_tag_by_channel_port</span><span class="p">(</span><span class="n">channel_port</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

                <span class="n">customer_channel</span> <span class="o">=</span> <span class="n">CustomerChannel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">cix_type</span><span class="o">=</span><span class="n">cix_type</span><span class="p">,</span> <span class="n">asn</span><span class="o">=</span><span class="n">asn</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">channel_name</span><span class="p">,</span>
                    <span class="n">is_lag</span><span class="o">=</span><span class="n">is_lag</span><span class="p">,</span> <span class="n">channel_port</span><span class="o">=</span><span class="n">channel_port</span><span class="p">,</span>
                    <span class="n">last_ticket</span><span class="o">=</span><span class="n">ticket</span><span class="p">,</span> <span class="n">is_mclag</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">channel_port</span><span class="o">.</span><span class="n">port_set</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="n">port</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;CUSTOMER&#39;</span>
                    <span class="n">port</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="n">customer_channel</span><span class="o">.</span><span class="n">channel_port</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span>
                    <span class="n">render_to_string</span><span class="p">(</span><span class="s1">&#39;forms/modal_feedback_service.html&#39;</span><span class="p">,</span>
                                     <span class="n">context</span><span class="p">))</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span>
                <span class="n">render_to_string</span><span class="p">(</span><span class="s1">&#39;forms/modal_feedback_service.html&#39;</span><span class="p">,</span>
                                 <span class="n">context</span><span class="p">))</span></div>


<div class="viewcode-block" id="AddPixToAsnFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.AddPixToAsnFormView">[docs]</a><span class="k">class</span> <span class="nc">AddPixToAsnFormView</span><span class="p">(</span><span class="n">AjaxableResponseMixin</span><span class="p">,</span>
                          <span class="n">LoginRequiredMixin</span><span class="p">,</span>
                          <span class="n">LogsMixin</span><span class="p">,</span>
                          <span class="n">FormView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class has, as main objective, to add a new channel</span>

<span class="sd">    Attributes:</span>
<span class="sd">        context (dict): Dictionary with information to be printed on the screen</span>
<span class="sd">        form_class (Instance of forms.AddCustomerChannelForm): Instance of the</span>
<span class="sd">            AddCustomerChannelForm class, this class contains all form information</span>
<span class="sd">        http_method_names (list): List containing the request types</span>
<span class="sd">        initial (dict): Boot Dictionary, if you need to start a field with a</span>
<span class="sd">            value</span>
<span class="sd">        template_name (str): Name of the template used for this form</span>
<span class="sd">        phone_object (object): New object of the models.Phone class, with all</span>
<span class="sd">            the data of a phone</span>
<span class="sd">        number (int): Phone number entered by user in form</span>
<span class="sd">        category (str): Category selected by the user in the form</span>
<span class="sd">        last_ticket (int): Last ticket entered by the user in the form</span>
<span class="sd">        contact (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get a Contact by</span>
<span class="sd">            the primary key passed by parameter</span>
<span class="sd">    Returns:</span>
<span class="sd">        If the new channel has been added successfully, it will return a</span>
<span class="sd">            successful message,</span>
<span class="sd">        else it will return a message with the error occurred</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/add_customer_channel_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">AddCustomerChannelForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">asn</span><span class="p">):</span>
        <span class="n">switch_set</span> <span class="o">=</span> <span class="n">Switch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pix__ix</span><span class="o">=</span><span class="n">ix</span><span class="p">)</span>

        <span class="n">switch_list</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">for</span> <span class="n">switch</span> <span class="ow">in</span> <span class="n">switch_set</span><span class="p">:</span>
            <span class="n">switch_list</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">switch</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">switch</span><span class="o">.</span><span class="n">management_ip</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">(</span><span class="n">switchs</span><span class="o">=</span><span class="n">switch_list</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;asn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asn</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;pix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">PIX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="n">ix</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;switch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">Switch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">pix</span><span class="o">=</span><span class="n">PIX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="n">ix</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">())</span>
        <span class="n">switch_initial</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;switch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;switch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">switch_initial</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;ports&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">switch</span><span class="o">=</span><span class="n">switch_initial</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;AVAILABLE&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;asn&#39;</span><span class="p">:</span> <span class="n">asn</span><span class="p">,</span>
            <span class="s1">&#39;ix&#39;</span><span class="p">:</span> <span class="n">ix</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">AddCustomerChannelFormView</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">)</span></div>


<div class="viewcode-block" id="EditContactFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.EditContactFormView">[docs]</a><span class="k">class</span> <span class="nc">EditContactFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This class has, as main objective, to edit a contact</span>

<span class="sd">    Attributes:</span>
<span class="sd">        context (dic): Dictionary with information to be printed on the screen</span>
<span class="sd">        form_class (Instance of forms.EditContactForm): Instance of the</span>
<span class="sd">            EditContactForm class, this class contains all form information</span>
<span class="sd">        http_method_names (list): List containing the request types</span>
<span class="sd">        initial (dict): Boot Dictionary, if you need to start a field with a</span>
<span class="sd">            value</span>
<span class="sd">        template_name (str): Name of the template used for this form</span>
<span class="sd">        name (str): New contact name entered by the user in the form</span>
<span class="sd">        email (str): New contact email entered by the user in the form</span>
<span class="sd">        last_ticket (int): New contact last ticket entered by the user in the</span>
<span class="sd">            form</span>
<span class="sd">        contact_object (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get a</span>
<span class="sd">            Contact by the primary key passed by parameter</span>
<span class="sd">        new_contact (object): New object of the models.Contact class, with all</span>
<span class="sd">            modifications</span>
<span class="sd">        contacsmap_object (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get a</span>
<span class="sd">            ContactsMap by the primary key passed by parameter</span>
<span class="sd">        type_contact (str): The contact type, passed by parameter</span>
<span class="sd">    Returns:</span>
<span class="sd">        If the old contact was deleted successfully and the new contact with</span>
<span class="sd">            the modifications was successfully added, it will return a success</span>
<span class="sd">            message, else it will return a message with the error occurred</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/edit_contact_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">EditContactForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">contact</span><span class="p">,</span> <span class="n">contactsmap</span><span class="p">,</span> <span class="n">type_contact</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">contact_object</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Contact</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">contact</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contact_object</span><span class="o">.</span><span class="n">name</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contact_object</span><span class="o">.</span><span class="n">email</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;last_ticket&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">contact_object</span><span class="o">.</span><span class="n">last_ticket</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;contact&#39;</span><span class="p">:</span> <span class="n">contact</span><span class="p">,</span>
            <span class="s1">&#39;contactsmap&#39;</span><span class="p">:</span> <span class="n">contactsmap</span><span class="p">,</span>
            <span class="s1">&#39;type_contact&#39;</span><span class="p">:</span> <span class="n">type_contact</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">email</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
                <span class="n">last_ticket</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;last_ticket&#39;</span><span class="p">]</span>
                <span class="n">contact_object</span> <span class="o">=</span> <span class="n">Contact</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;contact&#39;</span><span class="p">])</span>

                <span class="n">new_contact</span> <span class="o">=</span> <span class="n">Contact</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span> <span class="n">last_ticket</span><span class="o">=</span><span class="n">last_ticket</span><span class="p">,</span>
                    <span class="n">modified_by</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
                <span class="n">new_contact</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">contacsmap_object</span> <span class="o">=</span> <span class="n">ContactsMap</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;contactsmap&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;type_contact&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;noc&#39;</span><span class="p">:</span>
                    <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">noc_contact</span> <span class="o">=</span> <span class="n">new_contact</span>
                    <span class="k">if</span> <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">adm_contact</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">contact_object</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                        <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">adm_contact</span> <span class="o">=</span> <span class="n">new_contact</span>

                    <span class="k">if</span> <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">com_contact</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">contact_object</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                        <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">com_contact</span> <span class="o">=</span> <span class="n">new_contact</span>

                    <span class="k">if</span> <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">peer_contact</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">contact_object</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                        <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">peer_contact</span> <span class="o">=</span> <span class="n">new_contact</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;type_contact&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;adm&#39;</span><span class="p">:</span>
                    <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">adm_contact</span> <span class="o">=</span> <span class="n">new_contact</span>
                    <span class="k">if</span> <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">noc_contact</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">contact_object</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                        <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">noc_contact</span> <span class="o">=</span> <span class="n">new_contact</span>

                    <span class="k">if</span> <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">com_contact</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">contact_object</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                        <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">com_contact</span> <span class="o">=</span> <span class="n">new_contact</span>

                    <span class="k">if</span> <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">peer_contact</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">contact_object</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                        <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">peer_contact</span> <span class="o">=</span> <span class="n">new_contact</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;type_contact&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;per&#39;</span><span class="p">:</span>
                    <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">peer_contact</span> <span class="o">=</span> <span class="n">new_contact</span>
                    <span class="k">if</span> <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">noc_contact</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">contact_object</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                        <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">noc_contact</span> <span class="o">=</span> <span class="n">new_contact</span>

                    <span class="k">if</span> <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">com_contact</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">contact_object</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                        <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">com_contact</span> <span class="o">=</span> <span class="n">new_contact</span>

                    <span class="k">if</span> <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">adm_contact</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">contact_object</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                        <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">adm_contact</span> <span class="o">=</span> <span class="n">new_contact</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;type_contact&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;com&#39;</span><span class="p">:</span>
                    <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">com_contact</span> <span class="o">=</span> <span class="n">new_contact</span>
                    <span class="k">if</span> <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">noc_contact</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">contact_object</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                        <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">noc_contact</span> <span class="o">=</span> <span class="n">new_contact</span>

                    <span class="k">if</span> <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">adm_contact</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">contact_object</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                        <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">adm_contact</span> <span class="o">=</span> <span class="n">new_contact</span>

                    <span class="k">if</span> <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">peer_contact</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">contact_object</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                        <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">peer_contact</span> <span class="o">=</span> <span class="n">new_contact</span>

                <span class="n">phones</span> <span class="o">=</span> <span class="n">Phone</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">contact</span><span class="o">=</span><span class="n">contact_object</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">phone</span> <span class="ow">in</span> <span class="n">phones</span><span class="p">:</span>
                    <span class="n">new_phone</span> <span class="o">=</span> <span class="n">Phone</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                        <span class="n">number</span><span class="o">=</span><span class="n">phone</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">phone</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
                        <span class="n">modified_by</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">contact</span><span class="o">=</span><span class="n">new_contact</span><span class="p">,</span>
                        <span class="n">last_ticket</span><span class="o">=</span><span class="n">phone</span><span class="o">.</span><span class="n">last_ticket</span><span class="p">)</span>
                    <span class="n">new_phone</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">phone</span> <span class="ow">in</span> <span class="n">phones</span><span class="p">:</span>
                    <span class="n">phone</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

                <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;contact&#39;</span><span class="p">:</span> <span class="n">new_contact</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
                    <span class="s1">&#39;contactsmap&#39;</span><span class="p">:</span> <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
                    <span class="s1">&#39;type_contact&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;type_contact&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;messenger&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span>
                <span class="p">}</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Contact saved&quot;</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span>
                    <span class="n">render_to_string</span><span class="p">(</span><span class="s1">&#39;forms/modal_feedback.html&#39;</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">))</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;contact&#39;</span><span class="p">:</span> <span class="n">new_contact</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
                <span class="s1">&#39;contactsmap&#39;</span><span class="p">:</span> <span class="n">contacsmap_object</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
                <span class="s1">&#39;type_contact&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;type_contact&#39;</span><span class="p">],</span>
                <span class="s1">&#39;messenger&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">}</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span>
                <span class="n">render_to_string</span><span class="p">(</span><span class="s1">&#39;forms/modal_feedback.html&#39;</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">))</span></div>


<div class="viewcode-block" id="EditContactsMapFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.EditContactsMapFormView">[docs]</a><span class="k">class</span> <span class="nc">EditContactsMapFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This class has, as main objective, to edit a contactsmap</span>

<span class="sd">    Attributes:</span>
<span class="sd">        context (dic): Dictionary with information to be printed on the screen</span>
<span class="sd">        form_class (Instance of forms.EditContactForm): ContactsMapEditForm</span>
<span class="sd">        http_method_names (list): List containing the request types</span>
<span class="sd">        initial (dict): Boot Dictionary, if you need to start a field with a</span>
<span class="sd">            value</span>
<span class="sd">        template_name (str): Name of the template used for this form</span>
<span class="sd">        contactsmap_object (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get a</span>
<span class="sd">            ContactsMap by the primary key passed by paramete</span>
<span class="sd">        contacts (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get all contacts</span>
<span class="sd">            from an ix and asn passed by parameter</span>
<span class="sd">        noc_contact (Relationship with the contact): Relationship with the</span>
<span class="sd">            contact, noc contact is a type of contact</span>
<span class="sd">        adm_contact (Relationship with the contact): Relationship with the</span>
<span class="sd">            contact, adm contact is a type of contact</span>
<span class="sd">        peer_contact (Relationship with the contact): Relationship with the</span>
<span class="sd">            contact, peer contact is a type of contact</span>
<span class="sd">        com_contact (Relationship with the contact): Relationship with the</span>
<span class="sd">            contact, com contact is a type of contact</span>
<span class="sd">    Returns:</span>
<span class="sd">        If the contactsmap has been edited successfully, it will return a</span>
<span class="sd">            successful message,</span>
<span class="sd">        else it will return a message with the error occurred</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/edit_contacts_map_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">EditContactsMapForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">contactsmap</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">asn</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">contactsmap_object</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">ContactsMap</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">contactsmap</span><span class="p">)</span>
        <span class="n">contacts</span> <span class="o">=</span> <span class="n">Contact</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Q</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">ContactsMap</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="n">ix</span><span class="p">,</span> <span class="n">asn</span><span class="o">=</span><span class="n">asn</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span>
                <span class="s1">&#39;noc_contact&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="o">|</span>
            <span class="n">Q</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">ContactsMap</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="n">ix</span><span class="p">,</span> <span class="n">asn</span><span class="o">=</span><span class="n">asn</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span>
                <span class="s1">&#39;adm_contact&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="o">|</span>
            <span class="n">Q</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">ContactsMap</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="n">ix</span><span class="p">,</span> <span class="n">asn</span><span class="o">=</span><span class="n">asn</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span>
                <span class="s1">&#39;peer_contact&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="o">|</span>
            <span class="n">Q</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">ContactsMap</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="n">ix</span><span class="p">,</span> <span class="n">asn</span><span class="o">=</span><span class="n">asn</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span>
                <span class="s1">&#39;com_contact&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;noc_contact&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">contacts</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;adm_contact&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">contacts</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;peer_contact&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">contacts</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;com_contact&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">contacts</span>

        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;noc_contact&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">contactsmap_object</span><span class="o">.</span><span class="n">noc_contact</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;adm_contact&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">contactsmap_object</span><span class="o">.</span><span class="n">adm_contact</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;peer_contact&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">contactsmap_object</span><span class="o">.</span><span class="n">peer_contact</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;com_contact&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">contactsmap_object</span><span class="o">.</span><span class="n">com_contact</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;last_ticket&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">contactsmap_object</span><span class="o">.</span><span class="n">last_ticket</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;last_ticket&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;readonly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;contactsmap&#39;</span><span class="p">:</span> <span class="n">contactsmap</span><span class="p">,</span>
            <span class="s1">&#39;ix&#39;</span><span class="p">:</span> <span class="n">ix</span><span class="p">,</span>
            <span class="s1">&#39;asn&#39;</span><span class="p">:</span> <span class="n">asn</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">contactsmap_object</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span>
                    <span class="n">ContactsMap</span><span class="p">,</span>
                    <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;contactsmap&#39;</span><span class="p">])</span>
                <span class="n">noc_contact</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;noc_contact&#39;</span><span class="p">]</span>
                <span class="n">adm_contact</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;adm_contact&#39;</span><span class="p">]</span>
                <span class="n">peer_contact</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;peer_contact&#39;</span><span class="p">]</span>
                <span class="n">com_contact</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;com_contact&#39;</span><span class="p">]</span>

                <span class="n">contactsmap_object</span><span class="o">.</span><span class="n">noc_contact</span> <span class="o">=</span> <span class="n">noc_contact</span>
                <span class="n">contactsmap_object</span><span class="o">.</span><span class="n">adm_contact</span> <span class="o">=</span> <span class="n">adm_contact</span>
                <span class="n">contactsmap_object</span><span class="o">.</span><span class="n">peer_contact</span> <span class="o">=</span> <span class="n">peer_contact</span>
                <span class="n">contactsmap_object</span><span class="o">.</span><span class="n">com_contact</span> <span class="o">=</span> <span class="n">com_contact</span>
                <span class="n">contactsmap_object</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Contactsmap saved&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="EditOrganizationFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.EditOrganizationFormView">[docs]</a><span class="k">class</span> <span class="nc">EditOrganizationFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This class has, as main objective, redenrize and submit</span>
<span class="sd">    the form to edit an organization.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        context (dict): Dictionary with all information</span>
<span class="sd">            to be printed on the screen</span>
<span class="sd">        form_class (Instance of forms.EditOrganizationForm): EditOrganizationForm</span>
<span class="sd">        http_method_names (list): List containing the request types</span>
<span class="sd">        initial (dict): Boot Dictionary, if you need to start a field</span>
<span class="sd">            with a value</span>
<span class="sd">        template_name (str): Name of the template used for this form</span>
<span class="sd">        organization_object (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get a</span>
<span class="sd">            Organization by the primary key passed by paramete</span>
<span class="sd">        name (str): Name of the organization, this data comes from the</span>
<span class="sd">            form when it is submitted</span>
<span class="sd">        shortname (str): Shortname of organization, this data comes from the</span>
<span class="sd">            form when it is submitted</span>
<span class="sd">        url (str): URL of organization, this data comes from the form when</span>
<span class="sd">            it is submitted</span>
<span class="sd">        address (str): Address of organization, this data comes from the for</span>
<span class="sd">            when it is submitted</span>

<span class="sd">    Returns:</span>
<span class="sd">        If the organization has been edited successfully,</span>
<span class="sd">        it will return a successful message, else it will return</span>
<span class="sd">        a message with the error occurred.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/edit_organization_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">EditOrganizationForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">organization</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">organization_object</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Organization</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">organization</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">organization_object</span><span class="o">.</span><span class="n">name</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;shortname&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">organization_object</span><span class="o">.</span><span class="n">shortname</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">organization_object</span><span class="o">.</span><span class="n">url</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">organization_object</span><span class="o">.</span><span class="n">address</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;organization&#39;</span><span class="p">:</span> <span class="n">organization</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">organization_object</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span>
                    <span class="n">Organization</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;organization&#39;</span><span class="p">])</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">shortname</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;shortname&#39;</span><span class="p">]</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>
                <span class="n">address</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">]</span>

                <span class="n">organization_object</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
                <span class="n">organization_object</span><span class="o">.</span><span class="n">shortname</span> <span class="o">=</span> <span class="n">shortname</span>
                <span class="n">organization_object</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
                <span class="n">organization_object</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span>
                <span class="n">organization_object</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Organization saved&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="EditServiceStatusFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.EditServiceStatusFormView">[docs]</a><span class="k">class</span> <span class="nc">EditServiceStatusFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This class has, as main objective, redenrize and submit the form to</span>
<span class="sd">       edit the status of service</span>

<span class="sd">    Attributes:</span>
<span class="sd">        context (dic): Dictionary with all information to be printed on the</span>
<span class="sd">            screen</span>
<span class="sd">        form_class (Instance of forms.EditServiceStatusForm):</span>
<span class="sd">            EditServiceStatusForm</span>
<span class="sd">        http_method_names (list): List containing the request types</span>
<span class="sd">        initial (dict): Boot Dictionary, if you need to start a field with a</span>
<span class="sd">            value</span>
<span class="sd">        template_name (str): Name of the template used for this form</span>
<span class="sd">        service_list (list): List of the services</span>
<span class="sd">    Returns:</span>
<span class="sd">        If the status of service has been edited successfully, it will return</span>
<span class="sd">            a successful message,</span>
<span class="sd">        else it will return a message with the error occurred</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/edit_service_status_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">EditServiceStatusForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">service</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">service_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">service_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">pk</span><span class="o">=</span><span class="n">service</span><span class="p">))</span>
        <span class="n">service_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">pk</span><span class="o">=</span><span class="n">service</span><span class="p">))</span>
        <span class="n">service_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">BilateralPeer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">service</span><span class="p">))</span>
        <span class="n">service_list</span> <span class="o">=</span> <span class="n">service_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">service_list</span><span class="o">.</span><span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;service&#39;</span><span class="p">:</span> <span class="n">service</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">service_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">service_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;service&#39;</span><span class="p">]))</span>
                <span class="n">service_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;service&#39;</span><span class="p">]))</span>
                <span class="n">service_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">BilateralPeer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;service&#39;</span><span class="p">]))</span>
                <span class="n">service_list</span> <span class="o">=</span> <span class="n">service_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
                <span class="n">service_list</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
                <span class="n">service_list</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Status saved&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="EditServicePrefixLimitFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.EditServicePrefixLimitFormView">[docs]</a><span class="k">class</span> <span class="nc">EditServicePrefixLimitFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This class has, as main objective, redenrize and submit the form to</span>
<span class="sd">       edit the prefix limit of service</span>

<span class="sd">    Attributes:</span>
<span class="sd">        context (dic): Dictionary with all information to be printed on the</span>
<span class="sd">            screen</span>
<span class="sd">        form_class (Instance of forms.EditServicePrefixLimitForm):</span>
<span class="sd">            EditServicePrefixLimitForm</span>
<span class="sd">        http_method_names (list): List containing the request types</span>
<span class="sd">        initial (dict): Boot Dictionary, if you need to start a field with a</span>
<span class="sd">            value</span>
<span class="sd">        template_name (str): Name of the template used for this form</span>
<span class="sd">        service_list (list): List of the services</span>
<span class="sd">    Returns:</span>
<span class="sd">        If the prefix limit of service has been edited successfully, it will</span>
<span class="sd">            return a successful message,</span>
<span class="sd">        else it will return a message with the error occurred</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/edit_service_prefix_limit_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">EditServicePrefixLimitForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">service</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">service_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">service_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">pk</span><span class="o">=</span><span class="n">service</span><span class="p">))</span>
        <span class="n">service_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">pk</span><span class="o">=</span><span class="n">service</span><span class="p">))</span>
        <span class="n">service_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">BilateralPeer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">service</span><span class="p">))</span>
        <span class="n">service_list</span> <span class="o">=</span> <span class="n">service_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;prefix_limit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">service_list</span><span class="o">.</span><span class="n">prefix_limit</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;service&#39;</span><span class="p">:</span> <span class="n">service</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">service_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">service_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;service&#39;</span><span class="p">]))</span>
                <span class="n">service_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;service&#39;</span><span class="p">]))</span>
                <span class="n">service_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">BilateralPeer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;service&#39;</span><span class="p">]))</span>
                <span class="n">service_list</span> <span class="o">=</span> <span class="n">service_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">prefix_limit</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;prefix_limit&#39;</span><span class="p">]</span>
                <span class="n">service_list</span><span class="o">.</span><span class="n">prefix_limit</span> <span class="o">=</span> <span class="n">prefix_limit</span>
                <span class="n">service_list</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Prefix Limit saved&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="EditServiceTagFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.EditServiceTagFormView">[docs]</a><span class="k">class</span> <span class="nc">EditServiceTagFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This class has, as main objective, redenrize and submit the form to</span>
<span class="sd">       edit the tag of service</span>

<span class="sd">    Attributes:</span>
<span class="sd">        context (dic): Dictionary with all information to be printed on the</span>
<span class="sd">            screen</span>
<span class="sd">        form_class (Instance of forms.EditServiceTagForm): EditServiceTagForm</span>
<span class="sd">        http_method_names (list): List containing the request types</span>
<span class="sd">        initial (dict): Boot Dictionary, if you need to start a field with a</span>
<span class="sd">            value</span>
<span class="sd">        template_name (str): Name of the template used for this form</span>
<span class="sd">        service_list (list): List of the services</span>
<span class="sd">    Returns:</span>
<span class="sd">        If the tag of service has been edited successfully, it will return a</span>
<span class="sd">            successful message,</span>
<span class="sd">        else it will return a message with the error occurred</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/edit_service_tag_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">EditServiceTagForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;service&#39;</span><span class="p">:</span> <span class="n">service</span><span class="p">,</span>
            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">code</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span>

                <span class="n">tag_new</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span> <span class="n">ix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">])</span>
                <span class="n">service_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">service_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;service&#39;</span><span class="p">]))</span>
                <span class="n">service_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;service&#39;</span><span class="p">]))</span>
                <span class="n">service_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">BilateralPeer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;service&#39;</span><span class="p">]))</span>
                <span class="n">service_list</span> <span class="o">=</span> <span class="n">service_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">tag_old</span> <span class="o">=</span> <span class="n">service_list</span><span class="o">.</span><span class="n">tag</span>

                <span class="n">bilateral</span> <span class="o">=</span> <span class="n">BilateralPeer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">service_list</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bilateral</span><span class="p">:</span>
                    <span class="n">free_tags</span> <span class="o">=</span> <span class="n">get_tag_without_all_service</span><span class="p">(</span>
                        <span class="n">ix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span>
                        <span class="n">channel</span><span class="o">=</span><span class="n">service_list</span><span class="o">.</span><span class="n">customer_channel</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">free_tags</span> <span class="o">=</span> <span class="n">get_tag_without_bilateral</span><span class="p">(</span>
                        <span class="n">ix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span>
                        <span class="n">channel</span><span class="o">=</span><span class="n">service_list</span><span class="o">.</span><span class="n">customer_channel</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">tag_new</span> <span class="ow">in</span> <span class="n">free_tags</span><span class="p">:</span>
                    <span class="n">service_list</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag_new</span>

                    <span class="n">service_list</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                    <span class="n">tag_new</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="s1">&#39;PRODUCTION&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">tag_old</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">free_tags</span><span class="p">:</span>
                        <span class="n">tag_old</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="s1">&#39;AVAILABLE&#39;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Tag status is PRODUCTION&quot;</span><span class="p">)</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Tag saved&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="AddContactFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.AddContactFormView">[docs]</a><span class="k">class</span> <span class="nc">AddContactFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This class has, as main objective, redenrize and submit the form to add</span>
<span class="sd">       a new contact</span>

<span class="sd">    Attributes:</span>
<span class="sd">        context (dic): Dictionary with all information to be printed on the</span>
<span class="sd">            screen</span>
<span class="sd">        form_class (Instance of forms.AddContactForm): AddContactForm</span>
<span class="sd">        http_method_names (list): List containing the request</span>
<span class="sd">            types</span>
<span class="sd">        initial (dict): Boot Dictionary, if you need to start a field with a</span>
<span class="sd">            value</span>
<span class="sd">        template_name (str): Name of the template used for this</span>
<span class="sd">            form</span>
<span class="sd">        last_ticket (int): Last ticket of contact, this data comes from the</span>
<span class="sd">            form when it is submitted</span>
<span class="sd">        name (str): Name of contact, this data comes from the form when it is</span>
<span class="sd">            submitted</span>
<span class="sd">        email (str): Email of contact, this data comes from the form when it</span>
<span class="sd">            is submitted</span>
<span class="sd">        noc (Bool): True if the type of contact is NOC, else, is False, this</span>
<span class="sd">            data comes from the form when it is submitted</span>
<span class="sd">        adm (Bool): True if the type of contact is ADM, else, is False, this</span>
<span class="sd">            data comes from the form when it is submitted</span>
<span class="sd">        peer (Bool): True if the type of contact is PEER, else, is False, this</span>
<span class="sd">            data comes from the form when it is submitted</span>
<span class="sd">        com (Bool): True if the type of contact is COM, else, is False, this</span>
<span class="sd">            data comes from the form when it is submitted</span>
<span class="sd">        contactsmap_object (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get a</span>
<span class="sd">            ContactsMap by the primary key passed by paramete</span>
<span class="sd">        contact (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): New created</span>
<span class="sd">            contact</span>
<span class="sd">    Returns:</span>
<span class="sd">         If the contact has been added successfully, it will return a</span>
<span class="sd">            successful message,</span>
<span class="sd">        else it will return a message with the error occurred</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/add_contact_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">AddContactForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">contactsmap</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">(),</span>
            <span class="s1">&#39;contactsmap&#39;</span><span class="p">:</span> <span class="n">contactsmap</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">last_ticket</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;last_ticket&#39;</span><span class="p">]</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">email</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
                <span class="n">noc</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;noc&#39;</span><span class="p">]</span>
                <span class="n">adm</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;adm&#39;</span><span class="p">]</span>
                <span class="n">peer</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;peer&#39;</span><span class="p">]</span>
                <span class="n">com</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;com&#39;</span><span class="p">]</span>

                <span class="n">contact</span> <span class="o">=</span> <span class="n">Contact</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
                    <span class="n">last_ticket</span><span class="o">=</span><span class="n">last_ticket</span><span class="p">,</span> <span class="n">modified_by</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
                <span class="n">contact</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="n">contactsmap_object</span> <span class="o">=</span> <span class="n">ContactsMap</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_none</span><span class="p">(</span>
                    <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;contactsmap&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">noc</span><span class="p">:</span>
                    <span class="n">contactsmap_object</span><span class="o">.</span><span class="n">noc_contact</span> <span class="o">=</span> <span class="n">contact</span>
                <span class="k">if</span> <span class="n">adm</span><span class="p">:</span>
                    <span class="n">contactsmap_object</span><span class="o">.</span><span class="n">adm_contact</span> <span class="o">=</span> <span class="n">contact</span>
                <span class="k">if</span> <span class="n">peer</span><span class="p">:</span>
                    <span class="n">contactsmap_object</span><span class="o">.</span><span class="n">peer_contact</span> <span class="o">=</span> <span class="n">contact</span>
                <span class="k">if</span> <span class="n">com</span><span class="p">:</span>
                    <span class="n">contactsmap_object</span><span class="o">.</span><span class="n">com_contact</span> <span class="o">=</span> <span class="n">contact</span>

                <span class="n">contactsmap_object</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Contact saved&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="EditCixTypeFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.EditCixTypeFormView">[docs]</a><span class="k">class</span> <span class="nc">EditCixTypeFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class has, as main objective, render and submit the form to edit a</span>
<span class="sd">       channel CIX Type</span>

<span class="sd">    Attributes:</span>
<span class="sd">        context (dic): Dictionary with all information to be printed on the</span>
<span class="sd">            screen</span>
<span class="sd">        form_class (Instance of forms.EditCixTypeForm): EditCixTypeForm</span>
<span class="sd">        http_method_names (list): List containing the request types</span>
<span class="sd">        initial (dict): Boot Dictionary, if you need to start a field with a</span>
<span class="sd">            value</span>
<span class="sd">        template_name (str): Name of the template used for this form</span>
<span class="sd">    Returns:</span>
<span class="sd">        If the channel CIX Type has been edited successfully, it will return a</span>
<span class="sd">            successful message,</span>
<span class="sd">        otherwise it will return a message with the error.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/edit_cix_type_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">EditCixTypeForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">channel_object</span> <span class="o">=</span> <span class="n">CustomerChannel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">channel</span><span class="p">)</span>
        <span class="n">cix_type</span> <span class="o">=</span> <span class="n">channel_object</span><span class="o">.</span><span class="n">cix_type</span>
        <span class="n">cix_types_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">CustomerChannel</span><span class="o">.</span><span class="n">CIX_TYPES</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;cix_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="n">CustomerChannel</span><span class="o">.</span><span class="n">CIX_TYPES</span><span class="p">[</span>
            <span class="n">cix_type</span><span class="p">:</span><span class="n">cix_types_length</span><span class="p">]</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;cix_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">cix_type</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="n">channel_object</span><span class="p">,</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">cix_type</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;cix_type&#39;</span><span class="p">]</span>
                <span class="n">channel_object</span> <span class="o">=</span> <span class="n">CustomerChannel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">cix_type</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">channel_object</span><span class="o">.</span><span class="n">cix_type</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;You cannot update to a lower CIX &quot;</span>
                                          <span class="s2">&quot;Type&quot;</span><span class="p">)</span>

                <span class="n">channel_object</span><span class="o">.</span><span class="n">cix_type</span> <span class="o">=</span> <span class="n">cix_type</span>
                <span class="n">channel_object</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Port saved&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="EditPortPhysicalInterfaceFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.EditPortPhysicalInterfaceFormView">[docs]</a><span class="k">class</span> <span class="nc">EditPortPhysicalInterfaceFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span>
                                        <span class="n">LogsMixin</span><span class="p">,</span>
                                        <span class="n">FormView</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This class has, as main objective, redenrize and submit the form to</span>
<span class="sd">       edit a port physical interface</span>

<span class="sd">    Attributes:</span>
<span class="sd">        context (dic): Dictionary with all information to be printed on the</span>
<span class="sd">            screen</span>
<span class="sd">        form_class (Instance of forms.EditPortPhysicalInterfaceForm):</span>
<span class="sd">            EditPortPhysicalInterfaceForm</span>
<span class="sd">        http_method_names (list): List containing the request types</span>
<span class="sd">        initial (dict): Boot Dictionary, if you need to start a field with a</span>
<span class="sd">            value</span>
<span class="sd">        template_name (str): Name of the template used for this form</span>
<span class="sd">        port_object (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get a Port by</span>
<span class="sd">            the primary key passed by paramete</span>
<span class="sd">        physical_interface (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get a</span>
<span class="sd">            PhysicalInterface by the primary key passed by paramete</span>
<span class="sd">    Returns:</span>
<span class="sd">        If the port physical interface has been edited successfully, it will</span>
<span class="sd">            return a successful message,</span>
<span class="sd">        otherwise it will return a message with the error.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/edit_port_physical_interface_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">EditPortPhysicalInterfaceForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">port_object</span> <span class="o">=</span> <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
        <span class="n">physical_interface</span> <span class="o">=</span> <span class="n">PhysicalInterface</span><span class="o">.</span><span class="n">get_free_physical_interfaces</span><span class="p">()</span>

        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;physical_interface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">physical_interface</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;physical_interface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> \
            <span class="n">port_object</span><span class="o">.</span><span class="n">physical_interface</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">physical_interface</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;physical_interface&#39;</span><span class="p">]</span>
                <span class="n">port_object</span> <span class="o">=</span> <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">])</span>
                <span class="n">port_object</span><span class="o">.</span><span class="n">physical_interface</span> <span class="o">=</span> <span class="n">physical_interface</span>
                <span class="n">port_object</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Port saved&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<span class="k">class</span> <span class="nc">CreatePortPhysicalInterfaceFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span>
                                          <span class="n">LogsMixin</span><span class="p">,</span>
                                          <span class="n">FormView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/create_port_physical_interface_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">CreatePortPhysicalInterfaceForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">]</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">connector_type</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;connector_type&#39;</span><span class="p">]</span>
                <span class="n">port_type</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;port_type&#39;</span><span class="p">]</span>
                <span class="n">serial_number</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;serial_number&#39;</span><span class="p">]</span>
                <span class="n">last_ticket</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;last_ticket&#39;</span><span class="p">]</span>

                <span class="n">PhysicalInterface</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">connector_type</span><span class="o">=</span><span class="n">connector_type</span><span class="p">,</span>
                    <span class="n">last_ticket</span><span class="o">=</span><span class="n">last_ticket</span><span class="p">,</span>
                    <span class="n">modified_by</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                    <span class="n">port_type</span><span class="o">=</span><span class="n">port_type</span><span class="p">,</span>
                    <span class="n">serial_number</span><span class="o">=</span><span class="n">serial_number</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Port saved&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>


<div class="viewcode-block" id="AddPortChannelFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.AddPortChannelFormView">[docs]</a><span class="k">class</span> <span class="nc">AddPortChannelFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This class has, as main objective, redenrize and submit the form to</span>
<span class="sd">       edit a port channel</span>

<span class="sd">    Attributes:</span>
<span class="sd">        context (dic): Dictionary with all information to be printed on the</span>
<span class="sd">            screen</span>
<span class="sd">        form_class (Instance of forms.EditPortPhysicalInterfaceForm):</span>
<span class="sd">            EditPortPhysicalInterfaceForm</span>
<span class="sd">        http_method_names (list): List containing the request types</span>
<span class="sd">        initial (dict): Boot Dictionary, if you need to start a field with a</span>
<span class="sd">            value</span>
<span class="sd">        template_name (str): Name of the template used for this form</span>
<span class="sd">        pix_object (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get a PIX by</span>
<span class="sd">            the primary key passed by paramete</span>
<span class="sd">        switch (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get all the</span>
<span class="sd">            Switches by the pix passed by paramete</span>
<span class="sd">        ports (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get all the ports</span>
<span class="sd">            free of all the switches of a pix</span>
<span class="sd">        customer_channel (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get a</span>
<span class="sd">            CustomerChannel by the primary key passed by paramete</span>
<span class="sd">    Returns:</span>
<span class="sd">        If the port has been successfully added to the customer channel, it</span>
<span class="sd">            will return a successful message,</span>
<span class="sd">        otherwise it will return an message with error.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/add_port_channel.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">AddPortChannel</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pix</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>

        <span class="n">pix_object</span> <span class="o">=</span> <span class="n">PIX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pix</span><span class="p">)</span>
        <span class="n">switch</span> <span class="o">=</span> <span class="n">Switch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pix</span><span class="o">=</span><span class="n">pix_object</span><span class="p">)</span>

        <span class="n">ports</span> <span class="o">=</span> <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Q</span><span class="p">(</span><span class="n">switch__in</span><span class="o">=</span><span class="n">switch</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>\
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;AVAILABLE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;switch&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">ports</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;pix&#39;</span><span class="p">:</span>  <span class="n">pix</span><span class="p">,</span>
            <span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span>

                <span class="n">customer_channel</span> <span class="o">=</span> <span class="n">CustomerChannel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">])</span>
                <span class="n">customer_channel</span><span class="o">.</span><span class="n">channel_port</span><span class="o">.</span><span class="n">port_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
                <span class="n">customer_channel</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">port</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;CUSTOMER&#39;</span>
                <span class="n">customer_channel</span><span class="o">.</span><span class="n">is_lag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">current_port</span> <span class="ow">in</span> <span class="p">(</span><span class="n">customer_channel</span><span class="o">.</span><span class="n">channel_port</span><span class="o">.</span>
                                     <span class="n">port_set</span><span class="o">.</span><span class="n">all</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">current_port</span><span class="o">.</span><span class="n">switch</span> <span class="o">!=</span> <span class="n">port</span><span class="o">.</span><span class="n">switch</span><span class="p">:</span>
                        <span class="n">customer_channel</span><span class="o">.</span><span class="n">is_mclag</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">customer_channel</span><span class="o">.</span><span class="n">is_lag</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">port</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">customer_channel</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Port saved&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="DeletePortChannelView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.DeletePortChannelView">[docs]</a><span class="k">class</span> <span class="nc">DeletePortChannelView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This class has, as main objective, to delete a port of customer channel</span>

<span class="sd">    Attributes:</span>
<span class="sd">        data (dic): Dictionary with all information to be printed on the screen</span>
<span class="sd">        port_object (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get a Port by</span>
<span class="sd">            the primary key passed by paramete</span>
<span class="sd">        customer_channel (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get a</span>
<span class="sd">            CustomerChannel by the primary key passed by paramete</span>
<span class="sd">    Returns:</span>
<span class="sd">        If the port was deleted from the customer channel successfully, it</span>
<span class="sd">            will return an error message,</span>
<span class="sd">        otherwise it will return a message with the error.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;port&quot;</span><span class="p">)</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">port_object</span> <span class="o">=</span> <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
                <span class="n">customer_channel</span> <span class="o">=</span> <span class="n">CustomerChannel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">channel</span><span class="p">)</span>
                <span class="n">customer_channel</span><span class="o">.</span><span class="n">channel_port</span><span class="o">.</span><span class="n">port_set</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">port_object</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="AddIXtoASNFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.AddIXtoASNFormView">[docs]</a><span class="k">class</span> <span class="nc">AddIXtoASNFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class has, as main objective, redenrize and</span>
<span class="sd">    submit the form to edit a port channel</span>

<span class="sd">    Attributes:</span>
<span class="sd">        context (dic): Dictionary with all information to</span>
<span class="sd">            be printed on the screen</span>
<span class="sd">        form_class (Instance of forms.EditPortPhysicalInterfaceForm):</span>
<span class="sd">            EditPortPhysicalInterfaceForm</span>
<span class="sd">        http_method_names (list): List containing the request types</span>
<span class="sd">        initial (dict): Boot Dictionary, if you need to start a</span>
<span class="sd">            field with a value</span>
<span class="sd">        template_name (str): Name of the template used for this form</span>
<span class="sd">        ixs_by_asn (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get all the</span>
<span class="sd">            ContactsMap by the asn passed by paramete</span>
<span class="sd">        ixs (&lt;class &#39;django.db.models.query.QuerySet&#39;&gt;): Get all IXs that the</span>
<span class="sd">            ASN does not have</span>
<span class="sd">    Returns:</span>
<span class="sd">        If IX was successfully added to the ASN, it will return a successful</span>
<span class="sd">            message, otherwise it will return a message with the error.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/add_ix_to_asn.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">AddIXtoASNForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">asn</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">ixs_by_asn</span> <span class="o">=</span> <span class="n">ContactsMap</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">asn</span><span class="o">=</span><span class="n">asn</span><span class="p">)</span>
        <span class="n">ixs</span> <span class="o">=</span> <span class="n">IX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
            <span class="n">pk__in</span><span class="o">=</span><span class="n">ixs_by_asn</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;ix&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;ix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">ixs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;asn&#39;</span><span class="p">:</span> <span class="n">asn</span><span class="p">,</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">contactsmap</span> <span class="o">=</span> <span class="n">ContactsMap</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">asn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;asn&#39;</span><span class="p">])</span>
                <span class="n">ix</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;ix&#39;</span><span class="p">]</span>
                <span class="n">ticket</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;ticket&#39;</span><span class="p">]</span>
                <span class="n">contactsmap_first</span> <span class="o">=</span> <span class="n">contactsmap</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="n">new_contactsmap</span> <span class="o">=</span> <span class="n">ContactsMap</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">last_ticket</span><span class="o">=</span><span class="n">ticket</span><span class="p">,</span>
                    <span class="n">organization</span><span class="o">=</span><span class="n">contactsmap_first</span><span class="o">.</span><span class="n">organization</span><span class="p">,</span>
                    <span class="n">ix</span><span class="o">=</span><span class="n">ix</span><span class="p">,</span>
                    <span class="n">asn</span><span class="o">=</span><span class="n">contactsmap_first</span><span class="o">.</span><span class="n">asn</span><span class="p">,</span>
                    <span class="n">noc_contact</span><span class="o">=</span><span class="n">contactsmap_first</span><span class="o">.</span><span class="n">noc_contact</span><span class="p">,</span>
                    <span class="n">adm_contact</span><span class="o">=</span><span class="n">contactsmap_first</span><span class="o">.</span><span class="n">adm_contact</span><span class="p">,</span>
                    <span class="n">peer_contact</span><span class="o">=</span><span class="n">contactsmap_first</span><span class="o">.</span><span class="n">peer_contact</span><span class="p">,</span>
                    <span class="n">com_contact</span><span class="o">=</span><span class="n">contactsmap_first</span><span class="o">.</span><span class="n">com_contact</span><span class="p">,</span>
                    <span class="n">org_contact</span><span class="o">=</span><span class="n">contactsmap_first</span><span class="o">.</span><span class="n">org_contact</span><span class="p">,</span>
                    <span class="n">peering_url</span><span class="o">=</span><span class="n">contactsmap_first</span><span class="o">.</span><span class="n">peering_url</span><span class="p">,</span>
                    <span class="n">peering_policy</span><span class="o">=</span><span class="n">contactsmap_first</span><span class="o">.</span><span class="n">peering_policy</span><span class="p">)</span>
                <span class="n">new_contactsmap</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;IX saved&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<span class="k">class</span> <span class="nc">GenericMLPANewChannelFormView</span><span class="p">(</span><span class="n">AjaxableResponseMixin</span><span class="p">,</span>
                                    <span class="n">LoginRequiredMixin</span><span class="p">,</span>
                                    <span class="n">LogsMixin</span><span class="p">,</span>
                                    <span class="n">FormView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/generic_mlpa_new_channel.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">GenericMLPANewChannelForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">tags_pk</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">asn</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">IX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;pix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">PIX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="n">ix</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;switch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">Switch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">()</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;customer_channel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> \
            <span class="n">CustomerChannel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">()</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;asn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asn</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
            <span class="s1">&#39;asn&#39;</span><span class="p">:</span> <span class="n">asn</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                <span class="n">last_ticket</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;last_ticket&#39;</span><span class="p">]</span>
                <span class="n">asn</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;asn&#39;</span><span class="p">]</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span>
                <span class="n">service_option</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;service_option&#39;</span><span class="p">]</span>
                <span class="n">tag4</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;tag_v4&#39;</span><span class="p">]</span>
                <span class="n">mlpav4_address</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;mlpav4_address&#39;</span><span class="p">]</span>
                <span class="n">tag6</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;tag_v6&#39;</span><span class="p">]</span>
                <span class="n">mlpav6_address</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;mlpav6_address&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="s1">&#39;channel&#39;</span> <span class="ow">in</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">:</span>
                    <span class="n">customer_channel</span> <span class="o">=</span> <span class="n">CustomerChannel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">pk</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">customer_channel</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;customer_channel&#39;</span><span class="p">]</span>

                <span class="n">asn</span> <span class="o">=</span> <span class="n">ASN</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">asn</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">customer_channel</span><span class="o">.</span><span class="n">cix_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">inner_v4</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;inner_v4&#39;</span><span class="p">]</span> \
                        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;inner_v4&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="n">inner_v6</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;inner_v6&#39;</span><span class="p">]</span> \
                        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;inner_v6&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">inner_v4</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">inner_v6</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">service_option</span> <span class="o">==</span> <span class="s2">&quot;only_v6&quot;</span><span class="p">:</span>
                    <span class="n">tag</span> <span class="o">=</span> <span class="n">GenericMLPANewChannelFormView</span><span class="o">.</span><span class="n">get_instance_tag</span><span class="p">(</span>
                        <span class="n">code</span><span class="p">,</span> <span class="n">tag6</span><span class="p">,</span> <span class="n">customer_channel</span><span class="p">)</span>
                    <span class="n">ipv6</span> <span class="o">=</span> <span class="n">GenericMLPANewChannelFormView</span><span class="o">.</span><span class="n">get_instance_ipv6</span><span class="p">(</span>
                        <span class="n">mlpav6_address</span><span class="p">)</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">GenericMLPANewChannelFormView</span><span class="o">.</span><span class="n">save_mlpav6</span><span class="p">(</span>
                        <span class="n">ipv6</span><span class="p">,</span> <span class="n">customer_channel</span><span class="p">,</span> <span class="n">asn</span><span class="p">,</span> <span class="n">last_ticket</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span>
                        <span class="n">inner_v6</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">service_option</span> <span class="o">==</span> <span class="s2">&quot;only_v4&quot;</span><span class="p">:</span>
                    <span class="n">ipv4</span> <span class="o">=</span> <span class="n">GenericMLPANewChannelFormView</span><span class="o">.</span><span class="n">get_instance_ipv4</span><span class="p">(</span>
                        <span class="n">mlpav4_address</span><span class="p">)</span>
                    <span class="n">tag</span> <span class="o">=</span> <span class="n">GenericMLPANewChannelFormView</span><span class="o">.</span><span class="n">get_instance_tag</span><span class="p">(</span>
                        <span class="n">code</span><span class="p">,</span> <span class="n">tag4</span><span class="p">,</span> <span class="n">customer_channel</span><span class="p">)</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">GenericMLPANewChannelFormView</span><span class="o">.</span><span class="n">save_mlpav4</span><span class="p">(</span>
                        <span class="n">ipv4</span><span class="p">,</span> <span class="n">customer_channel</span><span class="p">,</span> <span class="n">asn</span><span class="p">,</span> <span class="n">last_ticket</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span>
                        <span class="n">inner_v4</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">service_option</span> <span class="o">==</span> <span class="s2">&quot;v4_and_v6&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inner_v4</span> <span class="o">==</span> <span class="n">inner_v6</span> <span class="ow">and</span> <span class="n">customer_channel</span><span class="o">.</span><span class="n">cix_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Inner can not be the same&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tag_v4</span> <span class="o">=</span> <span class="n">GenericMLPANewChannelFormView</span><span class="o">.</span>\
                            <span class="n">get_instance_tag</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">tag4</span><span class="p">,</span> <span class="n">customer_channel</span><span class="p">)</span>
                        <span class="n">tag_v6</span> <span class="o">=</span> <span class="n">GenericMLPANewChannelFormView</span><span class="o">.</span>\
                            <span class="n">get_instance_tag</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">tag6</span><span class="p">,</span> <span class="n">customer_channel</span><span class="p">)</span>
                        <span class="n">ipv6</span> <span class="o">=</span> <span class="n">GenericMLPANewChannelFormView</span><span class="o">.</span><span class="n">get_instance_ipv6</span><span class="p">(</span>
                            <span class="n">mlpav6_address</span><span class="p">)</span>
                        <span class="n">ipv4</span> <span class="o">=</span> <span class="n">GenericMLPANewChannelFormView</span><span class="o">.</span><span class="n">get_instance_ipv4</span><span class="p">(</span>
                            <span class="n">mlpav4_address</span><span class="p">)</span>

                        <span class="n">message</span> <span class="o">=</span> <span class="n">GenericMLPANewChannelFormView</span>\
                            <span class="o">.</span><span class="n">save_mlpav4_mlpav6</span><span class="p">(</span>
                                <span class="n">ipv4</span><span class="o">=</span><span class="n">ipv4</span><span class="p">,</span>
                                <span class="n">ipv6</span><span class="o">=</span><span class="n">ipv6</span><span class="p">,</span>
                                <span class="n">customer_channel</span><span class="o">=</span><span class="n">customer_channel</span><span class="p">,</span>
                                <span class="n">asn</span><span class="o">=</span><span class="n">asn</span><span class="p">,</span>
                                <span class="n">last_ticket</span><span class="o">=</span><span class="n">last_ticket</span><span class="p">,</span>
                                <span class="n">tag_v4</span><span class="o">=</span><span class="n">tag_v4</span><span class="p">,</span>
                                <span class="n">tag_v6</span><span class="o">=</span><span class="n">tag_v6</span><span class="p">,</span>
                                <span class="n">inner_v4</span><span class="o">=</span><span class="n">inner_v4</span><span class="p">,</span>
                                <span class="n">inner_v6</span><span class="o">=</span><span class="n">inner_v6</span><span class="p">,)</span>

                <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">render_to_string</span><span class="p">(</span>
                    <span class="s1">&#39;forms/modal_feedback_service.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">))</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">)}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">)}</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">render_to_string</span><span class="p">(</span>
                <span class="s1">&#39;forms/modal_feedback_service.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_instance_ipv4</span><span class="p">(</span><span class="n">mlpav4_address</span><span class="p">):</span>
        <span class="n">ipv4</span> <span class="o">=</span> <span class="n">IPv4Address</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">mlpav4_address</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ipv4</span>

    <span class="k">def</span> <span class="nf">get_instance_ipv6</span><span class="p">(</span><span class="n">mlpav6_address</span><span class="p">):</span>
        <span class="n">ipv6</span> <span class="o">=</span> <span class="n">IPv6Address</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">mlpav6_address</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ipv6</span>

    <span class="k">def</span> <span class="nf">get_instance_tag</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="n">free_tags</span> <span class="o">=</span> <span class="n">get_free_tags</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span> <span class="n">ix</span><span class="o">=</span><span class="n">ix</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">free_tags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">instantiate_tag</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span> <span class="n">ix</span><span class="o">=</span><span class="n">ix</span><span class="p">,</span> <span class="n">tag_number</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">free_tags</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">save_mlpav4</span><span class="p">(</span><span class="n">mlpav4_address</span><span class="p">,</span> <span class="n">customer_channel</span><span class="p">,</span> <span class="n">asn</span><span class="p">,</span> <span class="n">last_ticket</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span>
                    <span class="n">inner</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Selected tag is already in use&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_service</span> <span class="o">=</span> <span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">mlpav4_address</span><span class="o">=</span><span class="n">mlpav4_address</span><span class="p">,</span>
                <span class="n">customer_channel</span><span class="o">=</span><span class="n">customer_channel</span><span class="p">,</span> <span class="n">asn</span><span class="o">=</span><span class="n">asn</span><span class="p">,</span>
                <span class="n">last_ticket</span><span class="o">=</span><span class="n">last_ticket</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span> <span class="n">shortname</span><span class="o">=</span><span class="s1">&#39;mlpav4&#39;</span><span class="p">,</span>
                <span class="n">inner</span><span class="o">=</span><span class="n">inner</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;QUARANTINE&#39;</span><span class="p">)</span>
            <span class="n">tag</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;PRODUCTION&quot;</span>
            <span class="n">tag</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">new_service</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;success&#39;</span>
        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">save_mlpav6</span><span class="p">(</span><span class="n">mlpav6_address</span><span class="p">,</span> <span class="n">customer_channel</span><span class="p">,</span> <span class="n">asn</span><span class="p">,</span> <span class="n">last_ticket</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span>
                    <span class="n">inner</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Selected tag is already in use&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_service</span> <span class="o">=</span> <span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">mlpav6_address</span><span class="o">=</span><span class="n">mlpav6_address</span><span class="p">,</span>
                <span class="n">customer_channel</span><span class="o">=</span><span class="n">customer_channel</span><span class="p">,</span> <span class="n">asn</span><span class="o">=</span><span class="n">asn</span><span class="p">,</span>
                <span class="n">last_ticket</span><span class="o">=</span><span class="n">last_ticket</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span> <span class="n">shortname</span><span class="o">=</span><span class="s1">&#39;mlpav6&#39;</span><span class="p">,</span>
                <span class="n">inner</span><span class="o">=</span><span class="n">inner</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;QUARANTINE&#39;</span><span class="p">)</span>
            <span class="n">tag</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;PRODUCTION&quot;</span>
            <span class="n">tag</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">new_service</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;success&#39;</span>
        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">save_mlpav4_mlpav6</span><span class="p">(</span><span class="n">ipv4</span><span class="p">,</span> <span class="n">ipv6</span><span class="p">,</span> <span class="n">customer_channel</span><span class="p">,</span> <span class="n">asn</span><span class="p">,</span> <span class="n">last_ticket</span><span class="p">,</span>
                           <span class="n">tag_v4</span><span class="p">,</span> <span class="n">tag_v6</span><span class="p">,</span> <span class="n">inner_v4</span><span class="p">,</span> <span class="n">inner_v6</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">tag_v4</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Selected tag for IPv4 is already in use. &#39;</span>
        <span class="k">elif</span> <span class="n">tag_v6</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Selected tag for IPv6 is already in use.&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_service_v4</span> <span class="o">=</span> <span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">mlpav4_address</span><span class="o">=</span><span class="n">ipv4</span><span class="p">,</span> <span class="n">customer_channel</span><span class="o">=</span><span class="n">customer_channel</span><span class="p">,</span>
                <span class="n">asn</span><span class="o">=</span><span class="n">asn</span><span class="p">,</span> <span class="n">last_ticket</span><span class="o">=</span><span class="n">last_ticket</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag_v4</span><span class="p">,</span>
                <span class="n">shortname</span><span class="o">=</span><span class="s1">&#39;mlpav4&#39;</span><span class="p">,</span> <span class="n">inner</span><span class="o">=</span><span class="n">inner_v4</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;QUARANTINE&#39;</span><span class="p">)</span>
            <span class="n">new_service_v6</span> <span class="o">=</span> <span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">mlpav6_address</span><span class="o">=</span><span class="n">ipv6</span><span class="p">,</span> <span class="n">customer_channel</span><span class="o">=</span><span class="n">customer_channel</span><span class="p">,</span>
                <span class="n">asn</span><span class="o">=</span><span class="n">asn</span><span class="p">,</span> <span class="n">last_ticket</span><span class="o">=</span><span class="n">last_ticket</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag_v6</span><span class="p">,</span>
                <span class="n">shortname</span><span class="o">=</span><span class="s1">&#39;mlpav6&#39;</span><span class="p">,</span> <span class="n">inner</span><span class="o">=</span><span class="n">inner_v6</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;QUARANTINE&#39;</span><span class="p">)</span>
            <span class="n">tag_v4</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;PRODUCTION&quot;</span>
            <span class="n">tag_v6</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;PRODUCTION&quot;</span>
            <span class="n">tag_v4</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">tag_v6</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">new_service_v4</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">new_service_v6</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;success&#39;</span>
        <span class="k">return</span> <span class="n">message</span>


<div class="viewcode-block" id="AddBilateralFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.AddBilateralFormView">[docs]</a><span class="k">class</span> <span class="nc">AddBilateralFormView</span><span class="p">(</span><span class="n">AjaxableResponseMixin</span><span class="p">,</span> <span class="n">LoginRequiredMixin</span><span class="p">,</span>
                           <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class has, as main objective, redenrize and submit the form to add</span>
<span class="sd">       bilateral service</span>

<span class="sd">    Attributes:</span>
<span class="sd">        context (dic): Dictionary with all information to be printed on the</span>
<span class="sd">            screen</span>
<span class="sd">        form_class (Instance of forms.EditPortPhysicalInterfaceForm):</span>
<span class="sd">            EditPortPhysicalInterfaceForm</span>
<span class="sd">        http_method_names (list): List containing the request types</span>
<span class="sd">        initial (dict): Boot Dictionary, if you need to start a field with a</span>
<span class="sd">            value</span>
<span class="sd">        template_name (str): Name of the template used for this form</span>
<span class="sd">    Returns:</span>
<span class="sd">        If Bilateral service was successfully added to the ASN, it will return</span>
<span class="sd">        a successful message,</span>
<span class="sd">        otherwise it will return a message with the error.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/add_bilateral_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">AddBilateralForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">asn</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>

        <span class="n">customer_channel_object</span> <span class="o">=</span> <span class="n">CustomerChannel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">pk</span><span class="o">=</span><span class="n">channel</span><span class="p">)</span>
        <span class="n">pix_object</span> <span class="o">=</span> <span class="n">PIX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">switch</span><span class="o">=</span><span class="n">Switch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">port</span><span class="o">=</span><span class="n">customer_channel_object</span><span class="o">.</span><span class="n">channel_port</span><span class="o">.</span><span class="n">port_set</span><span class="o">.</span><span class="n">first</span><span class="p">()))</span>

        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;pix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">PIX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="n">pix_object</span><span class="o">.</span><span class="n">ix</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;switch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">Switch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">()</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;origin_channel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;ix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pix_object</span><span class="o">.</span><span class="n">ix</span><span class="o">.</span><span class="n">code</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;customer_channel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> \
            <span class="n">CustomerChannel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">()</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">get_tag_without_all_service</span><span class="p">(</span>
            <span class="n">ix</span><span class="o">=</span><span class="n">pix_object</span><span class="o">.</span><span class="n">ix</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">customer_channel_object</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;tag_a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;tag_b&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;asn&#39;</span><span class="p">:</span> <span class="n">asn</span><span class="p">,</span>
            <span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">ticket</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;last_ticket&#39;</span><span class="p">]</span>
                <span class="n">bilateral_type</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;bilateral_type&#39;</span><span class="p">]</span>
                <span class="n">ix</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;pix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ix</span>

                <span class="c1"># Stuff from peer A</span>
                <span class="n">asn_peer_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;asn&#39;</span><span class="p">]</span>
                <span class="n">channel_a</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;origin_channel&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">channel_a</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">channel_a_object</span> <span class="o">=</span> <span class="n">CustomerChannel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">pk</span><span class="o">=</span><span class="n">channel_a</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">channel_a_object</span> <span class="o">=</span> <span class="n">channel_a</span>
                <span class="n">asn_peer_a_object</span> <span class="o">=</span> <span class="n">ASN</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">asn_peer_a</span><span class="p">)</span>

                <span class="c1"># Stuff from peer B</span>
                <span class="n">asn_peer_b</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;asn&#39;</span><span class="p">]</span>
                <span class="n">channel_b_object</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;customer_channel&#39;</span><span class="p">]</span>
                <span class="n">asn_peer_b_object</span> <span class="o">=</span> <span class="n">ASN</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">asn_peer_b</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

                <span class="n">tag_a</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;tag_a&#39;</span><span class="p">]</span>
                <span class="n">inner_a</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;inner_a&#39;</span><span class="p">]</span>
                <span class="n">tag_b</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;tag_b&#39;</span><span class="p">]</span>
                <span class="n">inner_b</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;inner_b&#39;</span><span class="p">]</span>

                <span class="n">bilateral_case</span> <span class="o">=</span> <span class="n">define_bilateral_case</span><span class="p">(</span>
                    <span class="n">channel_a</span><span class="o">=</span><span class="n">channel_a_object</span><span class="p">,</span>
                    <span class="n">channel_b</span><span class="o">=</span><span class="n">channel_b_object</span><span class="p">)</span>

                <span class="n">bilateral</span> <span class="o">=</span> <span class="n">create_bilateral</span><span class="p">[</span><span class="n">bilateral_case</span><span class="p">](</span>
                    <span class="n">peer_a</span><span class="o">=</span><span class="n">asn_peer_a_object</span><span class="p">,</span>
                    <span class="n">peer_b</span><span class="o">=</span><span class="n">asn_peer_b_object</span><span class="p">,</span>
                    <span class="n">channel_a</span><span class="o">=</span><span class="n">channel_a_object</span><span class="p">,</span>
                    <span class="n">channel_b</span><span class="o">=</span><span class="n">channel_b_object</span><span class="p">,</span>
                    <span class="n">ix</span><span class="o">=</span><span class="n">ix</span><span class="p">,</span>
                    <span class="n">tag_a</span><span class="o">=</span><span class="n">tag_a</span><span class="p">,</span>
                    <span class="n">tag_b</span><span class="o">=</span><span class="n">tag_b</span><span class="p">,</span>
                    <span class="n">inner_b</span><span class="o">=</span><span class="n">inner_b</span><span class="p">,</span>
                    <span class="n">inner_a</span><span class="o">=</span><span class="n">inner_a</span><span class="p">,</span>
                    <span class="n">ticket</span><span class="o">=</span><span class="n">ticket</span><span class="p">,</span>
                    <span class="n">b_type</span><span class="o">=</span><span class="n">bilateral_type</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">bilateral</span><span class="p">:</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Bilateral created&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Something is not right&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ValidationError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="AddBilateralNewChannelFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.AddBilateralNewChannelFormView">[docs]</a><span class="k">class</span> <span class="nc">AddBilateralNewChannelFormView</span><span class="p">(</span>
        <span class="n">AjaxableResponseMixin</span><span class="p">,</span> <span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class has, as main objective, redenrize and submit the form to add</span>
<span class="sd">       bilateral service on an arbitrary channel in a given IX</span>

<span class="sd">    Attributes:</span>
<span class="sd">        context (dic): Dictionary with all information to be printed on the</span>
<span class="sd">            screen</span>
<span class="sd">        form_class (Instance of forms.EditPortPhysicalInterfaceForm):</span>
<span class="sd">            EditPortPhysicalInterfaceForm</span>
<span class="sd">        http_method_names (list): List containing the request types</span>
<span class="sd">        initial (dict): Boot Dictionary, if you need to start a field with a</span>
<span class="sd">            value</span>
<span class="sd">        template_name (str): Name of the template used for this form</span>
<span class="sd">    Returns:</span>
<span class="sd">        If Bilateral service was successfully added to the ASN, it will return</span>
<span class="sd">        a successful message,</span>
<span class="sd">        otherwise it will return a message with the error.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/add_bilateral_new_channel_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">AddBilateralNewChannelForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">asn</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">IX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;origin_pix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">PIX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="n">ix</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;pix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">PIX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="n">ix</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;origin_switch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">Switch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">()</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;switch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">Switch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">()</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;origin_channel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> \
            <span class="n">CustomerChannel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">()</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;ix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;origin_asn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asn</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;customer_channel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> \
            <span class="n">CustomerChannel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">()</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;tag_a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;tag_b&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;asn&#39;</span><span class="p">:</span> <span class="n">asn</span><span class="p">,</span>
            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">AddBilateralFormView</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">)</span></div>


<div class="viewcode-block" id="EditDioPortFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.EditDioPortFormView">[docs]</a><span class="k">class</span> <span class="nc">EditDioPortFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class has, as main objective, redenrize and submit the form to edit</span>
<span class="sd">        a DIO Port.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        form_class (Instance of forms.EditDioPortForm):</span>
<span class="sd">            EditDioPortForm</span>
<span class="sd">        http_method_names (list): List containing the request types</span>
<span class="sd">        initial (dict): Boot Dictionary, if you need to start a field with a</span>
<span class="sd">        value template_name (str): Name of the template used for this form</span>
<span class="sd">    Returns:</span>
<span class="sd">        If association was successfully concluded, it will return a successful</span>
<span class="sd">        message, otherwise it will return a message with the error.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/edit_dio_port_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">EditDioPortForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pix</span><span class="p">,</span> <span class="n">dio_port</span><span class="p">):</span>
        <span class="n">dio_port_object</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">DIOPort</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">dio_port</span><span class="p">)</span>
        <span class="n">pix_object</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">PIX</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pix</span><span class="p">)</span>
        <span class="n">switch_set</span> <span class="o">=</span> <span class="n">pix_object</span><span class="o">.</span><span class="n">switch_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="n">port_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">switch_dict</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">switch</span> <span class="ow">in</span> <span class="n">switch_set</span><span class="p">:</span>
            <span class="n">switch_dict</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">switch</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">switch</span><span class="o">.</span><span class="n">management_ip</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">dio_port_object</span><span class="o">.</span><span class="n">switch_port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">switch_initial</span> <span class="o">=</span> <span class="n">switch_set</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">switch_initial</span> <span class="o">=</span> <span class="n">dio_port_object</span><span class="o">.</span><span class="n">switch_port</span><span class="o">.</span><span class="n">switch</span>

        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>

        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;switch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="n">switch_dict</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;switch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="n">switch_dict</span>

        <span class="n">port_set</span> <span class="o">=</span> <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">switch</span><span class="o">=</span><span class="n">switch_initial</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;AVAILABLE&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">port_set</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">getDioPorts</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">port_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="n">ordered_ports</span> <span class="o">=</span> <span class="n">port_utils</span><span class="o">.</span><span class="n">port_sorting</span><span class="p">(</span><span class="n">port_dict</span><span class="p">)</span>

        <span class="n">port_choices</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ordered_ports</span><span class="p">:</span>
            <span class="n">port_choices</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">ordered_ports</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">key</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;ports&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="n">port_choices</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;switch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">switch_initial</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;ports&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">dio_port_object</span><span class="o">.</span><span class="n">switch_port</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;ix_position&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">dio_port_object</span><span class="o">.</span><span class="n">ix_position</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;dc_position&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">dio_port_object</span><span class="o">.</span> \
            <span class="n">datacenter_position</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;dio_port&#39;</span><span class="p">:</span> <span class="n">dio_port</span><span class="p">,</span>
            <span class="s1">&#39;pix&#39;</span><span class="p">:</span> <span class="n">pix</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">dio_port_object</span> <span class="o">=</span> <span class="n">DIOPort</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dio_port&#39;</span><span class="p">])</span>

                <span class="n">ix_position</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;ix_position&#39;</span><span class="p">]</span>
                <span class="n">dc_position</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;dc_position&#39;</span><span class="p">]</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;ports&#39;</span><span class="p">]</span>
                <span class="n">last_ticket</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;last_ticket&#39;</span><span class="p">]</span>

                <span class="k">if</span><span class="p">(</span><span class="n">dio_port_object</span><span class="o">.</span><span class="n">dio</span><span class="o">.</span><span class="n">validate_unique_ix_position</span><span class="p">(</span>
                        <span class="n">dio_port_object</span><span class="p">,</span> <span class="n">ix_position</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;IX Position already exists&quot;</span><span class="p">)</span>

                <span class="k">if</span><span class="p">(</span><span class="n">dio_port_object</span><span class="o">.</span><span class="n">dio</span><span class="o">.</span><span class="n">validate_unique_dc_position</span><span class="p">(</span>
                        <span class="n">dio_port_object</span><span class="p">,</span> <span class="n">dc_position</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data center Position already exists&quot;</span><span class="p">)</span>

                <span class="n">dio_port_object</span><span class="o">.</span><span class="n">last_ticket</span> <span class="o">=</span> <span class="n">last_ticket</span>
                <span class="n">dio_port_object</span><span class="o">.</span><span class="n">ix_position</span> <span class="o">=</span> <span class="n">ix_position</span>
                <span class="n">dio_port_object</span><span class="o">.</span><span class="n">datacenter_position</span> <span class="o">=</span> <span class="n">dc_position</span>
                <span class="n">dio_port_object</span><span class="o">.</span><span class="n">switch_port</span> <span class="o">=</span> <span class="n">port</span>
                <span class="n">dio_port_object</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;DIO Port saved&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ValidationError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="EditConfiguredCapacityPortFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.EditConfiguredCapacityPortFormView">[docs]</a><span class="k">class</span> <span class="nc">EditConfiguredCapacityPortFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span>
                                         <span class="n">LogsMixin</span><span class="p">,</span>
                                         <span class="n">FormView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class has, as main objective, redenrize and submit the form to</span>
<span class="sd">       edit configured capacity from a given port</span>

<span class="sd">    Attributes:</span>
<span class="sd">        context (dict): Dictionary with all information to be printed on the</span>
<span class="sd">            screen</span>
<span class="sd">        form_class (Instance of forms.EditConfiguredCapacityPort):</span>
<span class="sd">            EditConfiguredCapacityPort</span>
<span class="sd">        http_method_names (list): List containing the request types</span>
<span class="sd">        initial (dict): Boot Dictionary, if you need to start a field with a</span>
<span class="sd">            value</span>
<span class="sd">        template_name (str): Name of the template used for this form</span>
<span class="sd">    Returns:</span>
<span class="sd">        If edition of configured port was successfull, it will return a</span>
<span class="sd">        successful message, otherwise it will return a message with the error.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/edit_port_configured_capacity_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">EditConfiguredCapacityPort</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">port_object</span> <span class="o">=</span> <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;configured_capacity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> \
            <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">capacity</span><span class="p">:</span> <span class="n">capacity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">port_object</span><span class="o">.</span><span class="n">capacity</span><span class="p">,</span>
                   <span class="n">Port</span><span class="o">.</span><span class="n">CAPACITIES</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;configured_capacity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> \
            <span class="n">port_object</span><span class="o">.</span><span class="n">configured_capacity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@updatelastticket</span>
    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">ticket</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;last_ticket&#39;</span><span class="p">]</span>
                <span class="n">configured_capacity</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;configured_capacity&#39;</span><span class="p">]</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">])</span>
                <span class="n">port</span><span class="o">.</span><span class="n">configured_capacity</span> <span class="o">=</span> <span class="n">configured_capacity</span>
                <span class="n">port</span><span class="o">.</span><span class="n">last_ticket</span> <span class="o">=</span> <span class="n">ticket</span>
                <span class="n">port</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Configured Capacity edited &quot;</span>
                                               <span class="s2">&quot;with success&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">form_invalid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<span class="k">class</span> <span class="nc">EditDescriptionByPortFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/edit_description_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">EditDescriptionForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
        <span class="n">port_object</span> <span class="o">=</span> <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>

        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">port_object</span><span class="o">.</span><span class="n">description</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>

                <span class="n">port_object</span> <span class="o">=</span> <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">])</span>
                <span class="n">port_object</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>

                <span class="n">port_object</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Description edited with success&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ValidationError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">form_invalid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;This form is invalid&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">EditTagDescriptionFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/edit_description_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">EditDescriptionForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="n">tag_object</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>

        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">tag_object</span><span class="o">.</span><span class="n">description</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="n">tag</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>

                <span class="n">tag</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">])</span>
                <span class="n">tag</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>

                <span class="n">tag</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Description edited with success&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ValidationError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">form_invalid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;This form is invalid&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>

<div class="viewcode-block" id="MigrateSwitchFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.MigrateSwitchFormView">[docs]</a><span class="k">class</span> <span class="nc">MigrateSwitchFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class has, as main objective, redenrize and submit the form to</span>
<span class="sd">       migrate the switch ports to the new switch.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        context (dict): Dictionary with all information to be printed on the</span>
<span class="sd">            screen</span>
<span class="sd">        form_class (Instance of forms.MigrateSwitchForm):MigrateSwitchForm</span>
<span class="sd">        http_method_names (list): List containing the request types</span>
<span class="sd">        initial (dict): Boot Dictionary, if you need to start a field with a</span>
<span class="sd">            value</span>
<span class="sd">        template_name (str): Name of the template used for this form</span>
<span class="sd">    Returns:</span>
<span class="sd">        If migration of switch was successfull, it will return a</span>
<span class="sd">        successful message, otherwise it will return a message with the error.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/migrate_switch_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">MigrateSwitchForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pix</span><span class="p">):</span>
        <span class="n">pix_object</span> <span class="o">=</span> <span class="n">PIX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">pix</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;switch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">Switch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pix</span><span class="o">=</span><span class="n">pix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;pix&#39;</span><span class="p">:</span> <span class="n">pix_object</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pix</span> <span class="o">=</span> <span class="n">PIX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pix&#39;</span><span class="p">])</span>
            <span class="n">ticket</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;last_ticket&#39;</span><span class="p">]</span>
            <span class="n">switch</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;switch&#39;</span><span class="p">]</span>
            <span class="n">new_model</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;new_model&#39;</span><span class="p">]</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>

            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">new_switch</span> <span class="o">=</span> <span class="n">Switch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">pix</span><span class="o">=</span><span class="n">pix</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">new_model</span><span class="p">,</span>
                    <span class="n">last_ticket</span><span class="o">=</span><span class="n">ticket</span><span class="p">)</span>
                <span class="n">migrate_switch</span><span class="p">(</span><span class="n">switch</span><span class="p">,</span> <span class="n">new_switch</span><span class="p">)</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Switch migrated successfully&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ValidationError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="ReserveIPResourceFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.ReserveIPResourceFormView">[docs]</a><span class="k">class</span> <span class="nc">ReserveIPResourceFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/reserve_ip_resource.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">ReserveIPResourceForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">]</span>
    <span class="c1"># ipv4_free = IPv4Address.objects.filter(Q(reserved=False) &amp; Q(ix__code=ix)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">ix</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">ipv4_free</span> <span class="o">=</span> <span class="n">IPv4Address</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">reserved</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span>
                                               <span class="n">Q</span><span class="p">(</span><span class="n">ix__code</span><span class="o">=</span><span class="n">ix</span><span class="p">))</span>
        <span class="n">ipv6_free</span> <span class="o">=</span> <span class="n">IPv6Address</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">reserved</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span>
                                               <span class="n">Q</span><span class="p">(</span><span class="n">ix__code</span><span class="o">=</span><span class="n">ix</span><span class="p">))</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;IPv4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">ipv4_free</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;IPv6&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">ipv6_free</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;ix&#39;</span><span class="p">:</span> <span class="n">ix</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">ipv4</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;IPv4&#39;</span><span class="p">]</span>
                <span class="n">ipv6</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;IPv6&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">ipv4</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ipv4</span><span class="o">.</span><span class="n">reserve_this</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ipv6</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ipv6</span><span class="o">.</span><span class="n">reserve_this</span><span class="p">()</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;IP Reserved&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_REFERER&#39;</span><span class="p">))</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="ReleaseIPResourceFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.ReleaseIPResourceFormView">[docs]</a><span class="k">class</span> <span class="nc">ReleaseIPResourceFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/release_ip_resource.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">ReleaseIPResourceForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">ix</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">ipv4_free</span> <span class="o">=</span> <span class="n">IPv4Address</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">reserved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span>
                                               <span class="n">Q</span><span class="p">(</span><span class="n">ix__code</span><span class="o">=</span><span class="n">ix</span><span class="p">))</span>
        <span class="n">ipv6_free</span> <span class="o">=</span> <span class="n">IPv6Address</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">reserved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span>
                                               <span class="n">Q</span><span class="p">(</span><span class="n">ix__code</span><span class="o">=</span><span class="n">ix</span><span class="p">))</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;IPv4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">ipv4_free</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;IPv6&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">ipv6_free</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;ix&#39;</span><span class="p">:</span> <span class="n">ix</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">ipv4</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;IPv4&#39;</span><span class="p">]</span>
                <span class="n">ipv6</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;IPv6&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">ipv4</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ipv4</span><span class="o">.</span><span class="n">free_this</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ipv6</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ipv6</span><span class="o">.</span><span class="n">free_this</span><span class="p">()</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;IP Released&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_REFERER&#39;</span><span class="p">))</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="ReservePortResourceFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.ReservePortResourceFormView">[docs]</a><span class="k">class</span> <span class="nc">ReservePortResourceFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/reserve_port_resource.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">ReservePortResourceForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">sw</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">ports_to_reserve</span> <span class="o">=</span> <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">switch_id</span><span class="o">=</span><span class="n">sw</span><span class="p">)</span> <span class="o">&amp;</span>
                                               <span class="n">Q</span><span class="p">(</span><span class="n">reserved</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;ports_to_reserve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">ports_to_reserve</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;sw&#39;</span><span class="p">:</span> <span class="n">sw</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">ports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;ports_to_reserve&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
                    <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Port</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">port</span><span class="p">)</span><span class="o">.</span><span class="n">reserve_this</span><span class="p">()</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Port(s) Reserved&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="ReleasePortResourceFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.ReleasePortResourceFormView">[docs]</a><span class="k">class</span> <span class="nc">ReleasePortResourceFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/release_port_resource.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">ReleasePortResourceForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">sw</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">ports_to_release</span> <span class="o">=</span> <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">switch_id</span><span class="o">=</span><span class="n">sw</span><span class="p">)</span> <span class="o">&amp;</span>
                                               <span class="n">Q</span><span class="p">(</span><span class="n">reserved</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;ports_to_release&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">ports_to_release</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;sw&#39;</span><span class="p">:</span> <span class="n">sw</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">ports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;ports_to_release&#39;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
                    <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Port</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">port</span><span class="p">)</span><span class="o">.</span><span class="n">free_this</span><span class="p">()</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Port(s) Released&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="ReserveTagResourceFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.ReserveTagResourceFormView">[docs]</a><span class="k">class</span> <span class="nc">ReserveTagResourceFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/reserve_tag_resource.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">ReserveTagResourceForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">ix</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">tag_to_reserve</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">ix_id</span><span class="o">=</span><span class="n">ix</span><span class="p">)</span> <span class="o">&amp;</span>
                                            <span class="n">Q</span><span class="p">(</span><span class="n">reserved</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;tag_to_reserve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">tag_to_reserve</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;ix&#39;</span><span class="p">:</span> <span class="n">ix</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;tag_to_reserve&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tag</span><span class="o">.</span><span class="n">reserve_this</span><span class="p">()</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Tag Reserved&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_REFERER&#39;</span><span class="p">))</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="ReleaseTagResourceFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.ReleaseTagResourceFormView">[docs]</a><span class="k">class</span> <span class="nc">ReleaseTagResourceFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/release_tag_resource.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">ReleaseTagResourceForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">ix</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">tag_to_release</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">ix_id</span><span class="o">=</span><span class="n">ix</span><span class="p">)</span> <span class="o">&amp;</span>
                                            <span class="n">Q</span><span class="p">(</span><span class="n">reserved</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;tag_to_release&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">tag_to_release</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;ix&#39;</span><span class="p">:</span> <span class="n">ix</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;tag_to_release&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tag</span><span class="o">.</span><span class="n">free_this</span><span class="p">()</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Tag Released&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_REFERER&#39;</span><span class="p">))</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="CreateSwitchFormView"><a class="viewcode-back" href="../../../../docstring.html#ixbr_api.core.views.form_views.CreateSwitchFormView">[docs]</a><span class="k">class</span> <span class="nc">CreateSwitchFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LogsMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This class has, as main objective, redenrize and submit the form to</span>
<span class="sd">       edit a port channel</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/create_switch_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">CreateSwitchForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pix</span><span class="p">):</span>

        <span class="n">pix_object</span> <span class="o">=</span> <span class="n">PIX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">pix</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">SwitchModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;pix&#39;</span><span class="p">:</span> <span class="n">pix_object</span><span class="p">,</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pix</span> <span class="o">=</span> <span class="n">PIX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pix&#39;</span><span class="p">])</span>
            <span class="n">ticket</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;last_ticket&#39;</span><span class="p">]</span>
            <span class="n">mgmt_ip</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;mgmt_ip&#39;</span><span class="p">]</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
            <span class="n">is_pe</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;is_pe&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">ip_address</span><span class="p">(</span><span class="n">mgmt_ip</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ip_network</span><span class="p">(</span><span class="s1">&#39;192.168.16.0/26&#39;</span><span class="p">):</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;IP Address must belong to &quot;</span>
                                               <span class="s2">&quot;network management&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>

            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">Switch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">pix</span><span class="o">=</span><span class="n">pix</span><span class="p">,</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                    <span class="n">management_ip</span><span class="o">=</span><span class="n">mgmt_ip</span><span class="p">,</span>
                    <span class="n">create_ports</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">is_pe</span><span class="o">=</span><span class="n">is_pe</span><span class="p">,</span>
                    <span class="n">last_ticket</span><span class="o">=</span><span class="n">ticket</span>
                <span class="p">)</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Switch created successfully&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span></div>


<span class="k">class</span> <span class="nc">AddNewSwitchModuleFormView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;forms/add_switch_module_form.html&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">AddSwitchModuleForm</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">switch</span><span class="p">):</span>

        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;switch&#39;</span><span class="p">:</span> <span class="n">switch</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@ixapilog</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="n">switch</span> <span class="o">=</span> <span class="n">Switch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;switch&#39;</span><span class="p">])</span>
                <span class="n">ticket</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;last_ticket&#39;</span><span class="p">]</span>
                <span class="n">capacity</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;capacity&#39;</span><span class="p">]</span>
                <span class="n">connector</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;connector_type&#39;</span><span class="p">]</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;name_format&#39;</span><span class="p">]</span>
                <span class="n">begin</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;begin&#39;</span><span class="p">]</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
                <span class="n">vendor</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;vendor&#39;</span><span class="p">]</span>

                <span class="n">create_port_range_switch_module_use_case</span><span class="p">(</span>
                    <span class="n">ticket</span><span class="o">=</span><span class="n">ticket</span><span class="p">,</span>
                    <span class="n">switch</span><span class="o">=</span><span class="n">switch</span><span class="p">,</span>
                    <span class="n">vendor</span><span class="o">=</span><span class="n">vendor</span><span class="p">,</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">capacity</span><span class="o">=</span><span class="n">capacity</span><span class="p">,</span>
                    <span class="n">connector</span><span class="o">=</span><span class="n">connector</span><span class="p">,</span>
                    <span class="n">name_format</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">begin</span><span class="o">=</span><span class="n">begin</span><span class="p">,</span>
                    <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Module associated&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>


        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">IX.br API 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, NIC.br.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.1.
    </div>
  </body>
</html>