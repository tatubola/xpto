<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ixbr_api.core.models &#8212; IX.br API 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">IX.br API 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ixbr_api.core.models</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">difflib</span> <span class="k">import</span> <span class="n">SequenceMatcher</span>
<span class="kn">from</span> <span class="nn">logging</span> <span class="k">import</span> <span class="n">WARN</span>

<span class="kn">import</span> <span class="nn">ipaddress</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="k">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">django.core.validators</span> <span class="k">import</span> <span class="p">(</span><span class="n">MaxLengthValidator</span><span class="p">,</span> <span class="n">MaxValueValidator</span><span class="p">,</span>
                                    <span class="n">MinLengthValidator</span><span class="p">,</span> <span class="n">MinValueValidator</span><span class="p">,</span>
                                    <span class="n">validate_email</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="k">import</span> <span class="n">Q</span>
<span class="kn">from</span> <span class="nn">django.db.models.query</span> <span class="k">import</span> <span class="n">QuerySet</span>
<span class="kn">from</span> <span class="nn">django.db.models.signals</span> <span class="k">import</span> <span class="n">post_delete</span><span class="p">,</span> <span class="n">post_save</span>
<span class="kn">from</span> <span class="nn">django.dispatch</span> <span class="k">import</span> <span class="n">receiver</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="k">import</span> <span class="n">gettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">ixbr_api.users.models</span> <span class="k">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">model_utils.models</span> <span class="k">import</span> <span class="n">TimeStampedModel</span>
<span class="kn">from</span> <span class="nn">simple_history.models</span> <span class="k">import</span> <span class="n">HistoricalRecords</span>

<span class="kn">from</span> <span class="nn">.use_cases.mac_address_converter_to_system_pattern</span> <span class="k">import</span> \
    <span class="n">MACAddressConverterToSystemPattern</span>
<span class="kn">from</span> <span class="nn">.utils.constants</span> <span class="k">import</span> <span class="p">(</span><span class="n">MAX_TAG_NUMBER</span><span class="p">,</span> <span class="n">MIN_TAG_NUMBER</span><span class="p">,</span>
                              <span class="n">PHYSICAL_INTERFACE_PORT_CONNECTOR_TYPE</span><span class="p">,</span>
                              <span class="n">PORT_CAPACITY_CONNECTOR_TYPE</span><span class="p">,</span>
                              <span class="n">PORT_TYPE_CONNECTOR_TYPE</span><span class="p">,</span>
                              <span class="n">SWITCH_MODEL_CHANNEL_PREFIX</span><span class="p">,</span> <span class="n">VENDORS</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.utils.globals</span> <span class="k">import</span> <span class="n">get_current_user</span>
<span class="kn">from</span> <span class="nn">.utils.logging_handlers</span> <span class="k">import</span> <span class="n">log_object</span>
<span class="kn">from</span> <span class="nn">.utils.port_utils</span> <span class="k">import</span> <span class="n">port_sorting</span>
<span class="kn">from</span> <span class="nn">.validators</span> <span class="k">import</span> <span class="p">(</span><span class="n">validate_as_number</span><span class="p">,</span> <span class="n">validate_channel_name</span><span class="p">,</span>
                         <span class="n">validate_cnpj</span><span class="p">,</span> <span class="n">validate_ipv4_network</span><span class="p">,</span>
                         <span class="n">validate_ipv6_network</span><span class="p">,</span> <span class="n">validate_ix_code</span><span class="p">,</span>
                         <span class="n">validate_ix_fullname</span><span class="p">,</span> <span class="n">validate_ix_shortname</span><span class="p">,</span>
                         <span class="n">validate_mac_address</span><span class="p">,</span> <span class="n">validate_name_format</span><span class="p">,</span>
                         <span class="n">validate_pix_code</span><span class="p">,</span> <span class="n">validate_switch_model</span><span class="p">,</span>
                         <span class="n">validate_url_format</span><span class="p">)</span>


<div class="viewcode-block" id="IXAPIQuerySet"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.IXAPIQuerySet">[docs]</a><span class="k">class</span> <span class="nc">IXAPIQuerySet</span><span class="p">(</span><span class="n">QuerySet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a method to QuerySet class to handle Error when object does not exist.</span>
<span class="sd">    Method get_or_none can be used to return a NONE when a querie is issued</span>
<span class="sd">    and the given object does not exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get_or_none</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="HistoricalTimeStampedModel"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.HistoricalTimeStampedModel">[docs]</a><span class="k">class</span> <span class="nc">HistoricalTimeStampedModel</span><span class="p">(</span><span class="n">TimeStampedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An abstract base class model to track which user modified and</span>
<span class="sd">    stores the history related to model data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">modified_by</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">)</span>
    <span class="n">history</span> <span class="o">=</span> <span class="n">HistoricalRecords</span><span class="p">(</span><span class="n">inherit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">last_ticket</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">()</span>
    <span class="n">uuid</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UUIDField</span><span class="p">(</span>
        <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">IXAPIQuerySet</span><span class="o">.</span><span class="n">as_manager</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">get_latest_by</span> <span class="o">=</span> <span class="s1">&#39;modified_date&#39;</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="s1">&#39;modified_date&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_history_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">modified_by</span>

    <span class="nd">@_history_user</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">_history_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modified_by</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># When use clean() method, remember that order matters,</span>
    <span class="c1"># for error messages and dealing with database.</span>
    <span class="c1"># Use block_update_pk() then block_update_fields() and</span>
    <span class="c1"># others validation.</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">resource_is_reservable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;is_reserved&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">log_object</span><span class="p">(</span><span class="s2">&quot;Object updated&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">modified_by</span> <span class="o">=</span> <span class="n">get_current_user</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_is_reservable</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_reserved</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s1">&#39;This resource is Reserved&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">modified_by</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modified_by</span><span class="p">,</span> <span class="n">User</span><span class="p">):</span>
            <span class="n">log_object</span><span class="p">(</span><span class="s2">&quot;Could not get user that modified object&quot;</span><span class="p">,</span>
                       <span class="bp">self</span><span class="p">,</span>
                       <span class="n">severity</span><span class="o">=</span><span class="n">WARN</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modified_by</span> <span class="o">=</span> <span class="n">modified_by</span>
        <span class="c1"># Call clean validations before save.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_clean</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_is_reservable</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_reserved</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s1">&#39;This resource is Reserved&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Block pk field update</span>
    <span class="k">def</span> <span class="nf">block_update_pk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">adding</span> <span class="ow">and</span>
           <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s1">&#39;Trying to update non updatable field: </span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>

    <span class="c1"># Block field update passed as arg</span>
    <span class="k">def</span> <span class="nf">block_update_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_field</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">):</span>
            <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">block_field</span><span class="p">]</span> <span class="o">!=</span> <span class="n">old</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">block_field</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="p">(</span><span class="s1">&#39;Trying to update non updatable field: </span><span class="si">{0}</span><span class="s1">.</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">block_field</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span></div>


<div class="viewcode-block" id="ReservableModel"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.ReservableModel">[docs]</a><span class="k">class</span> <span class="nc">ReservableModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class is used to implement Resource Reservation for some models</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">reserved</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="ReservableModel.reserve_this"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.ReservableModel.reserve_this">[docs]</a>    <span class="k">def</span> <span class="nf">reserve_this</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This method reserves the resource</span>

<span class="sd">        Returns: True if the resource was free and the reservation occurred</span>
<span class="sd">        successfully or False if the resource was alredy reserved.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserved</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">full_clean</span><span class="p">()</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="ReservableModel.free_this"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.ReservableModel.free_this">[docs]</a>    <span class="k">def</span> <span class="nf">free_this</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This method free the resource</span>

<span class="sd">        Returns: True if the resource was reserved and freeing the resource</span>
<span class="sd">        occurred successfully or False if the resource was already free</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserved</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">full_clean</span><span class="p">()</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_reserved</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the reservation status of a resource</span>

<span class="sd">        Returns: True if the resource is reserved or False otherwise</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserved</span></div>


<div class="viewcode-block" id="ASN"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.ASN">[docs]</a><span class="k">class</span> <span class="nc">ASN</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Autonomous System (AS) Number representation.&quot;&quot;&quot;</span>
    <span class="n">uuid</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">number</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BigIntegerField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_as_number</span><span class="p">])</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;number&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;ASN&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;ASNs&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ContactsMap</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">asn</span><span class="o">=</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;[AS</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">ContactsMap</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">asn</span><span class="o">=</span><span class="bp">self</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">organization</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;[AS</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_pk</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_stats_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ix</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;mlpav4_amount&quot;</span><span class="p">:</span> <span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">asn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                                                       <span class="n">tag__ix</span><span class="o">=</span><span class="n">ix</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
                <span class="s2">&quot;mlpav6_amount&quot;</span><span class="p">:</span> <span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">asn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">tag__ix</span><span class="o">=</span><span class="n">ix</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
                <span class="s2">&quot;bilateral_amount&quot;</span><span class="p">:</span> <span class="n">BilateralPeer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">asn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">tag__ix</span><span class="o">=</span><span class="n">ix</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()}</span></div>


<div class="viewcode-block" id="Bilateral"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.Bilateral">[docs]</a><span class="k">class</span> <span class="nc">Bilateral</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bilateral peers&#39; pair.&quot;&quot;&quot;</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">BILATERAL_TYPES</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;L2&#39;</span><span class="p">,</span> <span class="s1">&#39;L2&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;VPWS&#39;</span><span class="p">,</span> <span class="s1">&#39;VPWS&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;VXLAN&#39;</span><span class="p">,</span> <span class="s1">&#39;VXLAN&#39;</span><span class="p">),)</span>
    <span class="n">bilateral_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">BILATERAL_TYPES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;L2&#39;</span><span class="p">)</span>
    <span class="n">peer_a</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span>
        <span class="s1">&#39;BilateralPeer&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;peer_a_related&#39;</span><span class="p">)</span>
    <span class="n">peer_b</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span>
        <span class="s1">&#39;BilateralPeer&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;peer_b_related&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Bilateral&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Bilaterals&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">: AS</span><span class="si">%s</span><span class="s2">-AS</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">peer_a</span><span class="o">.</span><span class="n">asn</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">peer_b</span><span class="o">.</span><span class="n">asn</span><span class="o">.</span><span class="n">number</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">validate_different_peers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">peer_a</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">peer_b</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Peer a and Peer b must be different.&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">validate_label_by_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bilateral_type</span> <span class="o">==</span> <span class="s1">&#39;VPWS&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">i_label</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i_label</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;VPWS Bilateral</span><span class="se">\&#39;</span><span class="s1">s label must be &#39;</span>
                                            <span class="s1">&#39;a 64bits number&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;VPWS Bilateral</span><span class="se">\&#39;</span><span class="s1">s label must be a &#39;</span>
                                        <span class="s1">&#39;64bits number&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bilateral_type</span> <span class="o">==</span> <span class="s1">&#39;VXLAN&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">i_label</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i_label</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;VXLAN Bilateral</span><span class="se">\&#39;</span><span class="s1">s label must be &#39;</span>
                                            <span class="s1">&#39;a 24bits number&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;VXLAN Bilateral</span><span class="se">\&#39;</span><span class="s1">s label must be a &#39;</span>
                                        <span class="s1">&#39;24bits number&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;peer_a_id&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;peer_b_id&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_different_peers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_label_by_type</span><span class="p">()</span></div>


<div class="viewcode-block" id="Channel"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.Channel">[docs]</a><span class="k">class</span> <span class="nc">Channel</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Network switch channel representation.&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">is_lag</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">()</span>
    <span class="n">is_mclag</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">()</span>
    <span class="n">channel_port</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span><span class="s1">&#39;ChannelPort&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Remember to put this line in derived classes</span>
        <span class="c1"># ordering = (&#39;name&#39;,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Channel&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Channels&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_ports_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_mclag</span> <span class="ow">and</span>
           <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">channel_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_port</span><span class="p">)):</span>
            <span class="n">switch_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">channel_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_port</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;switch&#39;</span><span class="p">,</span>
                                                            <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">switch_count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Switch is not the same in ports of this Channel.&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_mclag</span><span class="p">:</span>
            <span class="n">ix</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">channel_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_port</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ix</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">pix</span><span class="o">.</span><span class="n">ix</span>
                <span class="k">elif</span> <span class="n">port</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">pix</span><span class="o">.</span><span class="n">ix</span> <span class="o">!=</span> <span class="n">ix</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                        <span class="n">_</span><span class="p">(</span><span class="s1">&#39;IX is not the same in Switches of ports on this &#39;</span>
                          <span class="s1">&#39;Channel.&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_port</span><span class="o">.</span><span class="n">port_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_switches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">switches</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">port</span><span class="o">.</span><span class="n">switch</span> <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ports</span><span class="p">()])</span>
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
            <span class="n">switches</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">switches</span>

    <span class="k">def</span> <span class="nf">is_extreme</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vendors</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">switch</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">vendor</span> <span class="k">for</span> <span class="n">switch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_switches</span><span class="p">()]</span>
        <span class="k">if</span> <span class="s1">&#39;EXTREME&#39;</span> <span class="ow">in</span> <span class="n">vendors</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">check_channel_name_port</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_extreme</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ports</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> master port has nos association with him&quot;</span><span class="o">.</span>
                               <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_master_port</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_extreme</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_channel_name_port</span><span class="p">():</span>
            <span class="n">master_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">master_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ports</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">master_number</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">master_port</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ports</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;channel_port_id&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_ports_channel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_channel_name_port</span><span class="p">()</span>
        <span class="n">validate_channel_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lag</span> <span class="o">=</span> <span class="s1">&#39;L&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_lag</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">%s%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_channel_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_channels_of_switch</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">switch</span><span class="p">):</span>
        <span class="n">channel_class</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_channel_class</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">channel_class</span> <span class="o">==</span> <span class="n">Channel</span><span class="p">:</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">channels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">CustomerChannel</span><span class="o">.</span><span class="n">get_channels_of_switch</span><span class="p">(</span><span class="n">switch</span><span class="p">))</span>
            <span class="n">channels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">DownlinkChannel</span><span class="o">.</span><span class="n">get_channels_of_switch</span><span class="p">(</span><span class="n">switch</span><span class="p">))</span>
            <span class="n">channels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">UplinkChannel</span><span class="o">.</span><span class="n">get_channels_of_switch</span><span class="p">(</span><span class="n">switch</span><span class="p">))</span>
            <span class="n">channels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">TranslationChannel</span><span class="o">.</span><span class="n">get_channels_of_switch</span><span class="p">(</span><span class="n">switch</span><span class="p">))</span>
            <span class="n">channels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">CoreChannel</span><span class="o">.</span><span class="n">get_channels_of_switch</span><span class="p">(</span><span class="n">switch</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">channels</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_channel_class</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">channel_port__port__switch</span><span class="o">=</span><span class="n">switch</span><span class="p">))</span></div>


<div class="viewcode-block" id="ChannelPort"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.ChannelPort">[docs]</a><span class="k">class</span> <span class="nc">ChannelPort</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Model to relate a channel to a set of ports.&quot;&quot;&quot;</span>

    <span class="n">TAG_TYPES</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;Direct-Bundle-Ether&#39;</span><span class="p">,</span> <span class="s2">&quot;Direct-Bundle-Ether&quot;</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;Indirect-Bundle-Ether&#39;</span><span class="p">,</span> <span class="s2">&quot;Indirect-Bundle-Ether&quot;</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;Port-Specific&#39;</span><span class="p">,</span> <span class="s2">&quot;Port-Specific&quot;</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;Core&#39;</span><span class="p">,</span> <span class="s2">&quot;Core&quot;</span><span class="p">),)</span>
    <span class="n">tags_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">TAG_TYPES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;Direct-Bundle-Ether&#39;</span><span class="p">)</span>
    <span class="n">create_tags</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;ChannelPort&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;ChannelPorts&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="p">)</span></div>


<div class="viewcode-block" id="Contact"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.Contact">[docs]</a><span class="k">class</span> <span class="nc">Contact</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Organization contact representation.&quot;&quot;&quot;</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_email</span><span class="p">])</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Contact&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Contacts&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ContactsMap"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.ContactsMap">[docs]</a><span class="k">class</span> <span class="nc">ContactsMap</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">):</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;IX&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">)</span>
    <span class="n">organization</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Organization&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">)</span>
    <span class="n">asn</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;ASN&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span>
                            <span class="n">verbose_name</span><span class="o">=</span><span class="n">ASN</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">verbose_name</span><span class="p">)</span>
    <span class="n">noc_contact</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="s1">&#39;Contact&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;noc_related&#39;</span><span class="p">)</span>
    <span class="n">adm_contact</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="s1">&#39;Contact&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;adm_related&#39;</span><span class="p">)</span>
    <span class="n">peer_contact</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="s1">&#39;Contact&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;peer_related&#39;</span><span class="p">)</span>
    <span class="n">com_contact</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="s1">&#39;Contact&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;com_related&#39;</span><span class="p">)</span>
    <span class="n">org_contact</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="s1">&#39;Contact&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;org_related&#39;</span><span class="p">)</span>
    <span class="n">peering_url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_url_format</span><span class="p">])</span>

    <span class="n">POLICIES</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;OPEN&#39;</span><span class="p">,</span> <span class="s1">&#39;All peering accepted&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;CASE-BY-CASE&#39;</span><span class="p">,</span> <span class="s1">&#39;Peer decide case by case&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;SELECTIVE&#39;</span><span class="p">,</span> <span class="s1">&#39;Peer in ATM but in selective perspective&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;CLOSED&#39;</span><span class="p">,</span> <span class="s1">&#39;Only Bilateral&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;CUSTOM&#39;</span><span class="p">,</span> <span class="s1">&#39;Peer in ATM but Bilateral selective&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;ROUTE-SERVER-ONLY&#39;</span><span class="p">,</span> <span class="s1">&#39;Just receive routes&#39;</span><span class="p">),</span> <span class="p">)</span>
    <span class="n">peering_policy</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">POLICIES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;OPEN&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;organization&#39;</span><span class="p">,</span> <span class="s1">&#39;asn&#39;</span><span class="p">,</span> <span class="s1">&#39;ix&#39;</span><span class="p">),)</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;asn&#39;</span><span class="p">,</span> <span class="s1">&#39;ix&#39;</span><span class="p">,</span> <span class="p">)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;ContactsMap&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;ContactsMaps&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;[AS</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">asn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">peer_contact</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;ix_id&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DIO"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.DIO">[docs]</a><span class="k">class</span> <span class="nc">DIO</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;DIO representation.&quot;&quot;&quot;</span>
    <span class="n">pix</span> <span class="o">=</span> \
        <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;PIX&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
                            <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MinLengthValidator</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
                                        <span class="n">MaxLengthValidator</span><span class="p">(</span><span class="mi">255</span><span class="p">)])</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;pix&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">),)</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;pix&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;DIO&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;DIOs&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;[PIX </span><span class="si">%s</span><span class="s2">: DIO </span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pix</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;pix_id&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_unique_ix_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dio_port</span><span class="p">,</span> <span class="n">ix_position</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dioport_set</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">dio_port</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">ix_position</span><span class="o">=</span><span class="n">ix_position</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">validate_unique_dc_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dio_port</span><span class="p">,</span> <span class="n">dc_position</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dioport_set</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">dio_port</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">datacenter_position</span><span class="o">=</span><span class="n">dc_position</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="DIOPort"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.DIOPort">[docs]</a><span class="k">class</span> <span class="nc">DIOPort</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;DIO port representation.&quot;&quot;&quot;</span>
    <span class="n">dio</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;DIO&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">ix_position</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
                                   <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MinLengthValidator</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
                                               <span class="n">MaxLengthValidator</span><span class="p">(</span><span class="mi">255</span><span class="p">)])</span>

    <span class="n">datacenter_position</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MinLengthValidator</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
                                                <span class="n">MaxLengthValidator</span><span class="p">(</span><span class="mi">255</span><span class="p">)])</span>
    <span class="n">switch_port</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Port&#39;</span><span class="p">,</span>
                                    <span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span><span class="p">,</span>
                                    <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># revisar</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;dio&#39;</span><span class="p">,</span> <span class="s1">&#39;ix_position&#39;</span><span class="p">,</span> <span class="s1">&#39;datacenter_position&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;switch_port&#39;</span><span class="p">,)</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;dio&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;DIOPort&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;DIOPorts&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;[DIO </span><span class="si">%s</span><span class="s2">: POS </span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dio</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">datacenter_position</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;dio_id&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="IPv4Address"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.IPv4Address">[docs]</a><span class="k">class</span> <span class="nc">IPv4Address</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">,</span> <span class="n">ReservableModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Global IPv4 address to be used in IX&#39; services.&quot;&quot;&quot;</span>
    <span class="n">uuid</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;IX&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">GenericIPAddressField</span><span class="p">(</span>
        <span class="s1">&#39;IPv4&#39;</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_ipv4_network</span><span class="p">])</span>
    <span class="n">reverse_dns</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_url_format</span><span class="p">])</span>
    <span class="n">in_lg</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;address&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;IPv4Address&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;IPv4Addresses&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lg</span> <span class="o">=</span> <span class="s1">&#39;L&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_lg</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">%s%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">lg</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_pk</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">mlpav4_address</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span> <span class="ow">or</span>
           <span class="n">Monitorv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">monitor_address</span><span class="o">=</span><span class="bp">self</span><span class="p">)):</span>
            <span class="k">return</span> <span class="s1">&#39;ALLOCATED&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;FREE&#39;</span></div>


<div class="viewcode-block" id="IPv6Address"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.IPv6Address">[docs]</a><span class="k">class</span> <span class="nc">IPv6Address</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">,</span> <span class="n">ReservableModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Global IPv6 address to be used in IX&#39; services.&quot;&quot;&quot;</span>
    <span class="n">uuid</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;IX&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">GenericIPAddressField</span><span class="p">(</span>
        <span class="s1">&#39;IPv6&#39;</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_ipv6_network</span><span class="p">])</span>
    <span class="n">reverse_dns</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_url_format</span><span class="p">])</span>
    <span class="n">in_lg</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;address&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;IPv6Address&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;IPv6Addresses&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lg</span> <span class="o">=</span> <span class="s1">&#39;L&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_lg</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">%s%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">lg</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_pk</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">mlpav6_address</span><span class="o">=</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;ALLOCATED&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;FREE&#39;</span></div>


<div class="viewcode-block" id="IX"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.IX">[docs]</a><span class="k">class</span> <span class="nc">IX</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internet Exchange (IX) site representation.&quot;&quot;&quot;</span>

    <span class="n">TAGS_POLICIES</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;ix_managed&#39;</span><span class="p">,</span> <span class="s2">&quot;IX_managed&quot;</span><span class="p">),</span>
                     <span class="p">(</span><span class="s1">&#39;distributed&#39;</span><span class="p">,</span> <span class="s2">&quot;Distributed&quot;</span><span class="p">),)</span>
    <span class="n">uuid</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MinLengthValidator</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                                        <span class="n">MaxLengthValidator</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
                                        <span class="n">validate_ix_code</span><span class="p">])</span>
    <span class="n">shortname</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span>
                                 <span class="n">validate_ix_shortname</span><span class="p">])</span>
    <span class="n">fullname</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_ix_fullname</span><span class="p">])</span>
    <span class="n">ipv4_prefix</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_ipv4_network</span><span class="p">])</span>
    <span class="n">ipv6_prefix</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">43</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_ipv6_network</span><span class="p">])</span>
    <span class="n">management_prefix</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_ipv4_network</span><span class="p">])</span>
    <span class="n">create_ips</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">create_tags</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">tags_policy</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">TAGS_POLICIES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;Bundle-Ether&#39;</span><span class="p">)</span>
    <span class="n">prefix_update</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;IX&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;IXs&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_original_ipv4_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipv4_prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_ipv6_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipv6_prefix</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">get_ipv4_network</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ipv4_prefix</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_ipv6_network</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ipv6_prefix</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_mgmt_network</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">management_prefix</span><span class="p">),</span>
                      <span class="n">ipaddress</span><span class="o">.</span><span class="n">IPv4Network</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">management_prefix</span><span class="p">)</span><span class="o">.</span><span class="n">is_private</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not a private network&quot;</span><span class="o">.</span>
                                        <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">management_prefix</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not a IPv4 network&quot;</span><span class="o">.</span>
                                    <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">management_prefix</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">validate_ip_network_intersect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current_v4</span> <span class="o">=</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ipv4_prefix</span><span class="p">)</span>
        <span class="n">current_v6</span> <span class="o">=</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ipv6_prefix</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">IX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">ix</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">other_v4</span> <span class="o">=</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="n">ix</span><span class="o">.</span><span class="n">ipv4_prefix</span><span class="p">)</span>
            <span class="n">other_v6</span> <span class="o">=</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="n">ix</span><span class="o">.</span><span class="n">ipv6_prefix</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">current_v4</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">other_v4</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> overlaps with </span><span class="si">{}</span><span class="s2"> from IX: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span>
                                        <span class="nb">format</span><span class="p">(</span><span class="n">current_v4</span><span class="p">,</span> <span class="n">other_v4</span><span class="p">,</span> <span class="n">ix</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">current_v6</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">other_v6</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> overlaps with </span><span class="si">{}</span><span class="s2"> from IX: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span>
                                        <span class="nb">format</span><span class="p">(</span><span class="n">current_v6</span><span class="p">,</span> <span class="n">other_v6</span><span class="p">,</span> <span class="n">ix</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_pk</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_mgmt_network</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_ip_network_intersect</span><span class="p">()</span>

<div class="viewcode-block" id="IX.create_ipv4"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.IX.create_ipv4">[docs]</a>    <span class="k">def</span> <span class="nf">create_ipv4</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_addresses</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create all IPv4Addresses that belong to this IX IPv4 prefix.</span>
<span class="sd">        Raises ValueError if one of those IPs already exist and is assigned</span>
<span class="sd">        to another IX.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ipv4_network</span><span class="p">()</span>
        <span class="n">old_prefix</span> <span class="o">=</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_original_ipv4_prefix</span><span class="p">)</span>

        <span class="n">expansion</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">old_prefix</span><span class="p">)</span> <span class="ow">and</span> <span class="n">prefix</span> <span class="o">&lt;</span> <span class="n">old_prefix</span>

        <span class="k">if</span> <span class="n">expansion</span><span class="p">:</span>
            <span class="n">new_addresses</span> <span class="o">=</span> <span class="p">(</span><span class="n">ip</span> <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">prefix</span><span class="o">.</span><span class="n">hosts</span><span class="p">()</span>
                             <span class="k">if</span> <span class="n">ip</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">old_prefix</span><span class="o">.</span><span class="n">hosts</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">new_addresses</span><span class="p">:</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="n">IPv4Address</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span> <span class="n">ix</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_lg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                 <span class="n">last_ticket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">last_ticket</span><span class="p">,</span>
                                 <span class="n">modified_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modified_by</span><span class="p">)</span>
                <span class="n">ip</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">difference</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">network_address</span><span class="p">)</span> <span class="o">-</span> \
                         <span class="nb">int</span><span class="p">(</span><span class="n">old_prefix</span><span class="o">.</span><span class="n">network_address</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">old_addresses</span><span class="p">:</span>
                <span class="n">ip_address</span> <span class="o">=</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_address</span><span class="p">(</span><span class="n">address</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>

                <span class="n">address</span> <span class="o">=</span> <span class="n">IPv4Address</span><span class="p">(</span>
                    <span class="n">address</span><span class="o">=</span><span class="n">ip_address</span> <span class="o">+</span> <span class="n">difference</span><span class="p">,</span>
                    <span class="n">ix</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">reverse_dns</span><span class="o">=</span><span class="n">address</span><span class="o">.</span><span class="n">reverse_dns</span><span class="p">,</span>
                    <span class="n">in_lg</span><span class="o">=</span><span class="n">address</span><span class="o">.</span><span class="n">in_lg</span><span class="p">,</span>
                    <span class="n">last_ticket</span><span class="o">=</span><span class="n">address</span><span class="o">.</span><span class="n">last_ticket</span><span class="p">,</span>
                    <span class="n">modified_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modified_by</span><span class="p">)</span>
                <span class="n">address</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="c1"># If the new prefix is bigger, create the remaining addresses</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">hosts</span><span class="p">())[</span><span class="nb">len</span><span class="p">(</span><span class="n">old_addresses</span><span class="p">):]</span>
            <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">remaining</span><span class="p">:</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="n">IPv4Address</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span> <span class="n">ix</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_lg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                 <span class="n">last_ticket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">last_ticket</span><span class="p">,</span>
                                 <span class="n">modified_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modified_by</span><span class="p">)</span>
                <span class="n">ip</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>

<div class="viewcode-block" id="IX.map_new_address_ipv4"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.IX.map_new_address_ipv4">[docs]</a>    <span class="k">def</span> <span class="nf">map_new_address_ipv4</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">services</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change address of services to match new prefix. If the new prefix</span>
<span class="sd">        contains the old one, no alteration is made. Else, the new address of a</span>
<span class="sd">        given service is calculated by keeping the same offset from the old</span>
<span class="sd">        prefix.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ipv4_network</span><span class="p">()</span>
        <span class="n">old_prefix</span> <span class="o">=</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_original_ipv4_prefix</span><span class="p">)</span>

        <span class="n">expansion</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">old_prefix</span><span class="p">)</span> <span class="ow">and</span> <span class="n">prefix</span> <span class="o">&lt;</span> <span class="n">old_prefix</span>

        <span class="k">if</span> <span class="n">expansion</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">services</span><span class="p">:</span>
                <span class="n">service_address</span> <span class="o">=</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_address</span><span class="p">(</span>
                    <span class="n">service</span><span class="o">.</span><span class="n">get_address</span><span class="p">()</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">service_address</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">old_prefix</span><span class="o">.</span><span class="n">network_address</span><span class="p">)</span>
                <span class="n">new_address</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">network_address</span> <span class="o">+</span> <span class="n">offset</span>

                <span class="n">service</span><span class="o">.</span><span class="n">set_address</span><span class="p">(</span>
                    <span class="n">IPv4Address</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">new_address</span><span class="p">)))</span>
                <span class="n">service</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>

<div class="viewcode-block" id="IX.update_ips"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.IX.update_ips">[docs]</a>    <span class="k">def</span> <span class="nf">update_ips</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called after an IX has one of its prefixes changed.</span>
<span class="sd">        Create new IP objects and change the address of its services</span>
<span class="sd">        for the new prefix. They are not changed if the new prefix contains the</span>
<span class="sd">        old one (expansion)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ipv4_network</span><span class="p">()</span>
        <span class="n">old_prefix</span> <span class="o">=</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_original_ipv4_prefix</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">prefix</span> <span class="o">!=</span> <span class="n">old_prefix</span><span class="p">:</span>
            <span class="c1">#  If it&#39;s an expansion, just create new addresses without changing</span>
            <span class="c1"># services address</span>
            <span class="n">expansion</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">old_prefix</span><span class="p">)</span> <span class="ow">and</span> <span class="n">prefix</span> <span class="o">&lt;</span> <span class="n">old_prefix</span>

            <span class="k">if</span> <span class="n">expansion</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_ipv4</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mlpa_v4_services</span> <span class="o">=</span> <span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">mlpav4_address__ix</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
                <span class="n">monitor_services</span> <span class="o">=</span> <span class="n">Monitorv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">monitor_address__ix</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

                <span class="n">old_addresses</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">IPv4Address</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">create_ipv4</span><span class="p">(</span><span class="n">old_addresses</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">map_new_address_ipv4</span><span class="p">(</span><span class="o">*</span><span class="n">mlpa_v4_services</span><span class="p">,</span> <span class="o">*</span><span class="n">monitor_services</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">old_address</span> <span class="ow">in</span> <span class="n">old_addresses</span><span class="p">:</span>
                    <span class="n">old_address</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ipv6_network</span><span class="p">()</span>
        <span class="n">old_prefix</span> <span class="o">=</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_original_ipv6_prefix</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">prefix</span> <span class="o">!=</span> <span class="n">old_prefix</span><span class="p">:</span>
            <span class="n">mlpa_v6_services</span> <span class="o">=</span> <span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">mlpav6_address__ix</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

            <span class="n">old_addresses</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">IPv6Address</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">map_new_address_ipv4</span><span class="p">(</span><span class="o">*</span><span class="n">mlpa_v6_services</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prefix_update</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="IX.get_all_customer_channels"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.IX.get_all_customer_channels">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_customer_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Function to return List of CIX&quot;&quot;&quot;</span>
        <span class="n">channel_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pix</span> <span class="ow">in</span> <span class="n">PIX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="n">pix</span><span class="o">.</span><span class="n">get_customer_channels</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
                <span class="n">channel_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">channel_list</span><span class="p">))</span></div>

<div class="viewcode-block" id="IX.get_all_cix"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.IX.get_all_cix">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_cix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Function to return List of CIX&quot;&quot;&quot;</span>
        <span class="n">channel_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_customer_channels</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">channel</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channel_list</span> <span class="k">if</span> <span class="n">channel</span><span class="o">.</span><span class="n">cix_type</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">get_cix_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cix_set_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_cix</span><span class="p">():</span>
            <span class="n">cix_set_info</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">cix_set_info</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">uuid</span>
            <span class="n">cix_set_info</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">asn</span><span class="o">.</span><span class="n">number</span>
            <span class="n">cix_set_info</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;is_lag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">is_lag</span>
            <span class="n">cix_set_info</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;is_mclag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">is_mclag</span>
            <span class="n">cix_set_info</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">channel_port</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="n">channel_port</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">pix</span>

            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">cix_set_info</span>

    <span class="k">def</span> <span class="nf">get_total_available_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">total_port</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">pix</span> <span class="ow">in</span> <span class="n">PIX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">switch_set</span> <span class="o">=</span> <span class="n">Switch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pix</span><span class="o">=</span><span class="n">pix</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">switch</span> <span class="ow">in</span> <span class="n">switch_set</span><span class="p">:</span>
                <span class="n">total_port</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">switch</span><span class="o">=</span><span class="n">switch</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;AVAILABLE&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">total_port</span></div>


<div class="viewcode-block" id="MACAddress"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.MACAddress">[docs]</a><span class="k">class</span> <span class="nc">MACAddress</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;MAC address related to a service.&quot;&quot;&quot;</span>
    <span class="n">uuid</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span>
                               <span class="n">validate_mac_address</span><span class="p">])</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;address&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MACAddress&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MACAddresses&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">MACAddressConverterToSystemPattern</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">mac_address_converter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_pk</span><span class="p">()</span></div>


<div class="viewcode-block" id="Organization"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.Organization">[docs]</a><span class="k">class</span> <span class="nc">Organization</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Organization representation.&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">shortname</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">cnpj</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">null</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_cnpj</span><span class="p">])</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_url_format</span><span class="p">])</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;shortname&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Organization&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Organizations&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;cnpj&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_cnpj</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">clean_cnpj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cnpj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cnpj</span><span class="o">.</span> \
            <span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PIX"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.PIX">[docs]</a><span class="k">class</span> <span class="nc">PIX</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;PIX site representation.&quot;&quot;&quot;</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                            <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MinLengthValidator</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                                        <span class="n">MaxLengthValidator</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span>
                                        <span class="n">validate_pix_code</span><span class="p">])</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;IX&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ix&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;PIX&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;PIXs&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;[IX </span><span class="si">%s</span><span class="s2">: PIX </span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ix</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;ix_id&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_customer_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ports_in_ix_pix</span> <span class="o">=</span> <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">switch__pix</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="n">CustomerChannel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">channel_port__in</span><span class="o">=</span><span class="n">ports_in_ix_pix</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;channel_port&#39;</span><span class="p">,</span>
                                                         <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">channels</span>

    <span class="k">def</span> <span class="nf">get_asns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_customer_channels</span><span class="p">()</span>

        <span class="n">asn_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">asn_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">channels</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;asn&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">mlpav4</span> <span class="o">=</span> <span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">customer_channel__in</span><span class="o">=</span><span class="n">channels</span><span class="p">)</span>
        <span class="n">asn_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mlpav4</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;asn&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>

        <span class="n">mlpav6</span> <span class="o">=</span> <span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">customer_channel__in</span><span class="o">=</span><span class="n">channels</span><span class="p">)</span>
        <span class="n">asn_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mlpav6</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;asn&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>

        <span class="n">bilateralpeer</span> <span class="o">=</span> <span class="n">BilateralPeer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">customer_channel__in</span><span class="o">=</span><span class="n">channels</span><span class="p">)</span>
        <span class="n">asn_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">bilateralpeer</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;asn&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>

        <span class="n">monitorv4</span> <span class="o">=</span> <span class="n">Monitorv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">customer_channel__in</span><span class="o">=</span><span class="n">channels</span><span class="p">)</span>
        <span class="n">asn_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">monitorv4</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;asn&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">asn_list</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_stats_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_customer_channels</span><span class="p">()</span>
        <span class="n">asn_amount</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">contact_map</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ix</span><span class="o">.</span><span class="n">contactsmap_set</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">asn_amount</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contact_map</span><span class="o">.</span><span class="n">asn</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>

        <span class="n">mlpav4</span> <span class="o">=</span> <span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">customer_channel__in</span><span class="o">=</span><span class="n">channels</span><span class="p">)</span>

        <span class="n">mlpav6</span> <span class="o">=</span> <span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">customer_channel__in</span><span class="o">=</span><span class="n">channels</span><span class="p">)</span>

        <span class="n">bilateralpeer</span> <span class="o">=</span> <span class="n">BilateralPeer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">customer_channel__in</span><span class="o">=</span><span class="n">channels</span><span class="p">)</span>

        <span class="n">monitorv4</span> <span class="o">=</span> <span class="n">Monitorv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">customer_channel__in</span><span class="o">=</span><span class="n">channels</span><span class="p">)</span>

        <span class="n">stats_infos</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;asn_amount&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">asn_amount</span><span class="p">)),</span>
                       <span class="s1">&#39;mlpav4_amount&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">mlpav4</span><span class="p">),</span>
                       <span class="s1">&#39;mlpav6_amount&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">mlpav6</span><span class="p">),</span>
                       <span class="s1">&#39;monitorv4&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">monitorv4</span><span class="p">),</span>
                       <span class="s1">&#39;bilateral_amount&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">bilateralpeer</span><span class="p">),</span>
                       <span class="s1">&#39;cix_amount&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">cix_type</span><span class="o">=</span><span class="mi">0</span><span class="p">))}</span>

        <span class="k">return</span> <span class="n">stats_infos</span>

    <span class="k">def</span> <span class="nf">get_switch_infos_by_pix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pix_switch_set</span> <span class="o">=</span> <span class="n">PIX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span><span class="o">.</span><span class="n">switch_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">switch_set</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">switch</span> <span class="ow">in</span> <span class="n">pix_switch_set</span><span class="p">:</span>
            <span class="n">switch_set</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">switch_set</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">switch</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="n">switch_set</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;management_ip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">switch</span><span class="o">.</span><span class="n">management_ip</span><span class="p">)</span>
            <span class="n">switch_set</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">switch</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="n">switch_set</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;available_ports&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;AVAILABLE&#39;</span><span class="p">,</span>
                                            <span class="n">switch_id</span><span class="o">=</span><span class="n">switch</span><span class="o">.</span><span class="n">uuid</span><span class="p">)))</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">switch_set</span>

    <span class="k">def</span> <span class="nf">has_dio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DIO</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pix</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="PhysicalInterface"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.PhysicalInterface">[docs]</a><span class="k">class</span> <span class="nc">PhysicalInterface</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Physical interface instance representation.&quot;&quot;&quot;</span>
    <span class="n">serial_number</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">CONNECTOR_TYPES</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;SFP&#39;</span><span class="p">,</span> <span class="s1">&#39;SFP&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;SFP+&#39;</span><span class="p">,</span> <span class="s1">&#39;SFP+&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;XFP&#39;</span><span class="p">,</span> <span class="s1">&#39;XFP&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;CFP&#39;</span><span class="p">,</span> <span class="s1">&#39;CFP&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;QSFP+&#39;</span><span class="p">,</span> <span class="s1">&#39;QSFP+&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;CPAK&#39;</span><span class="p">,</span> <span class="s1">&#39;CPAK&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;QSFP28&#39;</span><span class="p">,</span> <span class="s1">&#39;QSFP28&#39;</span><span class="p">),)</span>
    <span class="n">connector_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">CONNECTOR_TYPES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;SFP&#39;</span><span class="p">)</span>
    <span class="n">PORT_TYPES</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;SX&#39;</span><span class="p">,</span> <span class="s1">&#39;SX&#39;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;LX&#39;</span><span class="p">,</span> <span class="s1">&#39;LX&#39;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;ZX&#39;</span><span class="p">,</span> <span class="s1">&#39;ZX&#39;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;SR&#39;</span><span class="p">,</span> <span class="s1">&#39;SR&#39;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;LR&#39;</span><span class="p">,</span> <span class="s1">&#39;LR&#39;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;ER&#39;</span><span class="p">,</span> <span class="s1">&#39;ER&#39;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;ZR&#39;</span><span class="p">,</span> <span class="s1">&#39;ZR&#39;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;ER4&#39;</span><span class="p">,</span> <span class="s1">&#39;ER4&#39;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;LR4&#39;</span><span class="p">,</span> <span class="s1">&#39;LR4&#39;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;10LR&#39;</span><span class="p">,</span> <span class="s1">&#39;10LR&#39;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;SR4&#39;</span><span class="p">,</span> <span class="s1">&#39;SR4&#39;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;ERlite&#39;</span><span class="p">,</span> <span class="s1">&#39;ERlite&#39;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;UTP&#39;</span><span class="p">,</span> <span class="s1">&#39;UTP&#39;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;BD&#39;</span><span class="p">,</span> <span class="s1">&#39;BD&#39;</span><span class="p">),)</span>
    <span class="n">port_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">PORT_TYPES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;UTP&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;connector_type&#39;</span><span class="p">,</span> <span class="s1">&#39;port_type&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;PhysicalInterface&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;PhysicalInterfaces&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serial_number</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">connector_type</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">port_type</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_serial_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_type</span> <span class="o">==</span> <span class="s1">&#39;UTP&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_number</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;UTP serial number cannot be blank&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">validate_connector_type_port_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">PORT_TYPE_CONNECTOR_TYPE</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">connector_type</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s1">&#39;port_type not compatible with connector_type&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;serial_number&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;connector_type&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;port_type&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_serial_number</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_connector_type_port_type</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_free_physical_interfaces</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">PhysicalInterface</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
            <span class="n">uuid__in</span><span class="o">=</span><span class="n">Port</span><span class="o">.</span><span class="n">objects</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">physical_interface__isnull</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;physical_interface__uuid&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Port"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.Port">[docs]</a><span class="k">class</span> <span class="nc">Port</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">,</span> <span class="n">ReservableModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Network switch physical port representation.&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">CAPACITIES</span> <span class="o">=</span> <span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;100M&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;1G&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="s1">&#39;10G&#39;</span><span class="p">),</span>
                  <span class="p">(</span><span class="mi">40000</span><span class="p">,</span> <span class="s1">&#39;40G&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="s1">&#39;100G&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">400000</span><span class="p">,</span> <span class="s1">&#39;400G&#39;</span><span class="p">),</span> <span class="p">)</span>
    <span class="n">capacity</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">CAPACITIES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">configured_capacity</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">CAPACITIES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">CONNECTOR_TYPES</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;SFP&#39;</span><span class="p">,</span> <span class="s1">&#39;SFP&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;SFP+&#39;</span><span class="p">,</span> <span class="s1">&#39;SFP+&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;XFP&#39;</span><span class="p">,</span> <span class="s1">&#39;XFP&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;CFP&#39;</span><span class="p">,</span> <span class="s1">&#39;CFP&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;CPAK&#39;</span><span class="p">,</span> <span class="s1">&#39;CPAK&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;QSFP28&#39;</span><span class="p">,</span> <span class="s1">&#39;QSFP28&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;UTP&#39;</span><span class="p">,</span> <span class="s1">&#39;UTP&#39;</span><span class="p">),)</span>
    <span class="n">connector_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                      <span class="n">choices</span><span class="o">=</span><span class="n">CONNECTOR_TYPES</span><span class="p">,</span>
                                      <span class="n">default</span><span class="o">=</span><span class="s1">&#39;SFP&#39;</span><span class="p">)</span>
    <span class="n">STATUSES</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;AVAILABLE&#39;</span><span class="p">,</span> <span class="s1">&#39;Available&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;RESERVED_CUSTOMER&#39;</span><span class="p">,</span> <span class="s1">&#39;Reserved for customer&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;RESERVED_INFRA&#39;</span><span class="p">,</span> <span class="s1">&#39;Reserved for uplinks or dl&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;CUSTOMER&#39;</span><span class="p">,</span> <span class="s1">&#39;Allocated for customer&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;INFRASTRUCTURE&#39;</span><span class="p">,</span> <span class="s1">&#39;Uplink or downlink&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;UNAVAILABLE&#39;</span><span class="p">,</span> <span class="s1">&#39;unavailable&#39;</span><span class="p">),</span> <span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">STATUSES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;AVAILABLE&#39;</span><span class="p">)</span>
    <span class="n">physical_interface</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span>
        <span class="s1">&#39;PhysicalInterface&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;port_related&#39;</span><span class="p">)</span>
    <span class="n">switch</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Switch&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">switch_module</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;SwitchModule&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">route</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Route&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">channel_port</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="s1">&#39;ChannelPort&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;switch&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,)</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;switch&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,),)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Port&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Ports&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_connector_type_capacity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="ow">not</span> <span class="ow">in</span>
           <span class="n">PORT_CAPACITY_CONNECTOR_TYPE</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">connector_type</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s1">&#39;port_capacity not compatible with connector_type&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">validate_configured_capacity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configured_capacity</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Configured capacity must be the same or &#39;</span>
                                    <span class="s1">&#39;lower than capacity&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">validate_connector_type_physical_interface_connector_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">physical_interface</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">physical_interface</span><span class="o">.</span><span class="n">connector_type</span> <span class="ow">not</span> <span class="ow">in</span>
               <span class="n">PHYSICAL_INTERFACE_PORT_CONNECTOR_TYPE</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">connector_type</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s1">&#39;port_connector_type not compatible with &#39;</span>
                      <span class="s1">&#39;physical_interface connector_type&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">validate_status_channel_port</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_port</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;AVAILABLE&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Change Status if associated a Channel port.&#39;</span><span class="p">))</span>

            <span class="n">is_customer</span> <span class="o">=</span> <span class="n">CustomerChannel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">channel_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_port</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;RESERVED_CUSTOMER&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_customer</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s1">&#39;RESERVED_CUSTOMER only allowed if Channel port has a &#39;</span>
                      <span class="s1">&#39;CustomerChannel&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;CUSTOMER&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_customer</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s1">&#39;CUSTOMER only allowed if Channel port has a &#39;</span>
                      <span class="s1">&#39;CustomerChannel&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;RESERVED_INFRA&#39;</span> <span class="ow">and</span> <span class="n">is_customer</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_port</span><span class="o">.</span><span class="n">_customerchannel_cache</span><span class="o">.</span><span class="n">asn</span><span class="o">.</span><span class="n">number</span> <span class="o">!=</span>
                   <span class="mi">26162</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                        <span class="n">_</span><span class="p">(</span><span class="s1">&#39;RESERVED_INFRA not allowed if Channel port has a &#39;</span>
                          <span class="s1">&#39;CustomerChannel&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;INFRASTRUCTURE&#39;</span> <span class="ow">and</span> <span class="n">is_customer</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_port</span><span class="o">.</span><span class="n">_customerchannel_cache</span><span class="o">.</span><span class="n">asn</span><span class="o">.</span><span class="n">number</span> <span class="o">!=</span>
                   <span class="mi">26162</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                        <span class="n">_</span><span class="p">(</span><span class="s1">&#39;INFRASTRUCTURE not allowed if Channel port has a &#39;</span>
                          <span class="s1">&#39;CustomerChannel&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;AVAILABLE&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Change Channel port if Status is not &quot;Available&quot;.&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">getDioPorts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dioport_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;capacity&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_status_channel_port</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_connector_type_capacity</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_configured_capacity</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_connector_type_physical_interface_connector_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">route</span><span class="p">:</span>
            <span class="n">Route</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">route</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">management_ip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">switch_module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">capacity_translated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CAPACITIES</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">]</span></div>


<div class="viewcode-block" id="Route"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.Route">[docs]</a><span class="k">class</span> <span class="nc">Route</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Physical route representation.&quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Route&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Routes&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">switches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">port_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">port</span> <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_set</span><span class="o">.</span><span class="n">iterator</span><span class="p">()]</span>

        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">new_port</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">new_port</span><span class="o">.</span><span class="n">pk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">pk</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">port_list</span><span class="p">]:</span>
                <span class="n">port_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">port_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ix</span><span class="p">:</span>
                <span class="n">ix</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">pix</span><span class="o">.</span><span class="n">ix</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">port</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">pix</span><span class="o">.</span><span class="n">ix</span> <span class="o">!=</span> <span class="n">ix</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Route can&#39;t be in different IX.&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">port</span><span class="o">.</span><span class="n">switch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
                <span class="n">switches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">switch</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">switches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Only permitted 2 Switches per &quot;</span>
                                            <span class="s2">&quot;Route.&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="Service"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.Service">[docs]</a><span class="k">class</span> <span class="nc">Service</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Service representation.&quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Tag&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">inner</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MinValueValidator</span><span class="p">(</span><span class="n">MIN_TAG_NUMBER</span><span class="p">),</span>
                    <span class="n">MaxValueValidator</span><span class="p">(</span><span class="n">MAX_TAG_NUMBER</span><span class="p">)],</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">customer_channel</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;CustomerChannel&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">)</span>
    <span class="n">shortname</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">asn</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;ASN&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">)</span>
    <span class="n">mac_addresses</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="s1">&#39;MACAddress&#39;</span><span class="p">)</span>
    <span class="n">STATUSES</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;ALLOCATED&#39;</span><span class="p">,</span> <span class="s1">&#39;Allocated for customer but not in use&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;INTERNAL&#39;</span><span class="p">,</span> <span class="s1">&#39;Internal servers in production&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;PRODUCTION&#39;</span><span class="p">,</span> <span class="s1">&#39;Customer in production&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;QUARANTINE&#39;</span><span class="p">,</span> <span class="s1">&#39;Customer in test/quarantine&#39;</span><span class="p">),</span> <span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">STATUSES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;ALLOCATED&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Service&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Services&#39;</span><span class="p">)</span>
        <span class="c1"># Remember to put this line in derived classes</span>
        <span class="c1"># ordering = (&#39;asn&#39;, &#39;tag&#39;, &#39;inner&#39;,)</span>
        <span class="c1"># unique_together = ((&#39;asn&#39;, &#39;tag&#39;, &#39;inner&#39;),)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> [</span><span class="si">%s</span><span class="s2"> AS</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">asn</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">inner</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_objects_all</span><span class="p">():</span>
        <span class="n">objects_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">objects_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>
        <span class="n">objects_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>
        <span class="n">objects_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Monitorv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>
        <span class="n">objects_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">BilateralPeer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">objects_list</span>

    <span class="k">def</span> <span class="nf">get_service_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="k">def</span> <span class="nf">get_objects_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwarg</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">kwarg</span><span class="p">:</span> <span class="n">arg</span><span class="p">})))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">kwarg</span><span class="p">:</span> <span class="n">arg</span><span class="p">})))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Monitorv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">kwarg</span><span class="p">:</span> <span class="n">arg</span><span class="p">})))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">BilateralPeer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">kwarg</span><span class="p">:</span> <span class="n">arg</span><span class="p">})))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span>

    <span class="k">def</span> <span class="nf">validate_asn_ix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
           <span class="n">channel_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer_channel</span><span class="o">.</span><span class="n">channel_port</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ContactsMap</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">channel_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer_channel</span><span class="o">.</span><span class="n">channel_port</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span>
                        <span class="n">switch</span><span class="o">.</span><span class="n">pix</span><span class="o">.</span><span class="n">ix</span><span class="p">,</span> <span class="n">asn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asn</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;This ASN doesn&#39;t belong to the same &quot;</span>
                                        <span class="s2">&quot;IX from customer channel.&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Customer Channel associated MUST have in &quot;</span>
                                    <span class="s2">&quot;a least one port.&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">validate_mac</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">macs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">macs_mlpav4</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">mac</span> <span class="k">for</span> <span class="n">mac</span> <span class="ow">in</span> <span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">asn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asn</span><span class="p">,</span> <span class="n">customer_channel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer_channel</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span>
                <span class="s1">&#39;mac_addresses&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">mac</span><span class="p">])</span>
        <span class="n">macs_mlpav6</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">mac</span> <span class="k">for</span> <span class="n">mac</span> <span class="ow">in</span> <span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">asn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asn</span><span class="p">,</span> <span class="n">customer_channel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer_channel</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span>
                <span class="s1">&#39;mac_addresses&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">mac</span><span class="p">])</span>
        <span class="n">macs_bilateralpeer</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">mac</span> <span class="k">for</span> <span class="n">mac</span> <span class="ow">in</span> <span class="n">BilateralPeer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">asn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asn</span><span class="p">,</span> <span class="n">customer_channel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer_channel</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span>
                <span class="s1">&#39;mac_addresses&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">mac</span><span class="p">])</span>
        <span class="n">macs_monitorv4</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">mac</span> <span class="k">for</span> <span class="n">mac</span> <span class="ow">in</span> <span class="n">Monitorv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">asn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asn</span><span class="p">,</span> <span class="n">customer_channel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer_channel</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span>
                <span class="s1">&#39;mac_addresses&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">mac</span><span class="p">])</span>
        <span class="n">macs</span> <span class="o">=</span> <span class="n">macs</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
            <span class="n">macs_mlpav4</span><span class="p">,</span> <span class="n">macs_mlpav6</span><span class="p">,</span> <span class="n">macs_bilateralpeer</span><span class="p">,</span> <span class="n">macs_monitorv4</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">macs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Only 4 MACs by AS by Channel is allowed&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mac_addresses</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Only 2 MAC/Service is allowed&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">validate_cix_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer_channel</span><span class="o">.</span><span class="n">asn</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asn</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer_channel</span><span class="o">.</span><span class="n">cix_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># individual port</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Respective Customer Channel is a &quot;</span>
                                        <span class="s2">&quot;individual port and doesn&#39;t accept &quot;</span>
                                        <span class="s2">&quot;participants.&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer_channel</span><span class="o">.</span><span class="n">get_ports</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">get_master_pix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer_channel</span><span class="o">.</span><span class="n">get_master_port</span><span class="p">()</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">pix</span>

    <span class="k">def</span> <span class="nf">get_all_pix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span>
            <span class="p">[</span><span class="n">port</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">pix</span> <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer_channel</span><span class="o">.</span><span class="n">get_ports</span><span class="p">()])</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_asn_ix</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_mac</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_cix_type</span><span class="p">()</span></div>


<div class="viewcode-block" id="Switch"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.Switch">[docs]</a><span class="k">class</span> <span class="nc">Switch</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Network switch representation.&quot;&quot;&quot;</span>
    <span class="n">pix</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;PIX&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">)</span>
    <span class="n">management_ip</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">GenericIPAddressField</span><span class="p">(</span>
        <span class="s1">&#39;Management IP&#39;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;SwitchModel&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">)</span>
    <span class="n">is_pe</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">create_ports</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;pix&#39;</span><span class="p">,</span> <span class="s1">&#39;management_ip&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Switch&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Switches&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">management_ip</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_channel</span><span class="p">(</span><span class="n">channel_port</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">channel_port</span><span class="o">.</span><span class="n">corechannel</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">channel_port</span><span class="o">.</span><span class="n">customerchannel</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">channel_port</span><span class="o">.</span><span class="n">downlinkchannel</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">channel_port</span><span class="o">.</span><span class="n">translationchannel</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">channel_port</span><span class="o">.</span><span class="n">uplinkchannel</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_unavailable_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_set</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;AVAILABLE&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_managment_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">management_ip</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span><span class="p">(</span><span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_address</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">management_ip</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span>
           <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pix</span><span class="o">.</span><span class="n">ix</span><span class="o">.</span><span class="n">management_prefix</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> don&#39;t belong to network management IX: </span><span class="si">{}</span><span class="s2">&quot;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">management_ip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix</span><span class="o">.</span><span class="n">ix</span><span class="o">.</span><span class="n">management_prefix</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">pix</span> <span class="ow">in</span> <span class="n">PIX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pix</span><span class="o">.</span><span class="n">ix</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">switch</span> <span class="ow">in</span> <span class="n">Switch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pix</span><span class="o">=</span><span class="n">pix</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">switch</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">switch</span><span class="o">.</span><span class="n">management_ip</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">management_ip</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;This IP </span><span class="si">{}</span><span class="s2"> already exist&quot;</span>
                                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">management_ip</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">validate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">port_ranges</span> <span class="o">=</span> <span class="n">SwitchPortRange</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">switch_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">port_ranges</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;This model must be associated with &quot;</span>
                                    <span class="s2">&quot;at least one SwitchPortRange&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;pix_id&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_managment_ip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_model</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">ordered_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">descendent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">port_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_set</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">port_dict</span><span class="p">[</span><span class="n">port</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span>
        <span class="k">return</span> <span class="n">port_sorting</span><span class="p">(</span><span class="n">port_dict</span><span class="p">,</span> <span class="n">descendent</span><span class="p">)</span>

<div class="viewcode-block" id="Switch.create_additional_ports"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.Switch.create_additional_ports">[docs]</a>    <span class="k">def</span> <span class="nf">create_additional_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">last_ticket</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates aditional port(s) to switch, from the end of SwitchPortRange</span>
<span class="sd">        or from last Port name/number. Assuming all port range have same</span>
<span class="sd">        capacity, configured capacity and connector_type</span>

<span class="sd">        Args:</span>
<span class="sd">            quantity (int): quantity of ports to create</span>
<span class="sd">            last_ticket (int): ticket number about this requisition</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">SequenceMatcher</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">switchportrange_set</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">name_format</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ordered_ports</span><span class="p">()</span><span class="o">.</span><span class="n">popitem</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">find_longest_match</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">switchportrange_set</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">name_format</span><span class="p">),</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ordered_ports</span><span class="p">()</span><span class="o">.</span><span class="n">popitem</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">last_created_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ordered_ports</span><span class="p">()</span><span class="o">.</span><span class="n">popitem</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="n">match</span><span class="o">.</span><span class="n">size</span><span class="p">:])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">switchportrange_set</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">end</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_set</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
            <span class="n">last_port_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">switchportrange_set</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">last_created_port</span> <span class="o">&gt;=</span> <span class="n">last_port_number</span><span class="p">:</span>
                <span class="n">last_port_number</span> <span class="o">=</span> <span class="n">last_created_port</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_port_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_set</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">qty</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">quantity</span><span class="p">):</span>
            <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">switchportrange_set</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">name_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">last_port_number</span> <span class="o">+</span> <span class="n">qty</span><span class="p">),</span>
                <span class="n">capacity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">switchportrange_set</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">capacity</span><span class="p">,</span>
                <span class="n">configured_capacity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">switchportrange_set</span><span class="o">.</span><span class="n">first</span><span class="p">(</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">capacity</span><span class="p">,</span>
                <span class="n">connector_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">switchportrange_set</span><span class="o">.</span><span class="n">first</span><span class="p">(</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">connector_type</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;AVAILABLE&#39;</span><span class="p">,</span>
                <span class="n">switch</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">last_ticket</span><span class="o">=</span><span class="n">last_ticket</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SwitchModel"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.SwitchModel">[docs]</a><span class="k">class</span> <span class="nc">SwitchModel</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Network switch model representation.&quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">translation</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">vendor</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">VENDORS</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;SwitchModel&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;SwitchModels&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_model_vendor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">validate_switch_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_model_vendor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;translation&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SwitchPortRange"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.SwitchPortRange">[docs]</a><span class="k">class</span> <span class="nc">SwitchPortRange</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Switch model ports template representation.&quot;&quot;&quot;</span>
    <span class="n">CAPACITIES</span> <span class="o">=</span> <span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;100M&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;1G&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="s1">&#39;10G&#39;</span><span class="p">),</span>
                  <span class="p">(</span><span class="mi">40000</span><span class="p">,</span> <span class="s1">&#39;40G&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="s1">&#39;100G&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">400000</span><span class="p">,</span> <span class="s1">&#39;400G&#39;</span><span class="p">),</span> <span class="p">)</span>
    <span class="n">capacity</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">CAPACITIES</span><span class="p">)</span>
    <span class="n">CONNECTOR_TYPES</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;SFP&#39;</span><span class="p">,</span> <span class="s1">&#39;SFP&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;SFP+&#39;</span><span class="p">,</span> <span class="s1">&#39;SFP+&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;XFP&#39;</span><span class="p">,</span> <span class="s1">&#39;XFP&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;CFP&#39;</span><span class="p">,</span> <span class="s1">&#39;CFP&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;CPAK&#39;</span><span class="p">,</span> <span class="s1">&#39;CPAK&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;QSFP28&#39;</span><span class="p">,</span> <span class="s1">&#39;QSFP28&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;UTP&#39;</span><span class="p">,</span> <span class="s1">&#39;UTP&#39;</span><span class="p">),)</span>
    <span class="n">connector_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">CONNECTOR_TYPES</span><span class="p">)</span>
    <span class="n">name_format</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
                                   <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_name_format</span><span class="p">])</span>
    <span class="n">begin</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">()</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">()</span>
    <span class="n">switch_model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;SwitchModel&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;switch_model&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;SwitchPortRange&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;SwitchPortRanges&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_model</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">switch_model</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">switch_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="p">)</span>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="SwitchPortRange.get_number_of_ports"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.SwitchPortRange.get_number_of_ports">[docs]</a>    <span class="k">def</span> <span class="nf">get_number_of_ports</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arguments:</span>
<span class="sd">            model {SwitchModel} -- SwitchModel instance</span>

<span class="sd">        Returns:</span>
<span class="sd">            int -- quantity of ports in SwitchPortRange of specified model.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">list_port_ranges</span> <span class="o">=</span> <span class="n">SwitchPortRange</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">switch_model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
        <span class="n">number_of_ports</span> <span class="o">=</span> <span class="nb">map</span><span class="p">((</span><span class="k">lambda</span> <span class="nb">range</span><span class="p">:</span> <span class="nb">range</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="nb">range</span><span class="o">.</span><span class="n">begin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                              <span class="n">list_port_ranges</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">number_of_ports</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">validate_begin_le_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;begin field must be less or equal than &#39;</span>
                                    <span class="s1">&#39;end field&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">validate_range_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">SwitchPortRange</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">query_similars</span> <span class="o">=</span> <span class="n">SwitchPortRange</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">switch_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">switch_model</span><span class="p">,</span>
                <span class="n">name_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name_format</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">query_similars</span><span class="p">:</span>
                <span class="n">port_intervals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">begin</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                  <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">query_similars</span><span class="p">]</span>
                <span class="n">current_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">port_interval</span> <span class="ow">in</span> <span class="n">port_intervals</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">port_number</span> <span class="ow">in</span> <span class="n">current_range</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">port_number</span> <span class="ow">in</span> <span class="n">port_interval</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;This interval of range conflits with &quot;</span>
                                  <span class="s2">&quot;another existent&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;capacity&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;connector_type&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;name_format&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;begin&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;switch_model_id&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_begin_le_end</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_range_ports</span><span class="p">()</span></div>

<div class="viewcode-block" id="SwitchModule"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.SwitchModule">[docs]</a><span class="k">class</span> <span class="nc">SwitchModule</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Modular port circuit for switches &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">vendor</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">VENDORS</span><span class="p">)</span>
    <span class="n">create_ports</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">switch_port_range</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;SwitchPortRange&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">)</span>


    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;SwitchModule&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;SwitchModules&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;[module-</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">switch_port_range</span><span class="o">.</span><span class="n">begin</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">switch_port_range</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Tag"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.Tag">[docs]</a><span class="k">class</span> <span class="nc">Tag</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">,</span> <span class="n">ReservableModel</span><span class="p">):</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">IXAPIQuerySet</span><span class="o">.</span><span class="n">as_manager</span><span class="p">()</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MinValueValidator</span><span class="p">(</span><span class="n">MIN_TAG_NUMBER</span><span class="p">),</span>
                    <span class="n">MaxValueValidator</span><span class="p">(</span><span class="n">MAX_TAG_NUMBER</span><span class="p">)])</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;IX&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">)</span>
    <span class="n">tag_domain</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="s1">&#39;ChannelPort&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">STATUSES</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;AVAILABLE&#39;</span><span class="p">,</span> <span class="s1">&#39;available&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;RESERVED&#39;</span><span class="p">,</span> <span class="s1">&#39;reserved&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;PRODUCTION&#39;</span><span class="p">,</span> <span class="s1">&#39;production&#39;</span><span class="p">),)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">STATUSES</span><span class="p">,</span>
                              <span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                              <span class="n">default</span><span class="o">=</span><span class="s1">&#39;AVAILABLE&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="s1">&#39;ix&#39;</span><span class="p">,</span> <span class="s1">&#39;tag_domain&#39;</span><span class="p">),</span> <span class="p">)</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ix&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="p">)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Tag&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Tags&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_domain</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_status</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">new_status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">new_status</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Can&#39;t update to the same status&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">validate_ix_tag_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_domain</span><span class="p">:</span>
            <span class="n">ports</span> <span class="o">=</span> <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">channel_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_domain</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ports</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ix</span> <span class="o">!=</span> <span class="n">port</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">pix</span><span class="o">.</span><span class="n">ix</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;tag_domain.ix and ix must be &#39;</span>
                                                <span class="s1">&#39;the same&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">validate_tag_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mlpav4</span> <span class="o">=</span> <span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">mlpav6</span> <span class="o">=</span> <span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">monitorv4</span> <span class="o">=</span> <span class="n">Monitorv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">bilateralpeer</span> <span class="o">=</span> <span class="n">BilateralPeer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mlpav4</span> <span class="ow">or</span> <span class="n">mlpav6</span> <span class="ow">or</span> <span class="n">monitorv4</span> <span class="ow">or</span> <span class="n">bilateralpeer</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;AVAILABLE&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;An used Tag can not be AVAILABLE&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_services_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlpav4_set</span><span class="o">.</span><span class="n">first</span><span class="p">(),</span> <span class="s1">&#39;tag&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mlpav4_set</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">asn</span><span class="p">,</span> <span class="p">]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlpav6_set</span><span class="o">.</span><span class="n">first</span><span class="p">(),</span> <span class="s1">&#39;tag&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mlpav6_set</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">asn</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bilateralpeer_set</span><span class="o">.</span><span class="n">first</span><span class="p">(),</span> <span class="s1">&#39;tag&#39;</span><span class="p">):</span>
            <span class="n">contacts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">contacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bilateralpeer_set</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">asn</span><span class="p">)</span>
            <span class="n">contacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bilateralpeer_set</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">asn</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">contacts</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monitorv4_set</span><span class="o">.</span><span class="n">first</span><span class="p">(),</span> <span class="s1">&#39;tag&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">monitorv4_set</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">asn</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_services</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">services</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mlpav4</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;MLPAv4&quot;</span><span class="p">,</span> <span class="n">mlpav4</span><span class="p">)</span> <span class="k">for</span> <span class="n">mlpav4</span> <span class="ow">in</span> <span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="p">)]</span>
        <span class="n">mlpav6</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;MLPAv6&quot;</span><span class="p">,</span> <span class="n">mlpav6</span><span class="p">)</span> <span class="k">for</span> <span class="n">mlpav6</span> <span class="ow">in</span> <span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="p">)]</span>
        <span class="n">bilateralpeer</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;Bilateralpeer&quot;</span><span class="p">,</span> <span class="n">bilateral</span><span class="p">)</span> <span class="k">for</span> <span class="n">bilateral</span> <span class="ow">in</span>
                         <span class="n">BilateralPeer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="p">)]</span>
        <span class="n">monitorv4</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;Monitorv4&quot;</span><span class="p">,</span>  <span class="n">monitor</span><span class="p">)</span> <span class="k">for</span> <span class="n">monitor</span> <span class="ow">in</span>
                     <span class="n">Monitorv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="p">)]</span>
        <span class="n">services</span> <span class="o">=</span> <span class="n">services</span> <span class="o">+</span> <span class="n">mlpav4</span> <span class="o">+</span> <span class="n">mlpav6</span> <span class="o">+</span> <span class="n">bilateralpeer</span> <span class="o">+</span> <span class="n">monitorv4</span>
        <span class="k">return</span> <span class="n">services</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;ix_id&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_ix_tag_domain</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_tag_status</span><span class="p">()</span></div>


<div class="viewcode-block" id="CoreChannel"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.CoreChannel">[docs]</a><span class="k">class</span> <span class="nc">CoreChannel</span><span class="p">(</span><span class="n">Channel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Core port channel representation.&quot;&quot;&quot;</span>
    <span class="n">other_core_channel</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span>
        <span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;CoreChannel&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;CoreChannels&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CustomerChannel"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.CustomerChannel">[docs]</a><span class="k">class</span> <span class="nc">CustomerChannel</span><span class="p">(</span><span class="n">Channel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Customer port channel representation.&quot;&quot;&quot;</span>

    <span class="n">CIX_TYPES</span> <span class="o">=</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;individual port&#39;</span><span class="p">),</span>
                 <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;CIX type 1&#39;</span><span class="p">),</span>
                 <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;CIX type 2&#39;</span><span class="p">),</span>
                 <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;CIX type 3&#39;</span><span class="p">),</span> <span class="p">)</span>
    <span class="n">cix_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">CIX_TYPES</span><span class="p">,</span>
                                           <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MinValueValidator</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                                                       <span class="n">MaxValueValidator</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="n">asn</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;ASN&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;CustomerChannel&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;CustomerChannels&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lag</span> <span class="o">=</span> <span class="s1">&#39;L&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_lag</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> [</span><span class="si">%s%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_qinq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cix_type</span> <span class="o">==</span> <span class="mi">3</span>

    <span class="k">def</span> <span class="nf">get_stats_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">asn_amount</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">asn</span><span class="o">.</span><span class="n">number</span><span class="p">]</span>

        <span class="n">mlpav4</span> <span class="o">=</span> <span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">customer_channel</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">asn_amount</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mlpav4</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;asn&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>

        <span class="n">mlpav6</span> <span class="o">=</span> <span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">customer_channel</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">asn_amount</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mlpav6</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;asn&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>

        <span class="n">bilateralpeer</span> <span class="o">=</span> <span class="n">BilateralPeer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">customer_channel</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">asn_amount</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">bilateralpeer</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;asn&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>

        <span class="n">monitorv4</span> <span class="o">=</span> <span class="n">Monitorv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">customer_channel</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">asn_amount</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">monitorv4</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;asn&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>

        <span class="n">stats_infos</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;asn_amount&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">asn_amount</span><span class="p">)),</span>
                       <span class="s1">&#39;mlpav4_amount&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">mlpav4</span><span class="p">),</span>
                       <span class="s1">&#39;mlpav6_amount&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">mlpav6</span><span class="p">),</span>
                       <span class="s1">&#39;monitorv4&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">monitorv4</span><span class="p">),</span>
                       <span class="s1">&#39;bilateral_amount&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">bilateralpeer</span><span class="p">)}</span>

        <span class="k">return</span> <span class="n">stats_infos</span>

    <span class="k">def</span> <span class="nf">get_switch_infos_by_port</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">switch_set</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ports</span> <span class="o">=</span> <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">channel_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_port</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="n">switchs</span> <span class="o">=</span> <span class="n">Switch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">ports</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;switch&#39;</span><span class="p">,</span>
                                                                 <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">available_ports</span> <span class="o">=</span> <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">switch__in</span><span class="o">=</span><span class="n">switchs</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;AVAILABLE&#39;</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">switch</span> <span class="ow">in</span> <span class="n">switchs</span><span class="p">:</span>
            <span class="n">switch_set</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Here you need str (), because without str () it returns an instance and</span>
            <span class="c1"># gives error at the time of converting to a json</span>
            <span class="n">switch_set</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">switch</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="n">switch_set</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;management_ip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">switch</span><span class="o">.</span><span class="n">management_ip</span>
            <span class="c1"># Here you need str () because without str ()</span>
            <span class="c1"># returns UUID (&#39;o uuid&#39;)</span>
            <span class="n">switch_set</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                <span class="n">switch</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="n">switch_set</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;available_ports&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_ports</span><span class="p">)</span>

            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">switch_set</span>

    <span class="k">def</span> <span class="nf">validate_asn_in_ix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ix_by_asn</span> <span class="o">=</span> <span class="n">IX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">contactsmap__asn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asn</span><span class="p">)</span>
        <span class="n">ix_through_switch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_port</span><span class="o">.</span><span class="n">port_set</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span>\
            <span class="n">switch</span><span class="o">.</span><span class="n">pix</span><span class="o">.</span><span class="n">ix</span>
        <span class="k">if</span> <span class="n">ix_through_switch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ix_by_asn</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Asn: </span><span class="si">{0}</span><span class="s2"> is not registered in the IX: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">asn</span><span class="p">,</span> <span class="n">ix_through_switch</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_asn_in_ix</span><span class="p">()</span></div>


<div class="viewcode-block" id="DownlinkChannel"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.DownlinkChannel">[docs]</a><span class="k">class</span> <span class="nc">DownlinkChannel</span><span class="p">(</span><span class="n">Channel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Downlink port channel representation.&quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;DownlinkChannel&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;DownlinkChannels&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TranslationChannel"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.TranslationChannel">[docs]</a><span class="k">class</span> <span class="nc">TranslationChannel</span><span class="p">(</span><span class="n">Channel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Translation port channel representation.&quot;&quot;&quot;</span>
    <span class="n">customer_channel</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span>
        <span class="s1">&#39;CustomerChannel&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;TranslationChannel&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;TranslationChannels&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="UplinkChannel"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.UplinkChannel">[docs]</a><span class="k">class</span> <span class="nc">UplinkChannel</span><span class="p">(</span><span class="n">Channel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Uplink port channel representation.&quot;&quot;&quot;</span>
    <span class="n">downlink_channel</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span><span class="s1">&#39;DownlinkChannel&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;UplinkChannel&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;UplinkChannels&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BilateralPeer"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.BilateralPeer">[docs]</a><span class="k">class</span> <span class="nc">BilateralPeer</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bilateral peering service.&quot;&quot;&quot;</span>
    <span class="c1"># pe = models.CharField(max_length=15, blank=True)</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">IXAPIQuerySet</span><span class="o">.</span><span class="n">as_manager</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;asn&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="s1">&#39;inner&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;BilateralPeer&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;BilateralPeers&#39;</span><span class="p">)</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;asn&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="s1">&#39;inner&#39;</span><span class="p">),)</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BilateralPeer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">mac</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mac_addresses</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">services_by_mac</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">bilateral</span> <span class="ow">in</span> <span class="n">BilateralPeer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">mac_addresses__in</span><span class="o">=</span><span class="p">[</span><span class="n">mac</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">services_by_mac</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bilateral</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">services_by_mac</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">services_by_mac</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">ix</span> <span class="o">==</span> <span class="n">service</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">ix</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">!=</span> <span class="n">service</span><span class="o">.</span><span class="n">uuid</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                                <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Only a MAC/BilateralPeer/IX is allowed&#39;</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">service</span><span class="o">.</span><span class="n">asn</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asn</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                                <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MAC address must be unique for ASN in a &#39;</span>
                                  <span class="s1">&#39;Service&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="MLPAv4"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.MLPAv4">[docs]</a><span class="k">class</span> <span class="nc">MLPAv4</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;IPv4 Multilateral Peering Agreement service.&quot;&quot;&quot;</span>
    <span class="n">mlpav4_address</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span><span class="s1">&#39;IPv4Address&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">)</span>
    <span class="n">prefix_limit</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">IXAPIQuerySet</span><span class="o">.</span><span class="n">as_manager</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;asn&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="s1">&#39;inner&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MLPAv4&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MLPAsv4&#39;</span><span class="p">)</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;asn&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="s1">&#39;inner&#39;</span><span class="p">),)</span>

    <span class="k">def</span> <span class="nf">get_address</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlpav4_address</span>

    <span class="k">def</span> <span class="nf">set_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlpav4_address</span> <span class="o">=</span> <span class="n">address</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MLPAv4</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">mac</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mac_addresses</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">services_by_mac</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">mlpav4</span> <span class="ow">in</span> <span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">mac_addresses__in</span><span class="o">=</span><span class="p">[</span><span class="n">mac</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">services_by_mac</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mlpav4</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">services_by_mac</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">services_by_mac</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlpav4_address</span><span class="o">.</span><span class="n">ix</span> <span class="o">==</span> <span class="n">service</span><span class="o">.</span><span class="n">mlpav4_address</span><span class="o">.</span><span class="n">ix</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">!=</span> <span class="n">service</span><span class="o">.</span><span class="n">uuid</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                                <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Only a MAC/MLPAv4/IX is allowed&#39;</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">service</span><span class="o">.</span><span class="n">asn</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asn</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                                <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MAC address must be unique for ASN in a &#39;</span>
                                  <span class="s1">&#39;Service&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="MLPAv6"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.MLPAv6">[docs]</a><span class="k">class</span> <span class="nc">MLPAv6</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;IPv6 Multilateral Peering Agreement service.&quot;&quot;&quot;</span>
    <span class="n">mlpav6_address</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span><span class="s1">&#39;IPv6Address&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">)</span>
    <span class="n">prefix_limit</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">IXAPIQuerySet</span><span class="o">.</span><span class="n">as_manager</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;asn&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="s1">&#39;inner&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MLPAv6&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MLPAsv6&#39;</span><span class="p">)</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;asn&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="s1">&#39;inner&#39;</span><span class="p">),)</span>

    <span class="k">def</span> <span class="nf">get_address</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlpav6_address</span>

    <span class="k">def</span> <span class="nf">set_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlpav6_address</span> <span class="o">=</span> <span class="n">address</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MLPAv6</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">mac</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mac_addresses</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">services_by_mac</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">mlpav6</span> <span class="ow">in</span> <span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">mac_addresses__in</span><span class="o">=</span><span class="p">[</span><span class="n">mac</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">services_by_mac</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mlpav6</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">services_by_mac</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">services_by_mac</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlpav6_address</span><span class="o">.</span><span class="n">ix</span> <span class="o">==</span> <span class="n">service</span><span class="o">.</span><span class="n">mlpav6_address</span><span class="o">.</span><span class="n">ix</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">!=</span> <span class="n">service</span><span class="o">.</span><span class="n">uuid</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                                <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Only a MAC/MLPAv6/IX is allowed&#39;</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">service</span><span class="o">.</span><span class="n">asn</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asn</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                                <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MAC address must be unique for ASN in a &#39;</span>
                                  <span class="s1">&#39;Service&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="Monitorv4"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.Monitorv4">[docs]</a><span class="k">class</span> <span class="nc">Monitorv4</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Channel availability monitor service.&quot;&quot;&quot;</span>
    <span class="n">monitor_address</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span><span class="s1">&#39;IPv4Address&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">)</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">IXAPIQuerySet</span><span class="o">.</span><span class="n">as_manager</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;asn&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="s1">&#39;inner&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Monitorv4&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Monitorsv4&#39;</span><span class="p">)</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;asn&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="s1">&#39;inner&#39;</span><span class="p">),)</span>

    <span class="k">def</span> <span class="nf">get_address</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_address</span>

    <span class="k">def</span> <span class="nf">set_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_address</span> <span class="o">=</span> <span class="n">address</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Monitorv4</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">mac</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mac_addresses</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">services_by_mac</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">monitor</span> <span class="ow">in</span> <span class="n">Monitorv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">mac_addresses__in</span><span class="o">=</span><span class="p">[</span><span class="n">mac</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">services_by_mac</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">monitor</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">services_by_mac</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">services_by_mac</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_address</span><span class="o">.</span><span class="n">ix</span> <span class="o">==</span> <span class="n">service</span><span class="o">.</span><span class="n">monitor_address</span><span class="o">.</span><span class="n">ix</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">!=</span> <span class="n">service</span><span class="o">.</span><span class="n">uuid</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                                <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Only a MAC/Monitor/IX is allowed&#39;</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">service</span><span class="o">.</span><span class="n">asn</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asn</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                                <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MAC address must be unique for ASN in a &#39;</span>
                                  <span class="s1">&#39;Service&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="Phone"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.Phone">[docs]</a><span class="k">class</span> <span class="nc">Phone</span><span class="p">(</span><span class="n">HistoricalTimeStampedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Phone representation &quot;&quot;&quot;</span>
    <span class="n">number</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                              <span class="n">null</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">blank</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">CATEGORIES</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;Landline&#39;</span><span class="p">,</span> <span class="s2">&quot;Landline&quot;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;Mobile&#39;</span><span class="p">,</span> <span class="s2">&quot;Mobile&quot;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;Business&#39;</span><span class="p">,</span> <span class="s2">&quot;Business&quot;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;INOC-DBA&#39;</span><span class="p">,</span> <span class="s2">&quot;INOC-DBA&quot;</span><span class="p">),)</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">CATEGORIES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;Landline&#39;</span><span class="p">)</span>
    <span class="n">contact</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Contact&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;contact&#39;</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">,)</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Phone&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Phones&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;[Contact: </span><span class="si">%s</span><span class="s2"> : Phone </span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contact</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;number&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_update_fields</span><span class="p">(</span><span class="s1">&#39;contact_id&#39;</span><span class="p">)</span></div>


<span class="c1">###############################################################################</span>
<span class="c1">###############################################################################</span>
<span class="c1">########################## BUSINESS RULES FUNCTIONS ###########################</span>
<span class="c1">###############################################################################</span>
<span class="c1">###############################################################################</span>


<span class="k">def</span> <span class="nf">create_all_ips</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
    <span class="c1"># Get the first subnetwork /24 in the ipv4_prefix field</span>
    <span class="n">first_sub_network_v4</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">ipv4_prefix</span><span class="p">)</span><span class="o">.</span>
                                <span class="n">subnets</span><span class="p">(</span><span class="n">new_prefix</span><span class="o">=</span><span class="mi">24</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ip_v6</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">ipv4_prefix</span><span class="p">)</span><span class="o">.</span><span class="n">hosts</span><span class="p">():</span>
        <span class="c1"># For each IPv4 in ipv4_prefix create the respective IP.</span>
        <span class="n">IPv4Address</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">ix</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span> <span class="n">last_ticket</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">last_ticket</span><span class="p">,</span>
            <span class="n">modified_by</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">modified_by</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ip</span><span class="p">),</span> <span class="n">in_lg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># For each IPv4 create a respective IPv6 with the same final visual</span>
        <span class="c1"># number. (IPv4 v.w.y.x IPv6 final ::0.x)</span>
        <span class="n">ip_v6</span> <span class="o">=</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">ipv6_prefix</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> \
            <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>

        <span class="c1"># If IPv4 is in the first block /24 create IPv6</span>
        <span class="c1"># with final ::y.x IPv4 v.w.y.x</span>
        <span class="k">if</span> <span class="n">ip</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">first_sub_network_v4</span><span class="p">:</span>
            <span class="n">ip_v6</span> <span class="o">+=</span> <span class="mi">65536</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>

        <span class="n">IPv6Address</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">ix</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
            <span class="n">last_ticket</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">last_ticket</span><span class="p">,</span>
            <span class="n">modified_by</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">modified_by</span><span class="p">,</span>
            <span class="n">address</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ip_v6</span><span class="p">),</span>
            <span class="n">in_lg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<div class="viewcode-block" id="create_tag_by_channel_port"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.create_tag_by_channel_port">[docs]</a><span class="k">def</span> <span class="nf">create_tag_by_channel_port</span><span class="p">(</span><span class="n">channel_port</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>

<span class="sd">    Function to create tags from a given channel_port</span>

<span class="sd">    Args:</span>
<span class="sd">        channel_port: ChannelPort instance</span>
<span class="sd">        initial: Bool -&gt; True = Initial approach, create from tag 0</span>
<span class="sd">        False = Starts from the last tag in the database</span>
<span class="sd">        limit: Integer -&gt; Quantity of instances to create</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">channel_port</span><span class="o">=</span><span class="n">channel_port</span><span class="p">):</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">channel_port</span><span class="o">=</span><span class="n">channel_port</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">pix</span><span class="o">.</span><span class="n">ix</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;For create all Tags, ChannelPort MUST have &#39;</span>
                                <span class="s1">&#39;in a least one port.&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">initial</span><span class="p">:</span>
        <span class="n">tag_numbers_to_create_start</span> <span class="o">=</span> <span class="n">MIN_TAG_NUMBER</span>
        <span class="n">tag_numbers_to_create_limit</span> <span class="o">=</span> <span class="n">MIN_TAG_NUMBER</span> <span class="o">+</span> <span class="n">limit</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">last_tag</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tag_domain</span><span class="o">=</span><span class="n">channel_port</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
        <span class="n">tag_numbers_to_create_start</span> <span class="o">=</span> <span class="n">last_tag</span><span class="o">.</span><span class="n">tag</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">tag_numbers_to_create_limit</span> <span class="o">=</span> <span class="n">tag_numbers_to_create_start</span> <span class="o">+</span> <span class="n">limit</span>

    <span class="k">for</span> <span class="n">n_tag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tag_numbers_to_create_start</span><span class="p">,</span>
                       <span class="n">tag_numbers_to_create_limit</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n_tag</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">n_tag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;RESERVED&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_default</span><span class="p">()</span>
        <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">tag</span><span class="o">=</span><span class="n">n_tag</span><span class="p">,</span> <span class="n">last_ticket</span><span class="o">=</span><span class="n">channel_port</span><span class="o">.</span><span class="n">last_ticket</span><span class="p">,</span>
            <span class="n">modified_by</span><span class="o">=</span><span class="n">channel_port</span><span class="o">.</span><span class="n">modified_by</span><span class="p">,</span> <span class="n">ix</span><span class="o">=</span><span class="n">ix</span><span class="p">,</span>
            <span class="n">tag_domain</span><span class="o">=</span><span class="n">channel_port</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">create_all_tags_by_ix</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">n_tag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n_tag</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">n_tag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;RESERVED&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_default</span><span class="p">()</span>
        <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">tag</span><span class="o">=</span><span class="n">n_tag</span><span class="p">,</span> <span class="n">last_ticket</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">last_ticket</span><span class="p">,</span>
            <span class="n">modified_by</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">modified_by</span><span class="p">,</span> <span class="n">ix</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_all_ports</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">SwitchModule</span><span class="p">):</span>
        <span class="n">list_port_ranges</span> <span class="o">=</span> <span class="p">[</span><span class="n">instance</span><span class="o">.</span><span class="n">switch_port_range</span><span class="p">]</span>
        <span class="n">switch</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">instance</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">list_port_ranges</span> <span class="o">=</span> <span class="n">SwitchPortRange</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">switch_model</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="n">switch</span> <span class="o">=</span> <span class="n">instance</span>
        <span class="n">module</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">ranges</span> <span class="ow">in</span> <span class="n">list_port_ranges</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ranges</span><span class="o">.</span><span class="n">begin</span><span class="p">,</span> <span class="n">ranges</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">ranges</span><span class="o">.</span><span class="n">name_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                <span class="n">capacity</span><span class="o">=</span><span class="n">ranges</span><span class="o">.</span><span class="n">capacity</span><span class="p">,</span>
                <span class="n">configured_capacity</span><span class="o">=</span><span class="n">ranges</span><span class="o">.</span><span class="n">capacity</span><span class="p">,</span>
                <span class="n">connector_type</span><span class="o">=</span><span class="n">ranges</span><span class="o">.</span><span class="n">connector_type</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;AVAILABLE&#39;</span><span class="p">,</span>
                <span class="n">switch</span><span class="o">=</span><span class="n">switch</span><span class="p">,</span>
                <span class="n">switch_module</span><span class="o">=</span><span class="n">module</span><span class="p">,</span>
                <span class="n">modified_by</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">modified_by</span><span class="p">,</span>
                <span class="n">last_ticket</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">last_ticket</span><span class="p">)</span>
            <span class="n">port</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">delete_orphan_organization</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">organization</span><span class="o">.</span><span class="n">contactsmap_set</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">Organization</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">organization</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">delete_orphan_asn</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">asn</span><span class="o">.</span><span class="n">contactsmap_set</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ASN</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">asn</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">delete_orphan_contactsmap</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>

    <span class="n">ix</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">asn</span><span class="o">.</span><span class="n">contactsmap_set</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">ix</span><span class="o">.</span><span class="n">pk</span>
    <span class="n">services</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">services</span> <span class="o">=</span> <span class="n">services</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">asn</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">asn</span><span class="p">))</span>
    <span class="n">services</span> <span class="o">=</span> <span class="n">services</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">asn</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">asn</span><span class="p">))</span>
    <span class="n">services</span> <span class="o">=</span> <span class="n">services</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">BilateralPeer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">asn</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">asn</span><span class="p">))</span>
    <span class="n">services</span> <span class="o">=</span> <span class="n">services</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">Monitorv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">asn</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">asn</span><span class="p">))</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">CustomerChannel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">asn</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">asn</span><span class="p">))</span>

    <span class="n">ports</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">services</span><span class="p">:</span>
        <span class="n">ports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">channel_port</span><span class="o">=</span><span class="n">service</span><span class="o">.</span><span class="n">customer_channel</span><span class="o">.</span><span class="n">channel_port</span><span class="p">,</span>
            <span class="n">switch__pix__ix__pk</span><span class="o">=</span><span class="n">ix</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
        <span class="n">ports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Port</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">channel_port</span><span class="o">=</span><span class="n">channel</span><span class="o">.</span><span class="n">channel_port</span><span class="p">,</span>
            <span class="n">switch__pix__ix__pk</span><span class="o">=</span><span class="n">ix</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ports</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="n">ContactsMap</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">asn</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">asn</span><span class="p">,</span> <span class="n">ix__pk</span><span class="o">=</span><span class="n">ix</span><span class="p">):</span>
            <span class="n">contact</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

<span class="c1"># After a object is save, for some models it&#39;s necessary</span>
<span class="c1"># create others objects, this could be done by using a</span>
<span class="c1"># post_save decorator that listen some model.</span>


<span class="c1"># This post_save for the IX model, call a method for</span>
<span class="c1"># create all ips (v4 and v6) following some rules.</span>
<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_save</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">IX</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_ips</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">create_ips</span><span class="p">:</span>
            <span class="n">create_all_ips</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>


<span class="c1"># This post_save for the IX model, call a method for</span>
<span class="c1"># update ips following some rules.</span>
<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_save</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">IX</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">update_ips</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">update_fields</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">and</span> <span class="n">instance</span><span class="o">.</span><span class="n">prefix_update</span><span class="p">:</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">update_ips</span><span class="p">()</span>


<span class="c1"># This post_save for the ChannelPort, call a method for</span>
<span class="c1"># create all tags possible (0 - 4095).</span>
<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_save</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">ChannelPort</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_tags_channel_port</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">create_tags</span> <span class="ow">and</span> <span class="n">instance</span><span class="o">.</span><span class="n">tags_type</span> <span class="o">==</span> <span class="s1">&#39;Direct-Bundle-Ether&#39;</span><span class="p">:</span>
        <span class="n">create_tag_by_channel_port</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span>
                                   <span class="kc">True</span><span class="p">,</span>
                                   <span class="n">MAX_TAG_NUMBER</span><span class="o">-</span><span class="n">MIN_TAG_NUMBER</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>


<span class="c1"># This post_save for the IX model, call a method for</span>
<span class="c1"># create all tags possible (0 - 4095).</span>
<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_save</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">IX</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_tags_ix</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">create_tags</span> <span class="ow">and</span> <span class="n">instance</span><span class="o">.</span><span class="n">tags_policy</span> <span class="o">==</span> <span class="s1">&#39;ix_managed&#39;</span><span class="p">:</span>
            <span class="n">create_all_tags_by_ix</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span>
                                  <span class="n">MAX_TAG_NUMBER</span><span class="o">-</span><span class="n">MIN_TAG_NUMBER</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>


<span class="c1"># This post_save for the Switch model, call a method for</span>
<span class="c1"># create all ports possible using SwitchModels and</span>
<span class="c1"># respectives SwitchPortRanges.</span>
<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_save</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">Switch</span><span class="p">)</span>
<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_save</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">SwitchModule</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_ports</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">create_ports</span><span class="p">:</span>
            <span class="n">create_all_ports</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>


<span class="c1"># This post_delete for ContactsMap, calls a method to</span>
<span class="c1"># delete his Organization in case that Organization</span>
<span class="c1"># hasn&#39;t any other ContacsMap</span>
<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_delete</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">ContactsMap</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">delete_contactsmap_related_models</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">delete_orphan_organization</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
    <span class="n">delete_orphan_asn</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>


<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_delete</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">CustomerChannel</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">delete_customerchannel_related_models</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">delete_orphan_contactsmap</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>


<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_delete</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">MLPAv4</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">delete_mlpav4_related_models</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">delete_orphan_contactsmap</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>


<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_delete</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">MLPAv6</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">delete_mlpav6_related_models</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">delete_orphan_contactsmap</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>


<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_delete</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">Monitorv4</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">delete_monitor_related_models</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">delete_orphan_contactsmap</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>


<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_delete</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">BilateralPeer</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">delete_bilatealpeer_related_models</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">delete_orphan_contactsmap</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>


<span class="c1">###############################################################################</span>
<span class="c1">###############################################################################</span>
<span class="c1">############################# UTILITY FUNCTIONS ###############################</span>
<span class="c1">###############################################################################</span>
<span class="c1">###############################################################################</span>


<div class="viewcode-block" id="get_used_ipv4_by_ix"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.get_used_ipv4_by_ix">[docs]</a><span class="k">def</span> <span class="nf">get_used_ipv4_by_ix</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; gets the used IPv4Address</span>

<span class="sd">    Args:</span>
<span class="sd">        ix: kwarg -&gt; the owner IX</span>

<span class="sd">    Returns:</span>
<span class="sd">        Queryset&lt;IPv4Address&gt;: Queryset conataining used v4 addresses</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ix&#39;</span><span class="p">)</span>
    <span class="n">used_v4_addresses</span> <span class="o">=</span> <span class="n">IPv4Address</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">Q</span><span class="p">(</span><span class="n">address__in</span><span class="o">=</span><span class="n">MLPAv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;mlpav4_address&#39;</span><span class="p">,</span>
                                                       <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="o">|</span>
        <span class="n">Q</span><span class="p">(</span><span class="n">address__in</span><span class="o">=</span><span class="n">Monitorv4</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;monitor_address&#39;</span><span class="p">,</span>
                                                          <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span>
        <span class="n">ix</span><span class="o">=</span><span class="n">ix</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">used_v4_addresses</span></div>


<div class="viewcode-block" id="get_used_ipv6_by_ix"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.get_used_ipv6_by_ix">[docs]</a><span class="k">def</span> <span class="nf">get_used_ipv6_by_ix</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; gets the used IPv6Address</span>

<span class="sd">    Args:</span>
<span class="sd">        ix: kwarg -&gt; the owner IX</span>

<span class="sd">    Returns:</span>
<span class="sd">        Queryset&lt;IPv6Address&gt;: Queryset conataining used v6 addresses</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ix&#39;</span><span class="p">)</span>
    <span class="n">used_v6_addresses</span> <span class="o">=</span> <span class="n">IPv6Address</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">Q</span><span class="p">(</span><span class="n">address__in</span><span class="o">=</span><span class="n">MLPAv6</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;mlpav6_address&#39;</span><span class="p">,</span>
                                                       <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span>
        <span class="n">ix</span><span class="o">=</span><span class="n">ix</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">used_v6_addresses</span></div>


<div class="viewcode-block" id="get_free_ipv4_by_ix"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.get_free_ipv4_by_ix">[docs]</a><span class="k">def</span> <span class="nf">get_free_ipv4_by_ix</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; gets the free IPv4Address</span>

<span class="sd">    Args:</span>
<span class="sd">        ix: kwarg -&gt; the owner IX</span>

<span class="sd">    Returns:</span>
<span class="sd">        Queryset&lt;IPv4Address&gt;: Queryset conataining free v4 addresses</span>

<span class="sd">    This funciton is dependent of the following functions:</span>
<span class="sd">        get_used_ipv4_by_ix</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ix&#39;</span><span class="p">)</span>
    <span class="n">used_v4_addresses</span> <span class="o">=</span> <span class="n">get_used_ipv4_by_ix</span><span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="n">ix</span><span class="p">)</span>
    <span class="n">V4_QUERY</span> <span class="o">=</span> <span class="n">IPv4Address</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="n">ix</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
        <span class="n">pk__in</span><span class="o">=</span><span class="n">used_v4_addresses</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">V4_QUERY</span></div>


<div class="viewcode-block" id="get_free_ipv6_by_ix"><a class="viewcode-back" href="../../../docstring.html#ixbr_api.core.models.get_free_ipv6_by_ix">[docs]</a><span class="k">def</span> <span class="nf">get_free_ipv6_by_ix</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; gets the free IPv6Address</span>

<span class="sd">    Args:</span>
<span class="sd">        ix: kwarg -&gt; the owner IX</span>

<span class="sd">    Returns:</span>
<span class="sd">        Queryset&lt;IPv6Address&gt;: Queryset conataining free v6 addresses</span>

<span class="sd">    This funciton is dependent of the following functions:</span>
<span class="sd">        get_used_ipv6_by_ix</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ix&#39;</span><span class="p">)</span>
    <span class="n">used_v6_addresses</span> <span class="o">=</span> <span class="n">get_used_ipv6_by_ix</span><span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="n">ix</span><span class="p">)</span>
    <span class="n">V6_QUERY</span> <span class="o">=</span> <span class="n">IPv6Address</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="n">ix</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
        <span class="n">pk__in</span><span class="o">=</span><span class="n">used_v6_addresses</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">V6_QUERY</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">IX.br API 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, NIC.br.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.1.
    </div>
  </body>
</html>